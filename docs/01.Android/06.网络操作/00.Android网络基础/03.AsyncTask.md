---
title: AsyncTask
date: 2021-08-07 18:23:12
permalink: /pages/33ab58/
categories:
  - Android
  - ç½‘ç»œæ“ä½œ
  - Androidç½‘ç»œåŸºç¡€
tags:
  - 
---

## 1. ç›¸å…³æ¦‚å¿µ

### 1.1 åŒæ­¥ä¸å¼‚æ­¥çš„æ¦‚å¿µ

**åŒæ­¥**ï¼šå½“æˆ‘ä»¬æ‰§è¡ŒæŸä¸ªåŠŸèƒ½æ—¶ï¼Œåœ¨æ²¡æœ‰å¾—åˆ°ç»“æœä¹‹å‰ï¼Œè¿™ä¸ªè°ƒç”¨å°±ä¸èƒ½è¿”å›,ä¸€ç›´å¤„äºç­‰å¾…é˜»å¡çŠ¶æ€ã€‚

**å¼‚æ­¥**ï¼šå’ŒåŒæ­¥åˆ™æ˜¯ç›¸å¯¹çš„ï¼Œå½“æˆ‘ä»¬æ‰§è¡ŒæŸä¸ªåŠŸèƒ½åï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦ç«‹å³å¾—åˆ°ç»“æœï¼Œæˆ‘ä»¬é¢å¯ä»¥æ­£å¸¸åœ° åšå…¶ä»–æ“ä½œï¼Œ**è¿™ä¸ªåŠŸèƒ½å¯ä»¥åœ¨å®Œæˆåé€šçŸ¥æˆ–è€…å›è°ƒæ¥å‘Šè¯‰æˆ‘ä»¬**ï¼›è¿˜æ˜¯ä¸Šé¢é‚£ä¸ªåå°ä¸‹è½½çš„ä¾‹å­ï¼Œåå°ä¸‹è½½ï¼Œ æˆ‘ä»¬æ‰§è¡Œä¸‹è½½åŠŸèƒ½åï¼Œæˆ‘ä»¬å°±æ— éœ€å»å…³å¿ƒå®ƒçš„ä¸‹è½½è¿‡ç¨‹ï¼Œå½“ä¸‹è½½å®Œæ¯•åé€šçŸ¥æˆ‘ä»¬å°±å¯ä»¥äº†

### 1.2 ä½œç”¨

1. **å®ç°å¤šçº¿ç¨‹**ã€‚åœ¨å·¥ä½œçº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œå¦‚ è€—æ—¶ä»»åŠ¡
2. å¼‚æ­¥é€šä¿¡ã€æ¶ˆæ¯ä¼ é€’ï¼Œ**å®ç°å·¥ä½œçº¿ç¨‹ & ä¸»çº¿ç¨‹ï¼ˆ`UI`çº¿ç¨‹ï¼‰ä¹‹é—´çš„é€šä¿¡**ã€‚å³ï¼šå°†å·¥ä½œçº¿ç¨‹çš„æ‰§è¡Œç»“æœä¼ é€’ç»™ä¸»çº¿ç¨‹ï¼Œä»è€Œåœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œç›¸å…³çš„`UI`æ“ä½œ

#### ä¼˜ç‚¹

- **æ–¹ä¾¿å®ç°å¼‚æ­¥é€šä¿¡**ã€‚ä¸éœ€ä½¿ç”¨ â€œä»»åŠ¡çº¿ç¨‹ï¼ˆå¦‚ç»§æ‰¿`Thread`ç±»ï¼‰ + `Handler`â€çš„å¤æ‚ç»„åˆ
- **èŠ‚çœèµ„æº**ã€‚é‡‡ç”¨çº¿ç¨‹æ± çš„ç¼“å­˜çº¿ç¨‹ + å¤ç”¨çº¿ç¨‹ï¼Œé¿å…äº†é¢‘ç¹åˆ›å»º & é”€æ¯çº¿ç¨‹æ‰€å¸¦æ¥çš„ç³»ç»Ÿèµ„æºå¼€é”€

<br>

### 1.3 Androidä¸ºä»€ä¹ˆè¦å¼•å…¥å¼‚æ­¥ä»»åŠ¡

### Main Thread å’Œ Worker Thread
åœ¨Androidå½“ä¸­ï¼Œé€šå¸¸å°†çº¿ç¨‹åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§å«åšMain Threadï¼Œé™¤äº†Main Threadä¹‹å¤–çš„çº¿ç¨‹éƒ½å¯ç§°ä¸ºWorker Threadã€‚Androidç¨‹åºåˆšå¯åŠ¨æ—¶ï¼Œä¼šåŒæ—¶å¯åŠ¨ä¸€ä¸ªå¯¹åº”çš„ä¸»çº¿ç¨‹(Main Thread)ï¼Œè¿™ä¸ªä¸»çº¿ç¨‹ä¸»è¦è´Ÿè´£å¤„ç† ä¸UIç›¸å…³çš„äº‹ä»¶ï¼æœ‰æ—¶æˆ‘ä»¬ä¹ŸæŠŠä»–ç§°ä½œUIçº¿ç¨‹ï¼

å½“ä¸€ä¸ªåº”ç”¨ç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼ŒAndroidæ“ä½œç³»ç»Ÿå°±ä¼šç»™è¯¥åº”ç”¨ç¨‹åºå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹å°±æ˜¯æˆ‘ä»¬çš„Main Threadï¼Œè¿™ä¸ªçº¿ç¨‹éå¸¸çš„é‡è¦ï¼Œå®ƒä¸»è¦ç”¨æ¥åŠ è½½æˆ‘ä»¬çš„UIç•Œé¢ï¼Œå®Œæˆç³»ç»Ÿå’Œæˆ‘ä»¬ç”¨æˆ·ä¹‹é—´çš„äº¤äº’ï¼Œå¹¶å°†äº¤äº’åçš„ç»“æœåˆå±•ç¤ºç»™æˆ‘ä»¬ç”¨æˆ·ï¼Œæ‰€ä»¥Main Threadåˆè¢«ç§°ä¸ºUI Threadã€‚

Androidç³»ç»Ÿé»˜è®¤ä¸ä¼šç»™æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºç»„ä»¶åˆ›å»ºä¸€ä¸ªé¢å¤–çš„çº¿ç¨‹ï¼Œæ‰€æœ‰çš„è¿™äº›ç»„ä»¶é»˜è®¤éƒ½æ˜¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œã€‚ç„¶è€Œï¼ŒæŸäº›æ—¶å€™å½“æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºéœ€è¦å®Œæˆä¸€ä¸ªè€—æ—¶çš„æ“ä½œçš„æ—¶å€™ï¼Œä¾‹å¦‚è®¿é—®ç½‘ç»œæˆ–è€…æ˜¯å¯¹æ•°æ®åº“è¿›è¡ŒæŸ¥è¯¢æ—¶ï¼Œæ­¤æ—¶æˆ‘ä»¬çš„UI Threadå°±ä¼šè¢«é˜»å¡ã€‚ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬ç‚¹å‡»ä¸€ä¸ªButtonï¼Œç„¶åå¸Œæœ›å…¶ä»ç½‘ç»œä¸­è·å–ä¸€äº›æ•°æ®ï¼Œå¦‚æœæ­¤æ“ä½œåœ¨UI Threadå½“ä¸­å®Œæˆçš„è¯ï¼Œå½“æˆ‘ä»¬ç‚¹å‡»Buttonçš„æ—¶å€™ï¼ŒUIçº¿ç¨‹å°±ä¼šå¤„äºé˜»å¡çš„çŠ¶æ€ï¼Œæ­¤æ—¶ï¼Œæˆ‘ä»¬çš„ç³»ç»Ÿä¸ä¼šè°ƒåº¦ä»»ä½•å…¶å®ƒçš„äº‹ä»¶ï¼Œæ›´ç³Ÿç³•çš„æ˜¯ï¼Œå½“æˆ‘ä»¬çš„æ•´ä¸ªç°åœºå¦‚æœé˜»å¡æ—¶é—´è¶…è¿‡5ç§’é’Ÿ(å®˜æ–¹æ˜¯è¿™æ ·è¯´çš„)ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå‡ºç° ANR (Application Not Responding)çš„ç°è±¡ï¼Œæ­¤æ—¶ï¼Œåº”ç”¨ç¨‹åºä¼šå¼¹å‡ºä¸€ä¸ªæ¡†ï¼Œè®©ç”¨æˆ·é€‰æ‹©æ˜¯å¦é€€å‡ºè¯¥ç¨‹åºã€‚å¯¹äºAndroidå¼€å‘æ¥è¯´ï¼Œå‡ºç°ANRçš„ç°è±¡æ˜¯ç»å¯¹ä¸èƒ½è¢«å…è®¸çš„ã€‚

å¦å¤–ï¼Œç”±äºæˆ‘ä»¬çš„Android UIæ§ä»¶æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½åœ¨UI Threadä¹‹å¤–çš„çº¿ç¨‹å½“ä¸­å¯¹æˆ‘ä»¬çš„UIæ§ä»¶è¿›è¡Œæ“ä½œã€‚å› æ­¤åœ¨Androidçš„å¤šçº¿ç¨‹ç¼–ç¨‹å½“ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸¤æ¡éå¸¸é‡è¦çš„åŸåˆ™å¿…é¡»è¦éµå®ˆï¼š

- **ç»å¯¹ä¸èƒ½åœ¨UI Threadå½“ä¸­è¿›è¡Œè€—æ—¶çš„æ“ä½œï¼Œä¸èƒ½é˜»å¡æˆ‘ä»¬çš„UI Thread**
- **ä¸èƒ½åœ¨UI Threadä¹‹å¤–çš„çº¿ç¨‹å½“ä¸­æ“çºµæˆ‘ä»¬çš„UIå…ƒç´ **

-------------------

åœ¨Android Appæ—¶æˆ‘ä»¬å¿…é¡»éµå®ˆè¿™ä¸ª**å•çº¿ç¨‹æ¨¡å‹**çš„è§„åˆ™ï¼š **Android UIæ“ä½œå¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„å¹¶ä¸”è¿™äº›æ“ä½œéƒ½éœ€è¦åœ¨UIçº¿ç¨‹ä¸­æ‰§è¡Œï¼** 

1. å‡å¦‚æˆ‘ä»¬åœ¨éUIçº¿ç¨‹ä¸­ï¼Œæ¯”å¦‚åœ¨ä¸»çº¿ç¨‹ä¸­new Thread()å¦å¤–å¼€è¾Ÿä¸€ä¸ªçº¿ç¨‹ï¼Œç„¶åç›´æ¥åœ¨é‡Œé¢ä¿®æ”¹UIæ§ä»¶çš„å€¼ï¼›æ­¤æ—¶ä¼šæŠ›å‡ºä¸‹è¿°å¼‚å¸¸ï¼š`android.view.ViewRoot$CalledFromWrongThreadException: Only the original thread that created a view hierarchy can touch its views`
2. è¿˜æœ‰ä¸€ç‚¹ï¼Œå¦‚æœæˆ‘ä»¬æŠŠè€—æ—¶çš„æ“ä½œéƒ½æ”¾åœ¨UIçº¿ç¨‹ä¸­çš„è¯ï¼Œå¦‚æœUIçº¿ç¨‹è¶…è¿‡5sæ²¡æœ‰å“åº”ç”¨äºè¯·æ±‚ï¼Œé‚£ä¹ˆ è¿™ä¸ªæ—¶å€™ä¼šå¼•å‘ANR(Application Not Responding)å¼‚å¸¸ï¼Œå°±æ˜¯åº”ç”¨æ— å“åº”~ 
3. æœ€åè¿˜æœ‰ä¸€ç‚¹å°±æ˜¯ï¼šAndroid 4.0åç¦æ­¢åœ¨UIçº¿ç¨‹ä¸­æ‰§è¡Œç½‘ç»œæ“ä½œ~ä¸ç„¶ä¼šæŠ¥: `android.os.NetworkOnMainThreadException`

ç®€å•æ¦‚æ‹¬å°±æ˜¯ï¼š

- Androidæ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼Œåªèƒ½åœ¨ä¸»çº¿ç¨‹ä¸­æ›´æ–°UI
- UIçº¿ç¨‹ä¸è¦åšè€—æ—¶æ“ä½œï¼Œäº¤ç”±å­çº¿ç¨‹æ¥åšï¼Œå¦åˆ™ä¼šANR
- Android 4.0åç¦æ­¢åœ¨UIçº¿ç¨‹ä¸­æ‰§è¡Œç½‘ç»œæ“ä½œ

ä»¥ä¸Šçš„ç§ç§åŸå› éƒ½è¯´æ˜äº†Androidå¼•å…¥å¼‚æ­¥ä»»åŠ¡çš„æ„ä¹‰ï¼Œå½“ç„¶å®ç°å¼‚æ­¥ä¹Ÿä¸å¯ä»¥ä¸ç”¨åˆ°æˆ‘ä»¬æœ¬èŠ‚è®²è§£ çš„AsyncTaskï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±å¼€è¾Ÿä¸€ä¸ªçº¿ç¨‹ï¼Œå®Œæˆç›¸å…³æ“ä½œåï¼Œé€šè¿‡ä¸‹è¿°ä¸¤ç§æ–¹æ³•è¿›è¡ŒUIæ›´æ–°ï¼š

1. Handleræœºåˆ¶ï¼Œæˆ‘ä»¬åœ¨Handleré‡Œå†™å¥½UIæ›´æ–°ï¼Œç„¶åé€šè¿‡sendMessage()ç­‰çš„æ–¹æ³•é€šçŸ¥UI æ›´æ–°ï¼Œå¦å¤–åˆ«å¿˜äº†Handlerå†™åœ¨ä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹ä¸­çš„åŒºåˆ«
2. åˆ©ç”¨`Activity.runOnUiThread(Runnable)`æŠŠæ›´æ–°uiçš„ä»£ç åˆ›å»ºåœ¨Runnableä¸­,æ›´æ–°UIæ—¶ï¼ŒæŠŠRunnableå¯¹è±¡ä¼ è¿›æ¥å³å¯

<br>

## 2. AsyncTaskè§£æ

### 2.1 ä¸ºä»€ä¹ˆè¦ç”¨AsyncTask

æˆ‘ä»¬å¯ä»¥ç”¨ä¸Šè¿°ä¸¤ç§æ–¹æ³•æ¥å®Œæˆæˆ‘ä»¬çš„å¼‚æ­¥æ“ä½œï¼Œå¦‚æœæˆ‘ä»¬å†™çš„å¼‚æ­¥æ“ä½œæ¯”è¾ƒå¤šï¼Œæˆ–è€…è¾ƒä¸ºç¹çï¼Œéš¾é“æˆ‘ä»¬new Thread()ç„¶åç”¨ä¸Šè¿°æ–¹æ³•é€šçŸ¥UIæ›´æ–°ä¹ˆï¼Ÿè¿™æ ·æ˜¾å¾—ç•¥å¾®ç¹çã€‚å®˜æ–¹ç»™æˆ‘ä»¬æä¾›äº†AsyncTaskè¿™ä¸ªå°è£…å¥½çš„è½»é‡çº§å¼‚æ­¥ç±»ã€‚

ç›¸æ¯”èµ·Handlerï¼ŒAsyncTaskæ˜¾å¾—æ›´åŠ ç®€å•ã€‚AsyncTaskæš‚æ—¶å¯ä»¥æ»¡è¶³åˆå­¦è€…çš„éœ€æ±‚ï¼Œä½†æ˜¯åˆ°äº†å…¬å¸çœŸæ­£åšé¡¹ç›®ä»¥åï¼Œæˆ‘ä»¬æ›´å¤šçš„ä½¿ç”¨ç¬¬ä¸‰å‘çš„æ¡†æ¶ï¼Œæ¯”å¦‚Volley,OkHttp,android-async-http,XUtilsç­‰å¾ˆå¤šï¼Œä½†æ˜¯æŒæ¡AsyncTaskè¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼

å¼‚æ­¥ä»»åŠ¡ç”±åœ¨åå°çº¿ç¨‹ä¸Šè¿è¡Œä¸”å…¶ç»“æœå‘å¸ƒåœ¨ UI çº¿ç¨‹ä¸Šçš„è®¡ç®—å®šä¹‰ã€‚å¼‚æ­¥ä»»åŠ¡æ˜¯ç”±3ç§ä¸€èˆ¬ç±»å‹ï¼Œç§°ä¸ºå®šä¹‰`Params`ï¼Œ`Progress`å’Œ`Result`ï¼Œå’Œ4ä¸ªæ­¥éª¤ï¼Œç§°ä¸º`onPreExecute`ï¼Œ`doInBackground`ï¼Œ `onProgressUpdate`å’Œ`onPostExecute`ã€‚

å’Œhandlerä¸€æ ·æ˜¯ç”¨äºå¤„ç†å¼‚æ­¥ä»»åŠ¡çš„ï¼Œä¸è¿‡å¯¹äºå‰è€…ï¼Œåè€…çš„ä»£ç æ›´ä¸ºè½»é‡çº§ï¼Œå…¶å®åå°ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œåœ¨å¼‚æ­¥ä»»æ•°æ®æ¯”è¾ƒåº•å¤§çš„æ—¶å€™ï¼ŒAsyncTaskçš„çº¿ç¨‹æ± ç»“æ„çš„ä¼˜åŠ¿å°±ä½“ç°å‡ºæ¥äº†

![image-20210808123828305](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/202108081238454.png)

### 2.2 å®˜æ–¹å£°æ˜

**AsyncTaskç±»åœ¨ API çº§åˆ« 30 ä¸­å·²å¼ƒç”¨ã€‚**

AsyncTaskæ—¨åœ¨å®ç°UIçº¿ç¨‹çš„æ­£ç¡®å’Œç®€å•ä½¿ç”¨ã€‚ç„¶è€Œï¼Œæœ€å¸¸è§çš„ç”¨ä¾‹æ˜¯é›†æˆåˆ°UIä¸­ï¼Œè¿™å°†å¯¼è‡´ä¸Šä¸‹æ–‡æ³„æ¼ã€é”™è¿‡å›è°ƒæˆ–é…ç½®æ›´æ”¹æ—¶å´©æºƒã€‚å®ƒåœ¨ä¸åŒç‰ˆæœ¬çš„å¹³å°ä¸Šä¹Ÿæœ‰ä¸ä¸€è‡´çš„è¡Œä¸ºï¼Œä»`doInBackground`æ¥å—å¼‚å¸¸ï¼Œå¹¶ä¸”åœ¨ç›´æ¥ä½¿ç”¨`Executor`æ—¶æ²¡æœ‰æä¾›å¤ªå¤šçš„å®ç”¨æ€§ã€‚

AsyncTaskè¢«è®¾è®¡æˆä¸€ä¸ªå›´ç»•`Thread`å’Œ`Handler` çš„åŠ©æ‰‹ç±»ï¼Œå¹¶ä¸æ„æˆé€šç”¨çº¿ç¨‹æ¡†æ¶ã€‚AsyncTasksç†æƒ³æƒ…å†µä¸‹åº”ç”¨äºçŸ­æœŸæ“ä½œï¼ˆæœ€å¤šå‡ ç§’é’Ÿï¼‰ã€‚å¦‚æœéœ€è¦è®©çº¿ç¨‹é•¿æ—¶é—´è¿è¡Œï¼Œå¼ºçƒˆå»ºè®®æ‚¨ä½¿ç”¨`java.util.concurrent`åŒ…æä¾›çš„å„ç§APIï¼Œï¼Œä¾‹å¦‚`Executor`ã€ `ThreadPoolExecutor`å’Œ`FutureTask`ã€‚

### 2.3 AsyncTaskçš„åŸºæœ¬ç»“æ„

#### 2.3.1 ä½¿ç”¨è¯´æ˜

`AsyncTask`ç±»å±äºæŠ½è±¡ç±»ï¼Œå³ä½¿ç”¨æ—¶éœ€ å®ç°å­ç±»

```cpp
public abstract class AsyncTask<Params, Progress, Result> { 
 ... 
}
```

ç±»ä¸­å‚æ•°ä¸º3ç§æ³›å‹ç±»å‹

æ•´ä½“ä½œç”¨ï¼šæ§åˆ¶AsyncTaskå­ç±»æ‰§è¡Œçº¿ç¨‹ä»»åŠ¡æ—¶å„ä¸ªé˜¶æ®µçš„è¿”å›ç±»å‹

å…·ä½“è¯´æ˜ï¼š

- Paramsï¼šå¼€å§‹å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œæ—¶ä¼ å…¥çš„å‚æ•°ç±»å‹ï¼Œå¯¹åº”`excute()`ä¸­ä¼ é€’çš„å‚æ•°
- Progressï¼šå¼‚æ­¥ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè¿”å›ä¸‹è½½è¿›åº¦å€¼çš„ç±»å‹
- Resultï¼šå¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œè¿”å›çš„ç»“æœç±»å‹ï¼Œä¸doInBackground()çš„è¿”å›å€¼ç±»å‹ä¿æŒä¸€è‡´
    - ä½¿ç”¨æ—¶å¹¶ä¸æ˜¯æ‰€æœ‰ç±»å‹éƒ½è¢«ä½¿ç”¨
    - è‹¥æ— è¢«ä½¿ç”¨ï¼Œå¯ç”¨java.lang.Voidç±»å‹ä»£æ›¿
    - **è‹¥æœ‰ä¸åŒä¸šåŠ¡ï¼Œéœ€é¢å¤–å†å†™1ä¸ªAsyncTaskçš„å­ç±»**



#### 2.3.2 æ ¸å¿ƒæ–¹æ³•

![944365-153fb37764704129](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/202108082241760.png)

![image-20210808130219263](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/202108081302391.png)

#### 2.3.3 å››ä¸ªæ­¥éª¤

å½“ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡è¢«æ‰§è¡Œæ—¶ï¼Œä»»åŠ¡ä¼šç»è¿‡ 4 ä¸ªæ­¥éª¤ï¼š

1. `onPreExecute()`ï¼Œåœ¨æ‰§è¡Œä»»åŠ¡ä¹‹å‰åœ¨ UI çº¿ç¨‹ä¸Šè°ƒç”¨ã€‚æ­¤æ­¥éª¤é€šå¸¸ç”¨äºè®¾ç½®ä»»åŠ¡ï¼Œä¾‹å¦‚é€šè¿‡åœ¨ç”¨æˆ·ç•Œé¢ä¸­æ˜¾ç¤ºè¿›åº¦æ¡ã€‚
2. `doInBackground(Params...)`,`onPreExecute()`æ‰§è¡Œå®Œæˆåç«‹å³åœ¨åå°çº¿ç¨‹ä¸Šè°ƒç”¨ã€‚æ­¤æ­¥éª¤ç”¨äºæ‰§è¡Œå¯èƒ½éœ€è¦å¾ˆé•¿æ—¶é—´çš„åå°è®¡ç®—ã€‚å¼‚æ­¥ä»»åŠ¡çš„å‚æ•°ä¼ é€’åˆ°è¿™ä¸€æ­¥ã€‚è®¡ç®—çš„ç»“æœå¿…é¡»ç”±è¿™ä¸€æ­¥è¿”å›ï¼Œå¹¶å°†ä¼ é€’å›æœ€åä¸€æ­¥ã€‚æ­¤æ­¥éª¤è¿˜å¯ç”¨äº`publishProgress(Progress...)`å‘å¸ƒä¸€ä¸ªæˆ–å¤šä¸ªè¿›åº¦å•å…ƒã€‚è¿™äº›å€¼åœ¨`onProgressUpdate(Progress...)`æ­¥éª¤ä¸­çš„ UI çº¿ç¨‹ä¸Šå‘å¸ƒ ã€‚
3. `onProgressUpdate(Progress...)`, è°ƒç”¨ååœ¨ UI çº¿ç¨‹ä¸Šè°ƒç”¨`publishProgress(Progress...)`ã€‚æ‰§è¡Œçš„æ—¶é—´æ˜¯ä¸ç¡®å®šçš„ã€‚æ­¤æ–¹æ³•ç”¨äºåœ¨åå°è®¡ç®—ä»åœ¨æ‰§è¡Œæ—¶åœ¨ç”¨æˆ·ç•Œé¢ä¸­æ˜¾ç¤ºä»»ä½•å½¢å¼çš„è¿›åº¦ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯ç”¨äºåŠ¨ç”»è¿›åº¦æ¡æˆ–åœ¨æ–‡æœ¬å­—æ®µä¸­æ˜¾ç¤ºæ—¥å¿—ã€‚
4. `onPostExecute(Result)`, åœ¨åå°è®¡ç®—å®Œæˆååœ¨ UI çº¿ç¨‹ä¸Šè°ƒç”¨ã€‚åå°è®¡ç®—çš„ç»“æœä½œä¸ºå‚æ•°ä¼ é€’ç»™è¿™ä¸€æ­¥ã€‚

> ä¸ºä»€ä¹ˆæˆ‘ä»¬çš„AsyncTaskæŠ½è±¡ç±»åªæœ‰ä¸€ä¸ª doInBackground çš„æŠ½è±¡æ–¹æ³•å‘¢ï¼Ÿï¼ŸåŸå› æ˜¯ï¼Œæˆ‘ä»¬å¦‚æœè¦åšä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œæˆ‘ä»¬å¿…é¡»è¦ä¸ºå…¶å¼€è¾Ÿä¸€ä¸ªæ–°çš„Threadï¼Œè®©å…¶å®Œæˆä¸€äº›æ“ä½œï¼Œè€Œåœ¨å®Œæˆè¿™ä¸ªå¼‚æ­¥ä»»åŠ¡æ—¶ï¼Œæˆ‘å¯èƒ½å¹¶ä¸éœ€è¦å¼¹å‡ºè¦ç»™ProgressDialogï¼Œæˆ‘å¹¶ä¸éœ€è¦éšæ—¶æ›´æ–°æˆ‘çš„ProgressDialogçš„è¿›åº¦æ¡ï¼Œæˆ‘ä¹Ÿå¹¶ä¸éœ€è¦å°†ç»“æœæ›´æ–°ç»™æˆ‘ä»¬çš„UIç•Œé¢ï¼Œæ‰€ä»¥é™¤äº† doInBackground æ–¹æ³•ä¹‹å¤–çš„ä¸‰ä¸ªæ–¹æ³•ï¼Œéƒ½ä¸æ˜¯å¿…é¡»æœ‰çš„ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»è¦å®ç°çš„æ–¹æ³•æ˜¯ doInBackground æ–¹æ³•ã€‚

#### 2.3.4 å–æ¶ˆä»»åŠ¡

é¦–æ¬¡å¼•å…¥æ—¶ï¼ŒAsyncTasks åœ¨å•ä¸ªåå°çº¿ç¨‹ä¸Šä¸²è¡Œæ‰§è¡Œã€‚ ä» **Build.VERSION_CODES.DONUT** å¼€å§‹ï¼Œè¿™å·²æ›´æ”¹ä¸ºå…è®¸å¤šä¸ªä»»åŠ¡å¹¶è¡Œæ“ä½œçš„çº¿ç¨‹æ± ã€‚ ä» **Build.VERSION_CODES.HONEYCOMB** å¼€å§‹ï¼Œä»»åŠ¡åœ¨å•ä¸ªçº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œä»¥é¿å…å¹¶è¡Œæ‰§è¡Œå¯¼è‡´çš„å¸¸è§åº”ç”¨ç¨‹åºé”™è¯¯ã€‚

å¦‚æœä½ çœŸçš„æƒ³è¦å¹¶è¡Œæ‰§è¡Œï¼Œä½ å¯ä»¥ç”¨ **THREAD_POOL_EXECUTOR** è°ƒç”¨ `executeOnExecutor(java.util.concurrent.Executor, java.lang.Object[])`ã€‚

#### 2.3.5 æ–¹æ³•æ‰§è¡Œé¡ºåºå¦‚ä¸‹

![944365-31df794006c69621](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/202108082241703.png)

#### 2.3.5 æ³¨æ„äº‹é¡¹

1. Taskçš„å®ä¾‹å¿…é¡»åœ¨UI threadä¸­åˆ›å»ºï¼›
2. executeæ–¹æ³•å¿…é¡»åœ¨UI threadä¸­è°ƒç”¨ï¼›
3. ä¸è¦æ‰‹åŠ¨çš„è°ƒç”¨onPreExecute(),onPostExecute(Result),doInBackground(Params...),onProgressUpdate(Progress...)è¿™å‡ ä¸ªæ–¹æ³•ï¼›
4. è¯¥taskåªèƒ½è¢«æ‰§è¡Œä¸€æ¬¡ï¼Œå¦åˆ™å¤šæ¬¡è°ƒç”¨æ—¶å°†ä¼šå‡ºç°å¼‚å¸¸ï¼›

<br>

<hr>

<br>

## 3. ä½¿ç”¨æ­¥éª¤

AsyncTaskçš„ä½¿ç”¨æ­¥éª¤æœ‰3ä¸ªï¼š

1. åˆ›å»º `AsyncTask` å­ç±» & æ ¹æ®éœ€æ±‚å®ç°æ ¸å¿ƒæ–¹æ³•
2. åˆ›å»º `AsyncTask`å­ç±»çš„å®ä¾‹å¯¹è±¡ï¼ˆå³ ä»»åŠ¡å®ä¾‹ï¼‰
3. æ‰‹åŠ¨è°ƒç”¨`execute()`ä»è€Œæ‰§è¡Œå¼‚æ­¥çº¿ç¨‹ä»»åŠ¡

å…·ä½“ä»‹ç»å¦‚ä¸‹:

æ­¥éª¤1ï¼šåˆ›å»ºAsyncTaskå­ç±»

- ç»§æ‰¿AsyncTaskç±»
- ä¸º3ä¸ªæ³›å‹å‚æ•°æŒ‡å®šç±»å‹ï¼›è‹¥ä¸ä½¿ç”¨ï¼Œå¯ç”¨java.lang.Voidç±»å‹ä»£æ›¿
- æ ¹æ®éœ€æ±‚ï¼Œåœ¨AsyncTaskå­ç±»å†…å®ç°æ ¸å¿ƒæ–¹æ³•

```java
private class MyTask extends AsyncTask<Params, Progress, Result> {

      // æ–¹æ³•1ï¼šonPreExecuteï¼ˆï¼‰
      // ä½œç”¨ï¼šæ‰§è¡Œ çº¿ç¨‹ä»»åŠ¡å‰çš„æ“ä½œ
      // æ³¨ï¼šæ ¹æ®éœ€æ±‚å¤å†™
      @Override
      protected void onPreExecute() {
           // TODO
       }

      // æ–¹æ³•2ï¼šdoInBackgroundï¼ˆï¼‰
      // ä½œç”¨ï¼šæ¥æ”¶è¾“å…¥å‚æ•°ã€æ‰§è¡Œä»»åŠ¡ä¸­çš„è€—æ—¶æ“ä½œã€è¿”å› çº¿ç¨‹ä»»åŠ¡æ‰§è¡Œçš„ç»“æœ
      // æ³¨ï¼šå¿…é¡»å¤å†™ï¼Œä»è€Œè‡ªå®šä¹‰çº¿ç¨‹ä»»åŠ¡
      @Override
      protected String doInBackground(String... params) {

            // TODO: è‡ªå®šä¹‰çš„çº¿ç¨‹ä»»åŠ¡

            // å¯è°ƒç”¨publishProgress() æ˜¾ç¤ºè¿›åº¦, ä¹‹åå°†æ‰§è¡ŒonProgressUpdate()
             publishProgress(count);
         }

      // æ–¹æ³•3ï¼šonProgressUpdateï¼ˆï¼‰
      // ä½œç”¨ï¼šåœ¨ä¸»çº¿ç¨‹ æ˜¾ç¤ºçº¿ç¨‹ä»»åŠ¡æ‰§è¡Œçš„è¿›åº¦
      // æ³¨ï¼šæ ¹æ®éœ€æ±‚å¤å†™
      @Override
      protected void onProgressUpdate(Integer... progresses) {
            // TODO
        }

      // æ–¹æ³•4ï¼šonPostExecuteï¼ˆï¼‰
      // ä½œç”¨ï¼šæ¥æ”¶çº¿ç¨‹ä»»åŠ¡æ‰§è¡Œç»“æœã€å°†æ‰§è¡Œç»“æœæ˜¾ç¤ºåˆ°UIç»„ä»¶
      // æ³¨ï¼šå¿…é¡»å¤å†™ï¼Œä»è€Œè‡ªå®šä¹‰UIæ“ä½œ
      @Override
      protected void onPostExecute(String result) {
         // UIæ“ä½œ,å›è°ƒè¿”å›æ‰§è¡Œç»“æœ
        }

      // æ–¹æ³•5ï¼šonCancelled()
      // ä½œç”¨ï¼šå°†å¼‚æ­¥ä»»åŠ¡è®¾ç½®ä¸ºï¼šå–æ¶ˆçŠ¶æ€
      @Override
        protected void onCancelled() {
        
        }
  }
```

ã€æ­¥éª¤2ã€‘ï¼šåˆ›å»ºAsyncTaskå­ç±»çš„å®ä¾‹å¯¹è±¡ï¼ˆå³ ä»»åŠ¡å®ä¾‹ï¼‰

  * AsyncTaskå­ç±»çš„å®ä¾‹å¿…é¡»åœ¨UIçº¿ç¨‹ä¸­åˆ›å»º

```java
MyTask mTask = new MyTask();
```

ã€æ­¥éª¤3ã€‘ï¼šæ‰‹åŠ¨è°ƒç”¨execute(Params... params) ä»è€Œæ‰§è¡Œå¼‚æ­¥çº¿ç¨‹ä»»åŠ¡
  * å¿…é¡»åœ¨UIçº¿ç¨‹ä¸­è°ƒç”¨
  *    åŒä¸€ä¸ªAsyncTaskå®ä¾‹å¯¹è±¡åªèƒ½æ‰§è¡Œ1æ¬¡ï¼Œè‹¥æ‰§è¡Œç¬¬2æ¬¡å°†ä¼šæŠ›å‡ºå¼‚å¸¸
  *    æ‰§è¡Œä»»åŠ¡ä¸­ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è°ƒç”¨AsyncTaskçš„ä¸€ç³»åˆ—æ–¹æ³•ï¼šonPreExecute() ã€doInBackground()ã€onProgressUpdate() ã€onPostExecute() 
  * ä¸èƒ½æ‰‹åŠ¨è°ƒç”¨ä¸Šè¿°æ–¹æ³•

 ```java
 mTask.execute();
 ```

<br>

## 4. å®ä¾‹ä¸€ï¼šæ˜¾ç¤ºåŠ è½½èµ„æºä»»åŠ¡çš„è¿›åº¦

1. ç‚¹å‡»æŒ‰é’® åˆ™ å¼€å¯çº¿ç¨‹æ‰§è¡Œçº¿ç¨‹ä»»åŠ¡
2. æ˜¾ç¤ºåå°åŠ è½½è¿›åº¦
3. åŠ è½½å®Œæ¯•åæ›´æ–°UIç»„ä»¶
4. æœŸé—´è‹¥ç‚¹å‡»å–æ¶ˆæŒ‰é’®ï¼Œåˆ™å–æ¶ˆåŠ è½½

![AsyncTask](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/202108141948028.gif)

> ä»£ç é“¾æ¥ï¼š[Demo01-MainActivity](https://github.com/IQQcode/MobileCoding/tree/main/Android-Base/05-Network/BaseNet/03AsyncTask/app/src/main/java/top/iqqcode/asynctask)

```java
public class MainActivity extends AppCompatActivity {

    // ä¸»å¸ƒå±€ä¸­çš„UIç»„ä»¶
    private Button button, cancel; // åŠ è½½ã€å–æ¶ˆæŒ‰é’®
    private TextView text; // æ›´æ–°çš„UIç»„ä»¶
    private ProgressBar progressBar; // è¿›åº¦æ¡

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        initView();

        // AsyncTaskå­ç±»çš„å®ä¾‹å¿…é¡»åœ¨UIçº¿ç¨‹ä¸­åˆ›å»º
        MyAsyncTask mTask = new MyAsyncTask();

        button.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                mTask.execute();
            }
        });

        cancel = (Button) findViewById(R.id.cancel);
        cancel.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                // å–æ¶ˆä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡,onCancelledæ–¹æ³•å°†ä¼šè¢«è°ƒç”¨
                mTask.cancel(true);
            }
        });
    }

    private void initView() {
        button = (Button) findViewById(R.id.button);
        cancel = (Button) findViewById(R.id.cancel);
        text = (TextView) findViewById(R.id.text);
        progressBar = (ProgressBar) findViewById(R.id.progress_bar);

    }

    /**
     * æ­¥éª¤1ï¼šåˆ›å»ºAsyncTaskå­ç±»
     * æ³¨ï¼š
     * a. ç»§æ‰¿AsyncTaskç±»
     * b. ä¸º3ä¸ªæ³›å‹å‚æ•°æŒ‡å®šç±»å‹ï¼›è‹¥ä¸ä½¿ç”¨ï¼Œå¯ç”¨java.lang.Voidç±»å‹ä»£æ›¿
     * æ­¤å¤„æŒ‡å®šä¸ºï¼šè¾“å…¥å‚æ•° = Stringç±»å‹ã€æ‰§è¡Œè¿›åº¦ = Integerç±»å‹ã€æ‰§è¡Œç»“æœ = Stringç±»å‹
     * c. æ ¹æ®éœ€æ±‚ï¼Œåœ¨AsyncTaskå­ç±»å†…å®ç°æ ¸å¿ƒæ–¹æ³•
     */

    private class MyAsyncTask extends AsyncTask<String, Integer, String> {

        // ä½œç”¨ï¼šæ‰§è¡Œ çº¿ç¨‹ä»»åŠ¡å‰çš„æ“ä½œ
        @Override
        protected void onPreExecute() {
            text.setText("åŠ è½½ä¸­");
            // æ‰§è¡Œå‰æ˜¾ç¤ºæç¤º
        }

        // ä½œç”¨ï¼šæ¥æ”¶è¾“å…¥å‚æ•°ã€æ‰§è¡Œä»»åŠ¡ä¸­çš„è€—æ—¶æ“ä½œã€è¿”å› çº¿ç¨‹ä»»åŠ¡æ‰§è¡Œçš„ç»“æœ
        // æ­¤å¤„é€šè¿‡è®¡ç®—ä»è€Œæ¨¡æ‹Ÿâ€œåŠ è½½è¿›åº¦â€çš„æƒ…å†µ
        @Override
        protected String doInBackground(String... strings) {
            try {
                int count = 0;
                int length = 1;
                while (count < 99) {

                    count += length;
                    // å¯è°ƒç”¨publishProgressï¼ˆï¼‰æ˜¾ç¤ºè¿›åº¦, ä¹‹åå°†æ‰§è¡ŒonProgressUpdateï¼ˆï¼‰
                    publishProgress(count);
                    // æ¨¡æ‹Ÿè€—æ—¶ä»»åŠ¡
                    Thread.sleep(50);
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            return null;
        }

        // ä½œç”¨ï¼šåœ¨ä¸»çº¿ç¨‹ æ˜¾ç¤ºçº¿ç¨‹ä»»åŠ¡æ‰§è¡Œçš„è¿›åº¦
        @Override
        protected void onProgressUpdate(Integer... values) {
            super.onProgressUpdate(values);
            progressBar.setProgress(values[0]);
            text.setText("loading..." + values[0] + "%");
        }

        // ä½œç”¨ï¼šæ¥æ”¶çº¿ç¨‹ä»»åŠ¡æ‰§è¡Œç»“æœã€å°†æ‰§è¡Œç»“æœæ˜¾ç¤ºåˆ°UIç»„ä»¶
        @Override
        protected void onPostExecute(String result) {
            // æ‰§è¡Œå®Œæ¯•åï¼Œåˆ™æ›´æ–°UI
            text.setText("åŠ è½½å®Œæ¯•");
        }

        // ä½œç”¨ï¼šå°†å¼‚æ­¥ä»»åŠ¡è®¾ç½®ä¸ºï¼šå–æ¶ˆçŠ¶æ€
        @Override
        protected void onCancelled() {
            text.setText("å·²å–æ¶ˆ");
            progressBar.setProgress(0);

        }
    }
}
```

<br>

å¦‚æœç‚¹å‡»å–æ¶ˆå†ç‚¹å‡»ä¸‹è½½ï¼Œå°±ä¼šå‡ºç° **éæ³•çŠ¶æ€å¼‚å¸¸**ï¼Œå› ä¸ºAsyncTaskåªèƒ½åˆ›å»ºä¸€ä¸ªå®ä¾‹

![image-20210814195120392](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/202108141951549.png)

<br>

## 5.  è·å–AsyncTaskè¿”å›å€¼

åœ¨æŸä¸ªæ–¹æ³•/ç±»éœ€è¦è€—æ—¶æ“ä½œï¼Œè€Œå½“è€—æ—¶æ“ä½œç»“æŸåéœ€è¦è¿”å›æŸä¸ªå€¼æˆ–ä¿¡å·ï¼Œå®ç°æ–¹æ³•æœ‰å¾ˆå¤šï¼Œå¯ä»¥é€šè¿‡Handlerã€AsyncTaskç­‰æŠŠå€¼è¿”å›ç»™UIçº¿ç¨‹ï¼Œæ­¤æ–‡åˆ™é€šè¿‡å®šä¹‰å†…éƒ¨è‡ªå®šä¹‰ç›‘å¬æ¥å£åŠHandlerï¼Œå®ç°**å›è°ƒæ•°æ®**ã€‚

### å›è°ƒå‚æ•°é€šè¿‡è‡ªå®šä¹‰ç›‘å¬äº‹ä»¶

**é¦–å…ˆåˆ›å»ºå›è°ƒæ¥å£**

```java
public interface OnDataListener {
    void onDataSuccess(String data);
    void onDataFailed(String error);
}
```

**åœ¨AsyncTaskä¸­é€šè¿‡æ­¤æ¥å£è·å–åˆ°onPostExecuteä¸­çš„æ•°å€¼**

```java
public class MyAsyncTask extends AsyncTask<Void, Void, String> {

    private OnDataListener listener;

    public void setOnDataListener(OnDataListener asyncResponse) {
        this.listener = asyncResponse;
    }

    @Override
    protected String doInBackground(Void... voids) {
        return responseData;
    }

    @Override
    protected void onPostExecute(String msg) {
        super.onPostExecute(msg);
        if (msg != null | msg.length() != 0) {
            if (responseCode == 200) {
                listener.onDataSuccess(msg); // ä»»åŠ¡å®Œæˆæ—¶æ‰§è¡Œæ­¤æ–¹æ³•
            } else {
                listener.onDataFailed(msg + " " + responseCode); // ä»»åŠ¡å¤±è´¥æ‰§è¡Œæ­¤æ–¹æ³•
            }
        } else {
            msg = "ç½‘ç»œæ— æ³•è¯·æ±‚";
        }
    }
}
```

**åœ¨Activityæˆ–è€…Fragmentä¸­å®ç°æ­¤æ¥å£å³å¯**

```java
@Override
public void onClick(View v) {
    // æäº¤å¼‚æ­¥ä»»åŠ¡
    MyAsyncTask asyncTask = new MyAsyncTask(sb.toString());
    asyncTask.execute();
    // é€šè¿‡è‡ªå®šä¹‰çš„æ¥å£å›è°ƒè·å–AsyncTaskä¸­onPostExecuteè¿”å›çš„ç»“æœå˜é‡
    asyncTask.setOnDataListener(new OnDataListener() {
        // è¯·æ±‚æˆåŠŸåå›è°ƒï¼Œå¾—åˆ°æˆåŠŸæ‰§è¡Œçš„ç»“æœ
        @Override
        public void onDataSuccess(String data) {
            JSONFormat format = new JSONFormat();
            mTextView.setText(format.printJson(data));
        } 
        
        // è¯·æ±‚å¤±è´¥åå›è°ƒï¼Œè¿”å›é”™è¯¯ç 
        @Override
        public void onDataFailed(String error) {
            mTextView.setText("Error Code is" + error);
        }
    });
}
```



### ä½¿ç”¨Handler

```java
public class ImageViewAsyncTask extends AsyncTask<String, Integer, Bitmap> {
     
    String mUrl;
    Handler mHandler;
     
    public ImageViewAsyncTask(String url,Handler handler){
        this.mUrl = url;
        this.mHandler = handler;
    }
 
    @Override
    protected Bitmap doInBackground(String... params) {
        InputStream ins = null;
        Bitmap bitmap = null;
        try {
            URL url = new URL(mUrl);
            HttpURLConnection connection = (HttpURLConnection) url.openConnection();
            if(connection.getResponseCode()==HttpURLConnection.HTTP_OK){
                ins = connection.getInputStream();
                bitmap = BitmapFactory.decodeStream(ins);
                return bitmap;
            }
        } catch (MalformedURLException e) {
            e.printStackTrace();
        } catch (IOException e) {
            e.printStackTrace();
        }finally{
            if(ins!=null){
                try {
                    ins.close();
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }
        return null;
    }
 
    @Override
    protected void onPreExecute() {
        super.onPreExecute();
    }
 
    @Override
    protected void onPostExecute(Bitmap result) {
        super.onPostExecute(result);
        Message msg = mHandler.obtainMessage();
        if(result!=null){
            msg.what = 1;
            msg.obj = result;
        } else{
            msg.what = 2;
        }
        mHandler.sendMessage(msg);
    }
 
    @Override
    protected void onProgressUpdate(Integer... values) {
        super.onProgressUpdate(values);
    }     
}
```

**è°ƒç”¨æ–¹å¼**

```java
ImageViewAsyncTask task2 = new ImageViewAsyncTask("http://static.oschina.net/uploads/ad/new_banner_one_ronglianyun_WrqUs.png", handler);
        task2.execute();
 
Handler handler = new Handler(){
 
        @Override
        public void handleMessage(Message msg) {
            switch (msg.what) {
            case 1:
                Bitmap bitmap = (Bitmap) msg.obj;
                im2.setImageBitmap(bitmap);
                break;
 
            default:
                break;
            }
        }
         
    };
```





<br>

## 6.  å®ä¾‹äºŒï¼šAsyncTaskè¯·æ±‚ç½‘ç»œæ•°æ®

HttpURLConnectionã€AsyncTaské…åˆæ¥å£å®ç°è¯·æ±‚ç½‘ç»œä»»åŠ¡

![image-20210815100950346](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/202108151009516.png)

èšåˆæ•°æ®æ¥å£ï¼š

```
è¯·æ±‚åœ°å€ï¼šhttp://japi.juhe.cn/qqevaluate/qq
è¯·æ±‚å‚æ•°ï¼šqq=2726109782&key=e6ce0de3a1db3739d4343b9d19a9d61f
è¯·æ±‚æ–¹å¼ï¼šGET
```

### åˆ›å»ºæ¥å£

ç½‘ç»œè¯·æ±‚æ˜¯å¼‚æ­¥çš„ï¼Œè€Œä¸”**å¿…é¡»åœ¨å­çº¿ç¨‹ä½¿ç”¨**ï¼Œç¨æœ‰ç‚¹éº»çƒ¦ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨AsyncTaskå®Œæˆä»»åŠ¡åè°ƒç”¨æ¥å£çš„æ–¹å¼æ‰§è¡Œä»£ç æ“ä½œã€‚

å…ˆåˆ›å»ºä¸€ä¸ªæ¥å£ï¼šHttpGetDataListener.java

```java
public interface HttpGetDataListener {
    void getData(String data);
}
```

### åˆ›å»ºAsyncTask

- åœ¨doInBackground()æ–¹æ³•ä¸­æ‰§è¡Œç½‘ç»œè¯·æ±‚
- onPostExecute()æ–¹æ³•ä¸­ä½¿ç”¨æ¥å£è¦æ‰§è¡Œçš„æ–¹æ³•

**MyAsyncTaskè´Ÿè´£ç½‘ç»œè¯·æ±‚**

```java
public class MyAsyncTask extends AsyncTask<Void, Void, String> {

    private OnDataListener listener;
    private String mUrl;
    int responseCode = 0;

    public MyAsyncTask(String url) {
        this.mUrl = url;
    }

    public void setOnDataListener(OnDataListener asyncResponse) {
        this.listener = asyncResponse;
    }

    @Override
    protected String doInBackground(Void... voids) {
        HttpURLConnection connection = null;
        BufferedReader reader = null;
        String responseData = "";
        try {
            URL url = new URL(mUrl);
            connection = (HttpURLConnection) url.openConnection();
            connection.setRequestMethod("GET");
            connection.setReadTimeout(3000);
            connection.setConnectTimeout(3000);
            InputStream in = connection.getInputStream();
            reader = new BufferedReader(new InputStreamReader(in));
            StringBuilder sb = new StringBuilder();
            String line;
            while ((line = reader.readLine()) != null) {
                sb.append(line);
            }
            responseData = sb.toString();
            responseCode = connection.getResponseCode();
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            // å…³é—­è¿æ¥ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
            if (reader != null) {
                try {
                    reader.close();
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
            if (connection != null) {
                connection.disconnect();
            }
        }
        return responseData;
    }

    @Override
    protected void onPostExecute(String msg) {
        super.onPostExecute(msg);
        if (msg != null | msg.length() != 0) {
            if (responseCode == 200) {
                listener.onDataSuccess(msg); // ä»»åŠ¡å®Œæˆæ—¶æ‰§è¡Œæ­¤æ–¹æ³•
            } else {
                listener.onDataFailed(msg + " " + responseCode);
            }
        } else {
            msg = "ç½‘ç»œæ— æ³•è¯·æ±‚";
        }
    }
}
```

**MainActivity å­˜å…¥URL**

```java
public class MainActivity extends AppCompatActivity implements View.OnClickListener {

    private TextView mTextView;
    private Button mButton;
    private String url = "http://japi.juhe.cn/qqevaluate/qq";

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        setContentView(R.layout.activity_main);
        initView();
    }

    private void initView() {
        mTextView = findViewById(R.id.text_content);
        mButton = findViewById(R.id.net_button);
        mButton.setOnClickListener(this);
    }

    @Override
    public void onClick(View v) {
        // urlå‚æ•°æ‹¼æ¥
        StringBuilder sb = new StringBuilder("http://japi.juhe.cn/qqevaluate/qq");
        sb.append("?qq=");
        sb.append(URLEncoder.encode("1527147030"));
        sb.append("&key=");
        sb.append(URLEncoder.encode("e6ce0de3a1db3739d4343b9d19a9d61f"));
        Log.i("TAG", "æ‹¼æ¥URL >>> " + sb.toString());

        // æäº¤å¼‚æ­¥ä»»åŠ¡
        MyAsyncTask asyncTask = new MyAsyncTask(sb.toString());
        asyncTask.execute();
        asyncTask.setOnDataListener(new OnDataListener() {
            @Override
            public void onDataSuccess(String data) {
                JSONFormat format = new JSONFormat();
                mTextView.setText(format.printJson(data));
            }

            @Override
            public void onDataFailed(String error) {
                mTextView.setText("Error Code is" + error);
            }
        });
    }
}
```

<br>

## 7. å®ä¾‹ä¸‰ï¼šåŠ è½½ç½‘ç»œå›¾ç‰‡

ä½¿ç”¨AsyncTaskåŠ è½½ç½‘ç»œå›¾ç‰‡

è‡ªå®šä¹‰å°è£…ImageViewå‚è€ƒğŸ”—[https://blog.csdn.net/qq_33200967/article/details/77263062](https://blog.csdn.net/qq_33200967/article/details/77263062)

> åŸæ–‡ä½¿ç”¨Handler+Threadçš„æ–¹å¼æ¥åŠ è½½ç½‘ç»œå›¾ç‰‡ï¼ŒImageViewåšäº†è‡ªå®šä¹‰å°è£…ï¼Œä¼ å…¥URLå³å¯åŠ è½½è¯¥å›¾ç‰‡

æˆ‘å°†Thread å­çº¿ç¨‹è”ç½‘ï¼Œé€šè¿‡Handlerè®¾ç½®å›¾ç‰‡çš„æ–¹å¼æ”¹ä¸ºäº†ç”¨AsyncTaskï¼ŒäºŒè€…æ•ˆæœç­‰ä»·ã€‚AsyncTaskå®è´¨ä¸Šå°±æ˜¯å°†çº¿ç¨‹ä»»åŠ¡æ”¾åˆ°çº¿ç¨‹æ± æ¥å¤„ç†ã€‚

> æ–‡ä¸­ä»£ç å®ä¾‹ï¼š[https://github.com/IQQcode/MobileCoding/tree/main/Android-Base/05-Network/BaseNet/03AsyncTask](https://github.com/IQQcode/MobileCoding/tree/main/Android-Base/05-Network/BaseNet/03AsyncTask)



-----------------

ã€æ–‡ç« å‚è€ƒã€‘

[1] CSDNä½œè€…-hnyzwtf. https://blog.csdn.net/hnyzwtf/article/details/51099075.



