---
title: ContentProvideråŸºç¡€å†…å®¹
date: 2021-06-02 08:45:35
permalink: /pages/5cdd4b/
categories:
  - Android
  - å››å¤§ç»„ä»¶
  - ContentProvider
tags:
  - 
---



## 1. ContentProviderç®€ä»‹

![image-20210414210144862](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-befo/20210414210144.png)

å¦‚çŸ­ä¿¡åº”ç”¨åœ¨ç¼–è¾‘çŸ­ä¿¡æ—¶ï¼Œéœ€è¦æ·»åŠ è”ç³»äººç”µè¯ï¼Œä½†æ˜¯è”ç³»äººåˆ—è¡¨çš„è¡¨æ•°æ®å­˜å‚¨åœ¨åº“ä¸­ï¼›å½“å‰çš„è”ç³»äººæ•°æ®è¡¨æ˜¯ç§æœ‰çš„ï¼ŒçŸ­ä¿¡åº”ç”¨æ— æ³•è·å–åˆ°ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬ä¸­é—´é€šè¿‡**ContentProvider(å†…å®¹æä¾›è€…)**æ¥è·å–åˆ°è”ç³»äººåˆ—è¡¨ï¼ŒçŸ­ä¿¡åº”ç”¨é€šè¿‡**ContentProvider**æ¥è·å–ï¼›çŸ­ä¿¡å¦‚ä½•è·å–**ContentProvider**æš´éœ²çš„æ¥å£å‘¢ï¼Ÿé€šè¿‡**ContentResolver(å†…å®¹è§£æå™¨)** é€šè¿‡ `URI` æ¥è®¿é—®ContentProvideræä¾›çš„æ¥å£

### 1.1 ContentProvideræ˜¯ä»€ä¹ˆ

è¿›ç¨‹é—´ è¿›è¡Œ**æ•°æ®äº¤äº’ & å…±äº«**ï¼Œå³è·¨è¿›ç¨‹é€šä¿¡

![image-20210416084516252](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-befo/20210416084517.png)

- ContentProvider=ä¸­é—´è€…è§’è‰²ï¼ˆæ¬è¿å·¥ï¼‰,çœŸæ­£å­˜å‚¨&æ“ä½œæ•°æ®çš„æ•°æ®æºè¿˜æ˜¯åŸæ¥å­˜å‚¨æ•°æ®çš„æ–¹å¼ï¼ˆæ•°æ®åº“ã€æ–‡ä»¶ã€xmlæˆ–ç½‘ç»œï¼‰
- æ•°æ®æºå¯ä»¥ï¼šæ•°æ®åº“ï¼ˆå¦‚Sqlite)ã€æ–‡ä»¶ã€XMLã€ç½‘ç»œç­‰ç­‰

 ContentProvideræ˜¯Androidå››å¤§ç»„ä»¶ä¹‹ä¸€ï¼Œ**å°†æ•°æ®åº“è¡¨æ•°æ®æ“ä½œæš´éœ²ç»™å…¶ä»–åº”ç”¨è®¿é—®**ï¼›å…¶ä»–åº”ç”¨éœ€è¦ä½¿ç”¨**ContentResolver**æ¥è°ƒç”¨ContentProviderçš„æ–¹æ³•ï¼Œé€šè¿‡URIè¿›è¡Œé€šä¿¡

ContentProvideræ˜¯ä¸€ç§æ•°æ®å…±äº«æœºåˆ¶ï¼Œå®ƒå°†**å…è®¸å…¶å®ƒåº”ç”¨ç¨‹åºå¯¹è‡ªèº«åº”ç”¨ç¨‹åºä¸­çš„æ•°æ®æ‰§è¡Œå¢åˆ æ”¹æŸ¥æ“ä½œ**ï¼› 

<br>

### 1.2 ContentProvideræ‰§è¡ŒåŸç†

![image-20210416101954537](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-befo/20210416101954.png)

<br>

### 1.3 ContentProviderç›¸å…³API

providerå¯¹è±¡åˆ›å»ºåè°ƒç”¨ï¼ˆåº”ç”¨å®‰è£…å®Œæˆæˆ–æ‰‹æœºå¯åŠ¨å®Œæˆï¼‰

```java
public abstract boolean onCreate();
```

æŸ¥è¯¢æ•°æ®è¡¨

```java
public abstract Cursor query(Uri uri, String[] projection, String selection, String[] selectionArgs, String sortOrder);
```

æ’å…¥æ•°æ®è¡¨

```java
public abstract Uri insert(Uri uri, ContentValues values);
```

åˆ é™¤æ•°æ®è¡¨

```java
public abstract int delete(Uri uri, String selection, String[] selectionArgs);
```

æ›´æ–°æ•°æ®è¡¨

```java
public abstract int update(Uri uri, ContentValues values, String selection, String[] selectionArgs);
```



## 2. ContentResolver å†…å®¹æä¾›è€…è§£æç±»

ç»Ÿä¸€ç®¡ç†ä¸åŒ `ContentProvider`é—´çš„æ“ä½œ

> 1. å³é€šè¿‡ `URI` å³å¯æ“ä½œ ä¸åŒçš„`ContentProvider` ä¸­çš„æ•°æ®
> 2. å¤–éƒ¨è¿›ç¨‹é€šè¿‡ `ContentResolver`ç±» ä»è€Œä¸`ContentProvider`ç±»è¿›è¡Œäº¤äº’

### 2.1 ä¸ºä»€ä¹ˆä¸ç›´æ¥è®¿é—®ContentProviderç±»

ä¸ºä»€ä¹ˆè¦ä½¿ç”¨é€šè¿‡`ContentResolver`ç±»ä»è€Œä¸`ContentProvider`ç±»è¿›è¡Œäº¤äº’ï¼Œè€Œä¸ç›´æ¥è®¿é—®`ContentProvider`ç±»

- ä¸€èˆ¬æ¥è¯´ï¼Œä¸€æ¬¾åº”ç”¨è¦ä½¿ç”¨å¤šä¸ª`ContentProvider`ï¼Œè‹¥éœ€è¦äº†è§£æ¯ä¸ª`ContentProvider`çš„ä¸åŒå®ç°ä»è€Œå†å®Œæˆæ•°æ®äº¤äº’ï¼Œ**æ“ä½œæˆæœ¬é«˜ã€éš¾åº¦å¤§**
- æ‰€ä»¥å†`ContentProvider`ç±»ä¸ŠåŠ å¤šäº†ä¸€ä¸ª `ContentResolver`ç±»å¯¹æ‰€æœ‰çš„`ContentProvider`è¿›è¡Œç»Ÿä¸€ç®¡ç†



å¾—åˆ°å¯¹è±¡

```java
context.getContentResolver()
```

è°ƒç”¨providerè¿›è¡Œæ•°æ®åº“CRUDæ“ä½œ

```java
insert()
delete()
update()
query()
```

<br>

### 2.2 URI è¯·æ±‚åœ°å€æ•°æ®çš„ç±»

å¾—åˆ°URIå¯¹è±¡

```java
Uri ststic parse(String uriString)
```

![image-20210415081437275](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-befo/20210415081437.png)

æ ‡å‡†URIå†™æ³•ï¼Œè¡¨ç¤ºè®¿é—®`top.iqqcode.app`è¿™ä¸ªåº”ç”¨çš„tableè¡¨ä¸­çš„æ•°æ®

```
content://top.iqqcode.app.provider/table
```

å†…å®¹URIçš„æ ¼å¼ä¸»è¦å°±åªæœ‰ä»¥ä¸Šä¸¤ç§ï¼Œä»¥è·¯å¾„ç»“å°¾å°±è¡¨ç¤ºæœŸæœ›è®¿é—®è¯¥è¡¨ä¸­æ‰€æœ‰çš„æ•°æ®ï¼Œä»¥idç»“å°¾å°±è¡¨ç¤ºæœŸæœ›è®¿é—®è¯¥è¡¨ä¸­æ‹¥æœ‰ç›¸åº”idçš„æ•°æ®ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨é€šé…ç¬¦çš„æ–¹å¼æ¥åˆ†åˆ«åŒ¹é…è¿™ä¸¤ç§æ ¼å¼çš„å†…å®¹URIï¼Œè§„åˆ™å¦‚ä¸‹ã€‚

- `*`ï¼šè¡¨ç¤ºåŒ¹é…ä»»æ„é•¿åº¦çš„ä»»æ„å­—ç¬¦
- `#`ï¼šè¡¨ç¤ºåŒ¹é…ä»»æ„é•¿åº¦çš„æ•°å­—

ä¸€ä¸ªèƒ½å¤Ÿ**åŒ¹é…ä»»æ„è¡¨çš„å†…å®¹**URIæ ¼å¼å°±å¯ä»¥å†™æˆï¼š

```java
content://com.example.app.provider/*
```

ä¸€ä¸ªèƒ½å¤Ÿ**åŒ¹é…table1è¡¨ä¸­ä»»æ„ä¸€è¡Œæ•°æ®**çš„å†…å®¹URIæ ¼å¼å°±å¯ä»¥å†™æˆï¼š

```java
content://com.example.app.provider/table1/#
```





## 3. ä¸‰ä¸ªè¾…åŠ©ContentProvideçš„å·¥å…·ç±»

### 3.1 UriMatcher-åŒ¹é…URIçš„å®¹å™¨

æ·»åŠ åˆæ³•çš„URI

```java
void addURI(String anthority, String path, int code)
```

åŒ¹é…æŒ‡å®šçš„URIï¼Œè¿”å›åŒ¹é…ç 

```java
int match(Uri uri)
```



### 3.2  ContentUris-è§£æURIçš„å·¥å…·ç±»

è§£æURIï¼Œå¾—åˆ°å­—æ®µçš„id

```java
long parseId(Uri contentUri)
```

æ·»åŠ idåˆ°æŒ‡å®šçš„URIä¸­

```java
Uri withAppendedli(Uri contentUri, long id)
```

### 3.3 ContentObserverç±»

è§‚å¯Ÿ `Uri`å¼•èµ· `ContentProvider` ä¸­çš„æ•°æ®å˜åŒ– & é€šçŸ¥å¤–ç•Œï¼ˆå³è®¿é—®è¯¥æ•°æ®è®¿é—®è€…ï¼‰

å½“`ContentProvider` ä¸­çš„æ•°æ®å‘ç”Ÿå˜åŒ–ï¼ˆå¢ã€åˆ  & æ”¹ï¼‰æ—¶ï¼Œå°±ä¼šè§¦å‘è¯¥ `ContentObserver`ç±»

å…·ä½“ä½¿ç”¨

```java
// æ­¥éª¤1ï¼šæ³¨å†Œå†…å®¹è§‚å¯Ÿè€…ContentObserver
    getContentResolver().registerContentObserverï¼ˆuriï¼‰ï¼›
    // é€šè¿‡ContentResolverç±»è¿›è¡Œæ³¨å†Œï¼Œå¹¶æŒ‡å®šéœ€è¦è§‚å¯Ÿçš„URI

// æ­¥éª¤2ï¼šå½“è¯¥URIçš„ContentProvideræ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œé€šçŸ¥å¤–ç•Œï¼ˆå³è®¿é—®è¯¥ContentProvideræ•°æ®çš„è®¿é—®è€…ï¼‰
    public class UserContentProvider extends ContentProvider { 
      public Uri insert(Uri uri, ContentValues values) { 
      db.insert("user", "userid", values); 
      getContext().getContentResolver().notifyChange(uri, null); 
      // é€šçŸ¥è®¿é—®è€…
   } 
}

// æ­¥éª¤3ï¼šè§£é™¤è§‚å¯Ÿè€…
 getContentResolver().unregisterContentObserverï¼ˆuriï¼‰ï¼›
// åŒæ ·éœ€è¦é€šè¿‡ContentResolverç±»è¿›è¡Œè§£é™¤
```

<br>

## 4. ä½¿ç”¨Provider

![40787698](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-befo/20210418153228.jpg)

**1. ç¼–å†™Contentproviderå­ç±»ï¼Œç»§æ‰¿ContentProvider**

```java
<-- 4ä¸ªæ ¸å¿ƒæ–¹æ³• -->
  // å¤–éƒ¨è¿›ç¨‹å‘ ContentProvider ä¸­æ·»åŠ æ•°æ®
  public Uri insert(Uri uri, ContentValues values) 
  
  // å¤–éƒ¨è¿›ç¨‹ åˆ é™¤ ContentProvider ä¸­çš„æ•°æ®
  public int delete(Uri uri, String selection, String[] selectionArgs) 
  
  // å¤–éƒ¨è¿›ç¨‹æ›´æ–° ContentProvider ä¸­çš„æ•°æ®
  public int update(Uri uri, ContentValues values, String selection, String[] selectionArgs)
  
 // å¤–éƒ¨åº”ç”¨ è·å– ContentProvider ä¸­çš„æ•°æ®
  public Cursor query(Uri uri, String[] projection, String selection, String[] selectionArgs,  String sortOrder)ã€€ 
```

ä¸Šè¿°4ä¸ªæ–¹æ³•ç”±å¤–éƒ¨è¿›ç¨‹å›è°ƒï¼Œå¹¶è¿è¡Œåœ¨ContentProviderè¿›ç¨‹çš„Binderçº¿ç¨‹æ± ä¸­ï¼ˆä¸æ˜¯ä¸»çº¿ç¨‹ï¼‰

å­˜åœ¨å¤šçº¿ç¨‹å¹¶å‘è®¿é—®ï¼Œéœ€è¦å®ç°çº¿ç¨‹åŒæ­¥

- a. è‹¥ContentProviderçš„æ•°æ®å­˜å‚¨æ–¹å¼æ˜¯ä½¿ç”¨SQLiteï¼Œåˆ™ä¸éœ€è¦ï¼›å› ä¸ºSQLiteå†…éƒ¨å®ç°å¥½äº†çº¿ç¨‹åŒæ­¥ï¼Œè‹¥æ˜¯å¤šä¸ªSQLiteåˆ™éœ€è¦ï¼Œå› ä¸ºSQLå¯¹è±¡ä¹‹é—´æ— æ³•è¿›è¡Œçº¿ç¨‹åŒæ­¥
- b. è‹¥ContentProviderçš„æ•°æ®å­˜å‚¨æ–¹å¼æ˜¯å†…å­˜ï¼Œåˆ™éœ€è¦è‡ªå·±å®ç°çº¿ç¨‹åŒæ­¥

```java
// ContentProvideråˆ›å»ºå æˆ– æ‰“å¼€ç³»ç»Ÿåå…¶å®ƒè¿›ç¨‹ç¬¬ä¸€æ¬¡è®¿é—®è¯¥ContentProvideræ—¶ ç”±ç³»ç»Ÿè¿›è¡Œè°ƒç”¨
// æ³¨ï¼šè¿è¡Œåœ¨ContentProviderè¿›ç¨‹çš„ä¸»çº¿ç¨‹ï¼Œæ•…ä¸èƒ½åšè€—æ—¶æ“ä½œ
public boolean onCreate() 

// å¾—åˆ°æ•°æ®ç±»å‹ï¼Œå³è¿”å›å½“å‰ Url æ‰€ä»£è¡¨æ•°æ®çš„MIMEç±»å‹
public String getType(Uri uri)
```

**queryæ–¹æ³•å‚æ•°è¯´æ˜**

```java
@Nullable
@Override
public Cursor query(@NonNull Uri uri, @Nullable String[] projection, @Nullable String selection, @Nullable String[] selectionArgs, @Nullable String sortOrder) {
    // TODO
}
```

**ã€æŸ¥è¯¢å‚æ•°å¯¹ç…§è¯´æ˜ã€‘**

| query()æ–¹æ³•å‚æ•° | å¯¹åº”SQLéƒ¨åˆ†                 | æè¿°                             |
| :-------------- | :-------------------------- | :------------------------------- |
| `uri`           | `from table_name`           | æŒ‡å®šæŸ¥è¯¢æŸä¸ªåº”ç”¨ç¨‹åºä¸‹çš„æŸä¸€å¼ è¡¨ |
| `projection`    | `select column1, column2`   | æŒ‡å®šæŸ¥è¯¢çš„åˆ—å                   |
| `selection`     | `where column = value`      | æŒ‡å®š`where` çš„çº¦æŸæ¡ä»¶           |
| `selectionArgs` | `-`                         | ä¸º`where` ä¸­çš„å ä½ç¬¦æä¾›å…·ä½“çš„å€¼ |
| `sortOrder`     | `order by column1, column2` | æŒ‡å®šæŸ¥è¯¢ç»“æœçš„æ’åºæ–¹å¼           |
SQLè¯­å¥

```sql
selece id,name,age from table where id = ? and name = ? order by ...
```

`String[] projection`  å¯¹åº” **select** åé¢æŸ¥è¯¢çš„å­—æ®µ

`String[] selectionArgs` å¯¹åº” **where** åé¢çš„æ¡ä»¶ `idã€name`ç­‰å­—æ®µæ”¾å…¥æ•°ç»„

`order by`  å¯¹åº” **sortOrder** ä¸ºæ’åºè§„åˆ™

**2. manifestä¸­æ³¨å†Œ**

- åˆ›å»ºåœ¨`<application>`èŠ‚ç‚¹ä¸‹æ·»åŠ `<provider>`å­èŠ‚ç‚¹ï¼›
- é…ç½®`android:name`å±æ€§ï¼ŒæŒ‡å®šContentProviderç±»ï¼›
- é…ç½®`android:authorities`å±æ€§ï¼ŒæŒ‡å®šç”¨äºè®¿é—®æ•°æ®çš„URIçš„hostéƒ¨åˆ†ï¼›
- é…ç½®`android:exported`å±æ€§ï¼ŒæŒ‡å®šå€¼ä¸ºtrue

```xml
<provider
    android:name="PersonProvider"
    android:authorities="top.iqqcode.contentproviderbasic.PersonProvider"
    <!-- exportedæ˜¯å¦å¯è¢«å…¶ä»–åº”ç”¨è®¿é—® -->
    android:exported="true" />
```

### 5.1 è¿›ç¨‹å†…é€šä¿¡

ã€æ­¥éª¤è¯´æ˜ã€‘

1. åˆ›å»ºæ•°æ®åº“ç±»
2. è‡ªå®šä¹‰ `ContentProvider` ç±»
3. æ³¨å†Œ åˆ›å»ºçš„ `ContentProvider`ç±»
4. è¿›ç¨‹å†…è®¿é—® `ContentProvider`çš„æ•°æ®

> **Demo app02-è¿›ç¨‹é—´é€šä¿¡**
>
> [ğŸˆapp-query](https://github.com/IQQcode/MobileCoding/tree/main/Android-Base/01-FourComponents/c-ContentProvider/ContentProviderBasic01/app02_query)
>
> [ğŸ§¨app-CRUD](https://github.com/IQQcode/MobileCoding/tree/main/Android-Base/01-FourComponents/c-ContentProvider/ContentProviderBasic01/app02_crud)

## 5.2 è¿›ç¨‹å†…é€šä¿¡

æœ¬æ–‡éœ€è¦åˆ›å»º2ä¸ªè¿›ç¨‹ï¼Œå³åˆ›å»ºä¸¤ä¸ªå·¥ç¨‹ï¼Œä½œç”¨å¦‚ä¸‹

![image-20210418154355241](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-befo/20210418154355.png)

### è¿›ç¨‹ 1

ä½¿ç”¨æ­¥éª¤å¦‚ä¸‹ï¼š

1. åˆ›å»ºæ•°æ®åº“ç±»
2. è‡ªå®šä¹‰ `ContentProvider` ç±»
3. æ³¨å†Œåˆ›å»ºçš„ `ContentProvider` ç±»

### è¿›ç¨‹2 

**æ­¥éª¤1ï¼šå£°æ˜å¯è®¿é—®çš„æƒé™**