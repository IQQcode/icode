---
title: OKHttpç®€ä»‹
date: 2021-06-17 13:39:58
permalink: /pages/3ef4b3/
categories:
  - Android
  - ç½‘ç»œæ“ä½œ
  - OKHttp
tags:
  - okhttp
  - net
---
## 1.OKHttpç®€ä»‹

### 1.1 ç®€ä»‹

OKHttpæ˜¯ä¸€æ¬¾é«˜æ•ˆçš„HTTPå®¢æˆ·ç«¯ï¼Œæ”¯æŒè¿æ¥åŒä¸€åœ°å€çš„é“¾æ¥å…±äº«åŒä¸€ä¸ªSocketï¼Œé€šè¿‡è¿æ¥æ± æ¥å‡å°å“åº”å»¶è¿Ÿï¼Œè¿˜æœ‰é€æ˜çš„GZIPå‹ç¼©ï¼Œè¯·æ±‚ç¼“å­˜ç­‰ä¼˜åŠ¿ã€‚å…¶æ ¸å¿ƒä¸»è¦æœ‰è·¯ç”±ã€è¿æ¥åè®®ã€æ‹¦æˆªå™¨ã€ä»£ç†ã€å®‰å…¨æ€§è®¤è¯ã€è¿æ¥æ± åŠç½‘ç»œé€‚é…ã€‚æ‹¦æˆªå™¨ä¸»è¦æ˜¯æŒ‡æ·»åŠ ã€æº¢å‡ºæˆ–è€…è½¬ç§»è¯·æ±‚å“åº”å¤´éƒ¨ä¿¡æ¯ç­‰æ“ä½œã€‚

OkHttp æ˜¯ä¸€ä¸ªé»˜è®¤é«˜æ•ˆçš„ HTTP å®¢æˆ·ç«¯ï¼š

- HTTP/2 æ”¯æŒå…è®¸å¯¹åŒä¸€ä¸»æœºçš„æ‰€æœ‰è¯·æ±‚å…±äº«ä¸€ä¸ªå¥—æ¥å­—ã€‚
- è¿æ¥æ± å‡å°‘äº†è¯·æ±‚å»¶è¿Ÿï¼ˆå¦‚æœ HTTP/2 ä¸å¯ç”¨ï¼‰ã€‚
- é€æ˜ GZIP å¯ç¼©å°ä¸‹è½½å¤§å°ã€‚
- å“åº”ç¼“å­˜å®Œå…¨é¿å…ç½‘ç»œé‡å¤è¯·æ±‚ã€‚

è¿™ä¸ªåº“ä¹Ÿæ˜¯squareå¼€æºçš„ä¸€ä¸ªç½‘ç»œè¯·æ±‚åº“ï¼ˆOKHttpå†…éƒ¨ä¾èµ–okio)ã€‚ç°åœ¨å·²è¢«Googleä½¿ç”¨åœ¨Androidæºç ä¸Šäº†ï¼Œå¯è§å…¶å¼ºå¤§ã€‚å…³äºç½‘ç»œè¯·æ±‚åº“ï¼Œç°åœ¨åº”è¯¥è¿˜æœ‰å¾ˆå¤šäººåœ¨ä½¿ç”¨android-async-httpã€‚ä»–å†…éƒ¨ä½¿ç”¨çš„æ˜¯HttpClientï¼Œä½†æ˜¯Googleåœ¨6.0ç‰ˆæœ¬é‡Œé¢åˆ é™¤äº†HttpClientç›¸å…³APIï¼Œå¯è§è¿™ä¸ªåº“ç°åœ¨æœ‰ç‚¹è¿‡æ—¶äº†ã€‚

> [ğŸ“«OKHttp docs](https://square.github.io/okhttp/)

**OKHttpä¸»è¦åŠŸèƒ½**

1. è”ç½‘è¯·æ±‚æ–‡æœ¬æ•°æ®
2. å¤§æ–‡ä»¶ä¸‹è½½
3. å¤§æ–‡ä»¶ä¸Šä¼ 
4. è¯·æ±‚å›¾ç‰‡

é¿å…åœ¨ä¸»çº¿ç¨‹ä¸­æ›´æ–°UI

> android.os.NetworkOnMainThreadException

![image-20210611144031438](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-befo/20210611144031.png)

<br>

### 1.2 åŒæ­¥è¯·æ±‚å’Œå¼‚æ­¥è¯·æ±‚

**åŒæ­¥è¯·æ±‚çš„åŸç†**

> å½“æµè§ˆå™¨å‘æœåŠ¡å™¨å‘é€åŒæ­¥è¯·æ±‚æ—¶ï¼ŒæœåŠ¡å¤„ç†åŒæ­¥è¯·æ±‚çš„è¿‡ç¨‹ä¸­ï¼Œæµè§ˆå™¨ä¼šå¤„äºç­‰å¾…çš„çŠ¶æ€ï¼ŒæœåŠ¡å™¨å¤„ç†å®Œè¯·æ±‚**æŠŠæ•°æ®å“åº”ç»™æµè§ˆå™¨å¹¶è¦†ç›–æµè§ˆå™¨å†…å­˜ä¸­åŸæœ‰çš„æ•°æ®**ï¼Œæµè§ˆå™¨â€”â€”**é‡æ–°åŠ è½½é¡µé¢å¹¶å±•ç¤ºæœåŠ¡å™¨å“åº”çš„æ•°æ®**ã€‚

**å¼‚æ­¥è¯·æ±‚çš„åŸç†**

> æµè§ˆå™¨æŠŠè¯·æ±‚äº¤ç»™**ä»£ç†å¯¹è±¡**â€”XMLHttpRequestï¼ˆç»å¤§å¤šæ•°æµè§ˆå™¨éƒ½å†…ç½®äº†è¿™ä¸ªå¯¹è±¡ï¼‰ï¼Œ**ç”±ä»£ç†å¯¹è±¡å‘æœåŠ¡å™¨å‘èµ·è¯·æ±‚ï¼Œæ¥æ”¶ã€è§£ææœåŠ¡å™¨å“åº”çš„æ•°æ®**ï¼Œå¹¶æŠŠæ•°æ®æ›´æ–°åˆ°æµè§ˆå™¨æŒ‡å®šçš„æ§ä»¶ä¸Šã€‚ä»è€Œå®ç°äº†é¡µé¢æ•°æ®çš„å±€éƒ¨åˆ·æ–°ã€‚

![preview](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-befo/20210612164708.jpeg)

<br>

## 2. Socketè¿æ¥æ± å¤ç”¨ 

 æ¯æ¬¡å»ºç«‹è¿æ¥å…³é—­éƒ½è¦ä¸‰æ¬¡æ¡æ‰‹å››æ¬¡æŒ¥æ‰‹ï¼Œæ˜¾ç„¶ä¼šé€ æˆæ•ˆç‡ä½ä¸‹ï¼ŒHttpåè®®ä¸­çš„KeepAliveæœºåˆ¶åœ¨ä¼ è¾“æ•°æ®åä»ç„¶ä¿æŒè¿æ¥çŠ¶æ€ï¼Œå½“å®¢æˆ·ç«¯éœ€è¦å†æ¬¡ä¼ è¾“æ•°æ®æ—¶ï¼Œç›´æ¥ä½¿ç”¨ç©ºé—²ä¸‹æ¥çš„è¿æ¥è€Œä¸éœ€è¦é‡æ–°å»ºç«‹è¿æ¥ã€‚

**OkHttpé»˜è®¤æ”¯æŒä¸ªå¹¶å‘KeepAliveï¼Œé“¾è·¯é»˜è®¤çš„å­˜æ´»æ—¶é—´ä¸º5åˆ†é’Ÿ**

![image-20210613093751222](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-befo/20210613093751.png)

<br>

## 3. ç®€å•ä½¿ç”¨

### 3.1 ä½¿ç”¨æ­¥éª¤

**1. è·å–OKHttpClientå¯¹è±¡**

```java
OkHttpClient client = new OkHttpClient.Builder()
                .connectTimeout(8000, TimeUnit.MILLISECONDS)
                .build();
```

**2. å¡«å†™è¡¨å•æ•°æ®ï¼ˆåªé’ˆå¯¹POSTè¯·æ±‚ï¼ŒGETè¯·æ±‚ç•¥è¿‡ï¼‰**

```java
// æ™®é€šè¡¨å•
FormBody formBody = FormBody.Builder()
            .add("page", "1")
            .add("count", "2")
            .add("type", "video")
            .build()

    
// JSONæ–¹å¼è¯·æ±‚
Map map = new HashMap();
        map.put("mobile", "demoData");
        map.put("password", "demoData");
        JSONObject jsonObject = new JSONObject(map);
        String jsonStr = jsonObject.toString();
        RequestBody requestBodyJson = RequestBody.create(MediaType.parse("application/json;charset=utf-8"), jsonStr);
```

**3. æ„å»ºRequestå¯¹è±¡**

```java
Request request = new Request.Builder()
                .url("http://192.168.31.32:8080/renren-fast/app/login") // å¯ä»¥æ‹¼æ¥å‚æ•°
                .addHeader("contentType", "application/json;charset=UTF-8")
                .post(requestBodyJson)
                .build();
```

**4. æ„å»ºCallcallå›è°ƒå¯¹è±¡**

```java
final Call call = client.newCall(request);
```

**5. å‘èµ·åŒæ­¥è¯·æ±‚(åŒæ­¥/å¼‚æ­¥)**

OkHttpClient æ˜¯è¿æ¥å¯¹è±¡ï¼Œæ— è®ºæ˜¯ä»€ä¹ˆè¯·æ±‚ï¼Œä½¿ç”¨OKHttpéƒ½å¿…é¡»è¦åˆ›å»ºè¿™ä¸ªå¯¹è±¡ã€‚

- Request æ˜¯è¯·æ±‚å¯¹è±¡çš„å‚æ•°ï¼Œé‡Œé¢éœ€è¦æ”¾ç½®å„ç§è¯·æ±‚ä¿¡æ¯ã€‚
- `enqueue()` æ˜¯ä½¿ç”¨å¼‚æ­¥è¯·æ±‚æ–¹æ³•ã€‚

```java
        // ç¬¬å››æ­¥:å¼‚æ­¥getè¯·æ±‚
        call.enqueue(new Callback() {
            /**
             * è¯·æ±‚å¤±è´¥
             * @param call
             * @param e
             */
            @Override
            public void onFailure(Call call, IOException e) {
                Log.i("TAG", e.getMessage());
            }

            /**
             * è¯·æ±‚æˆåŠŸ
             * @param call
             * @param response
             * @throws IOException
             */
            @Override
            public void onResponse(Call call, Response response) throws IOException {
                // å¾—åˆ°çš„å­çº¿ç¨‹
                String result = response.body().string();
                Log.e("TAG", result);
                tvRes.setText(result);
            }
        });
    }
```



<br>

### 3.2 åŒæ­¥è¯·æ±‚

åŒæ­¥è¯·æ±‚åœ¨Androidå¼€å‘ä¸­ä¸æ˜¯å¾ˆå¸¸ç”¨ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸­æ˜¯ä¸èƒ½è¿›è¡Œç½‘ç»œè¯·æ±‚çš„æ‰€ä»¥æˆ‘ä»¬è¿™ä¸ªè¦å¼€ä¸€ä¸ªå­çº¿ç¨‹è¿›è¡ŒåŒæ­¥è¯·æ±‚ã€‚ä½¿ç”¨åŒæ­¥è¯·æ±‚çš„æ˜¯éœ€è¦è°ƒç”¨`execute()`æ–¹æ³•ï¼Œ**Response**æ¥æ”¶è¿”å›çš„å¯¹è±¡ã€‚

**åŒæ­¥å’Œå¼‚æ­¥è¯·æ±‚åªæ˜¯æœ€åä¸€æ­¥çš„è¯·æ±‚çš„æ–¹æ³•ä¸åŒè€Œå·²ã€‚**

> ä½¿ç”¨åŠç¤ºä¾‹ä»£ç å‡ä¸ºKotlin

#### GETåŒæ­¥è¯·æ±‚

```kotlin
/**
 * åŒæ­¥è¯·æ±‚
 * ä½¿ç”¨åŒæ­¥è¯·æ±‚çš„æ˜¯éœ€è¦è°ƒç”¨execute()æ–¹æ³•ï¼ŒResponseæ¥æ”¶è¿”å›çš„å¯¹è±¡ã€‚
 * åŒæ­¥å’Œå¼‚æ­¥è¯·æ±‚åªæ˜¯æœ€åä¸€æ­¥çš„è¯·æ±‚çš„æ–¹æ³•ä¸åŒè€Œå·²ã€‚
 */
private fun syncRequestByGet() {
    val urlString = "http://apis.juhe.cn/fapig/euro2020/schedule" // è¯·æ±‚åœ°å€
    val urlParameter = "type=2&key=828f26861263cc47c50c36a0985aff93"
    
    // ç¬¬ä¸€æ­¥è·å–okHttpClientå¯¹è±¡
    val client: OkHttpClient = OkHttpClient.Builder()
        .connectTimeout(8000, TimeUnit.MILLISECONDS)
        .build()
    
    // ç¬¬äºŒæ­¥æ„å»ºRequestå¯¹è±¡
    val request: Request = Request.Builder()
        .url("$urlString?$urlParameter") // å¯ä»¥ååŠ è¯·æ±‚å‚æ•° url + str
        .get() // é»˜è®¤å°±æ˜¯GETè¯·æ±‚ï¼Œå¯ä»¥ä¸å†™
        .build()
    
    // ç¬¬ä¸‰æ­¥æ„å»ºCallå¯¹è±¡
    val call: Call = client.newCall(request)
    
    // å‘èµ·åŒæ­¥è¯·æ±‚(åŒæ­¥/å¼‚æ­¥)
    Thread {
        try {
            val response = call.execute() // æäº¤å¹¶ä¸”æ¥æ”¶è¿”å›æ•°æ®
            val resultData = response.body!!.string()
            Log.i(TAG, "requestByGet: $resultData")
            // æ›´æ–°UI
            runOnUiThread {
                binding.mTextViewContext.text = resultData
            }
        } catch (e: IOException) {
            e.printStackTrace()
        }
    }.start()
}
```

é¦–å…ˆï¼Œåˆ›å»ºäº†OkHttpClientå®ä¾‹ï¼Œæ¥ç€ç”¨Request.Builderæ„å»ºäº†Requestå®ä¾‹å¹¶ä¼ å…¥äº†URLï¼Œç„¶å`httpClient.newCall`æ–¹æ³•ä¼ å…¥Requestå®ä¾‹ç”Ÿæˆcallï¼Œæœ€ååœ¨å­çº¿ç¨‹è°ƒç”¨call.execute()æ‰§è¡Œè¯·æ±‚è·å¾—ç»“æœresponseã€‚

#### POSTåŒæ­¥è¯·æ±‚

```kotlin
/**
 * POSTåŒæ­¥è¯·æ±‚
 */
private fun syncRequestByPost() {
    val client: OkHttpClient = OkHttpClient.Builder()
        .connectTimeout(8000, TimeUnit.MILLISECONDS)
        .build()
    
    val formBody: RequestBody = FormBody.Builder()
        .add("page", "1")
        .add("count", "2")
        .add("type", "video")
        .build()
    
    val request: Request = Request.Builder()
        .url("https://api.apiopen.top/getJoke")
        .post(formBody)
        .build()
    
    val call: Call = client.newCall(request)
    
    Thread {
        try {
            val response = call.execute() // æäº¤å¹¶ä¸”æ¥æ”¶è¿”å›æ•°æ®
            val resultData = response.body!!.string()
            // æ›´æ–°UI
            runOnUiThread {
                binding.mTextViewContext.text = resultData
            }
        } catch (e: Exception) {
            Toast.makeText(this@MainActivity, "å¼‚å¸¸", Toast.LENGTH_SHORT).show()
            e.printStackTrace()
        }
    }.start()
}
```

è¿™æ˜¯å› ä¸º`call.execute()`æ˜¯åŒæ­¥æ–¹æ³•ã€‚

æƒ³è¦åœ¨ä¸»çº¿ç¨‹ç›´æ¥ä½¿ç”¨è€Œä¸ç”¨æ‰‹åŠ¨åˆ›å»ºå­çº¿ç¨‹å¯ä»¥å˜›ï¼Ÿå½“ç„¶å¯ä»¥ï¼Œä½¿ç”¨`call.enqueue(callback)`å³å¯

### 3.3 Getå¼‚æ­¥è¯·æ±‚

> å…¶ä»–è¯·æ±‚æ–¹å¼åƒputã€headerã€deleteï¼Œä¸»è¦åœ¨æ„å»ºRequestæ—¶æŠŠget()æˆ–post()æ¢æˆput()ã€header()ã€delete()å°±å¯ä»¥äº†ï¼Œä½†ä¸€èˆ¬åœ¨Androidç«¯å¾ˆå°‘ç”¨åˆ°ã€‚

```kotlin
/**
 * Getå¼‚æ­¥è¯·æ±‚(ä¸éœ€è¦æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹)
 */
private fun asyncRequestByGet() {
    val client: OkHttpClient = OkHttpClient.Builder()
        .connectTimeout(8000, TimeUnit.MILLISECONDS)
        .build()
    
    val request: Request = Request.Builder()
        .url("https://api.apiopen.top/getJoke?page=1&count=2&type=video") // å¯ä»¥ååŠ è¯·æ±‚å‚æ•° url + str
        .get()
        .build()
    
    client.newCall(request).enqueue(object : Callback {
        override fun onFailure(call: Call, e: java.io.IOException) {
            Log.i("TAG", e.message!!)
        }
        
        @Throws(java.io.IOException::class)
        override fun onResponse(call: Call, response: Response) {
            val resultData = response.body!!.string()
            Log.i("TAG", resultData)
            runOnUiThread {
                binding.mTextViewContext.text = resultData
            }
        }
    })
}
```

`call.enqueue`ä¼šå¼‚æ­¥æ‰§è¡Œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸¤ä¸ªå›è°ƒæ–¹æ³•`onFailure`ã€`onResponse`æ˜¯æ‰§è¡Œåœ¨å­çº¿ç¨‹çš„ï¼Œæ‰€ä»¥å¦‚æœæƒ³è¦æ‰§è¡ŒUIæ“ä½œï¼Œéœ€è¦ä½¿ç”¨Handleråˆ‡æ¢åˆ°UIçº¿ç¨‹ã€‚

### 3.4 Postå¼‚æ­¥è¯·æ±‚

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨Postè¯·æ±‚ï¼Œå’Œä¸Šé¢Getè¯·æ±‚ç”¨çš„URLæ˜¯ä¸€æ ·çš„ã€‚ä¸åŒçš„æ˜¯ç”¨Postè¯·æ±‚éœ€è¦ä½¿ç”¨**RequestBody**è¿™ä¸ªå¯¹è±¡ï¼Œç”¨add()æ–¹æ³•ï¼Œæ·»åŠ æˆ‘ä»¬çš„è¯·æ±‚å‚æ•°ã€‚

```kotlin
/**
 * Postå¼‚æ­¥è¯·æ±‚
 * @throws java
 */
private fun asyncRequestByPost() {
    val urlStr = "https://api.apiopen.top/getJoke"
    val client: OkHttpClient = OkHttpClient.Builder()
        .connectTimeout(8000, TimeUnit.MILLISECONDS)
        .build()
    
    // è¡¨å•æ•°æ®
    val formBody = FormBody.Builder()
        .add("page", "1")
        .add("count", "2")
        .add("type", "video")
        .build()
    
    val request: Request = Request.Builder()
        .url(urlStr)
        .post(formBody)
        .build()
    
    client.newCall(request).enqueue(object : Callback {
        override fun onFailure(call: Call, e: java.io.IOException) {
            Log.i("TAG", e.message!!)
        }
        
        @Throws(java.io.IOException::class)
        override fun onResponse(call: Call, response: Response) {
            val resultData = response.body!!.string()
            Log.e("TAG", resultData)
            runOnUiThread {
                binding.mTextViewContext.text = resultData
            }
        }
    })
}
```

**postè¯·æ±‚æäº¤è¡¨å•**

æ„å»ºRequestBodyé™¤äº†ä¸Šé¢çš„æ–¹å¼ï¼Œè¿˜æœ‰å®ƒçš„å­ç±»FormBodyï¼ŒFormBodyç”¨äºæäº¤è¡¨å•é”®å€¼å¯¹ï¼Œè¿™ç§èƒ½æ»¡è¶³å¹³å¸¸å¼€å‘å¤§éƒ¨åˆ†çš„éœ€æ±‚ã€‚

```javascript
//RequestBody:FormBodyï¼Œè¡¨å•é”®å€¼å¯¹
RequestBody formBody = new FormBody.Builder()
        .add("username", "iqqcode")
        .add("password", "123456")
        .build();
```

FormBodyæ˜¯é€šè¿‡FormBody.Builderç”¨æ„å»ºè€…æ¨¡å¼åˆ›å»ºï¼Œaddé”®å€¼å¯¹å³å¯ã€‚å®ƒçš„contentTypeåœ¨å†…éƒ¨å·²ç»æŒ‡å®šäº†ã€‚

```javascript
  private static final MediaType CONTENT_TYPE = MediaType.get("application/x-www-form-urlencod
```

<br>

### 3.5 POSTè¯·æ±‚æäº¤å¤æ‚è¯·æ±‚ä½“

RequestBodyå¦ä¸€ä¸ªå­ç±»MultipartBodyï¼Œç”¨äºpostè¯·æ±‚æäº¤å¤æ‚ç±»å‹çš„è¯·æ±‚ä½“ã€‚å¤æ‚è¯·æ±‚ä½“å¯ä»¥åŒæ—¶åŒ…å«å¤šç§ç±»å‹çš„çš„è¯·æ±‚ä½“æ•°æ®ã€‚

postè¯·æ±‚ stringã€æ–‡ä»¶ã€è¡¨å•ï¼Œåªæœ‰å•ä¸€ç±»å‹ã€‚è€ƒè™‘ä¸€ç§åœºæ™¯--æ³¨å†Œåœºæ™¯ï¼Œç”¨æˆ·å¡«å†™å®Œå§“åã€ç”µè¯ï¼ŒåŒæ—¶è¦ä¸Šä¼ å¤´åƒå›¾ç‰‡ï¼Œè¿™æ—¶æ³¨å†Œæ¥å£çš„è¯·æ±‚ä½“å°±éœ€è¦ æ¥å— è¡¨å•é”®å€¼å¯¹ ä»¥åŠæ–‡ä»¶äº†ï¼Œé‚£ä¹ˆå‰é¢çš„çš„postå°±æ— æ³•æ»¡è¶³äº†ã€‚é‚£ä¹ˆå°±è¦ç”¨åˆ°MultipartBodyäº†ã€‚ å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```java
OkHttpClient httpClient = new OkHttpClient();

//        MediaType contentType = MediaType.parse("text/x-markdown; charset=utf-8");
//        String content = "hello!";
//        RequestBody body = RequestBody.create(contentType, content);

        //RequestBody:fileBody,ä¸Šä¼ æ–‡ä»¶
        File file = drawableToFile(this, R.mipmap.bigpic, new File("00.jpg"));
        RequestBody fileBody = RequestBody.create(MediaType.parse("image/jpg"), file);


        //RequestBody:multipartBody, å¤šç±»å‹ ï¼ˆç”¨æˆ·åã€å¯†ç ã€å¤´åƒï¼‰
        MultipartBody multipartBody = new MultipartBody.Builder()
                .setType(MultipartBody.FORM)
                .addFormDataPart("username", "hufeiyang")
                .addFormDataPart("phone", "123456")
                .addFormDataPart("touxiang", "00.png", fileBody)
                .build();


        Request getRequest = new Request.Builder()
                .url("http://yun918.cn/study/public/file_upload.php")
                .post(multipartBody)
                .build();

        Call call = httpClient.newCall(getRequest);

        call.enqueue(new Callback() {
            @Override
            public void onFailure(Call call, IOException e) {

                Log.i(TAG, "okHttpPost enqueue: \n onFailure:"+ call.request().toString() +"\n body:" +call.request().body().contentType()
                +"\n IOException:"+e.getMessage());
            }

            @Override
            public void onResponse(Call call, Response response) throws IOException {
                Log.i(TAG, "okHttpPost enqueue: \n onResponse:"+ response.toString() +"\n body:" +response.body().string());
            }
        });
```

å¯è§ï¼Œåœ¨æ„å»ºRequestBodyæ—¶æ˜¯ä½¿ç”¨MultipartBody.Builderæ„å»ºäº†MultipartBodyå®ä¾‹ï¼Œé€šè¿‡addFormDataPartæ–¹æ³•ä¼ å…¥äº†å§“åã€ç”µè¯çš„é”®å€¼å¯¹ï¼Œä¹Ÿé€šè¿‡addFormDataPart("touxiang", "00.png", fileBody)ä¼ å…¥äº†å¤´åƒå›¾ç‰‡ï¼Œå…¶ä¸­"touxiang"æ˜¯keyå€¼ï¼Œ "00.png"æ˜¯æ–‡ä»¶åï¼ŒfileBodyæ˜¯è¦ä»¥ä¸Šä¼ çš„å›¾ç‰‡åˆ›å»ºçš„RequestBodyã€‚ å› ä¸ºæ‰€æœ‰æ•°æ®éƒ½æ˜¯ä»¥é”®å€¼å¯¹çš„è¡¨å•å½¢å¼æäº¤ï¼Œæ‰€ä»¥è¦è®¾ç½®setType(MultipartBody.FORM)ã€‚

<br>

### 3.6 å–æ¶ˆè¯·æ±‚

æ¯ä¸€ä¸ªCallåªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼ˆåŸå› ä¼šåœ¨ä¸‹ç¯‡æµç¨‹åˆ†æä¸­è¯´æ˜ï¼‰ã€‚å¦‚æœæƒ³è¦å–æ¶ˆæ­£åœ¨æ‰§è¡Œçš„è¯·æ±‚ï¼Œå¯ä»¥ä½¿ç”¨**call.cancel()**ï¼Œé€šå¸¸åœ¨ç¦»å¼€é¡µé¢æ—¶éƒ½è¦å–æ¶ˆæ‰§è¡Œçš„è¯·æ±‚çš„ã€‚

<br>

### 3.7 ç»“æœå¤„ç†

è¯·æ±‚å›è°ƒçš„ä¸¤ä¸ªæ–¹æ³•æ˜¯æŒ‡ ä¼ è¾“å±‚ çš„å¤±è´¥å’ŒæˆåŠŸã€‚

- onFailureé€šå¸¸æ˜¯connectionè¿æ¥å¤±è´¥æˆ–è¯»å†™è¶…æ—¶ï¼›
- onResponseæ˜¯æŒ‡ï¼ŒæˆåŠŸçš„ä»æœåŠ¡å™¨è·å–åˆ°äº†ç»“æœï¼Œä½†æ˜¯è¿™ä¸ªç»“æœçš„å“åº”ç å¯èƒ½æ˜¯404ã€500ç­‰ï¼Œä¹Ÿå¯èƒ½å°±æ˜¯200ï¼ˆresponse.code()çš„å–å€¼ï¼‰ã€‚
- å¦‚æœresponse.code()æ˜¯200ï¼Œè¡¨ç¤ºåº”ç”¨å±‚è¯·æ±‚æˆåŠŸäº†ã€‚

æ­¤æ—¶æˆ‘ä»¬å¯ä»¥è·å–Responseçš„ResponseBodyï¼Œè¿™æ˜¯å“åº”ä½“ã€‚ä»é¢çœ‹åˆ°ï¼Œå¯ä»¥ä»ResponseBodyè·å–stringã€byte[]ã€InputStreamï¼Œè¿™æ ·å°±å¯ä»¥å¯¹ç»“æœè¿›è¡Œå¾ˆå¤šæ“ä½œäº†ï¼Œæ¯”å¦‚UIä¸Šå±•ç¤ºstringï¼ˆè¦ç”¨Handleråˆ‡æ¢åˆ°UIçº¿ç¨‹ï¼‰ã€é€šè¿‡InputStreamå†™å…¥æ–‡ä»¶ç­‰ç­‰ã€‚

----------------------

> [ğŸ”—å®Œæ•´ä»£ç åŠDemoç¤ºä¾‹-Gihub okhttp02 module](https://github.com/IQQcode/MobileCoding/blob/main/Android-Base/05-Network/BaseNet/01BaseDemo/okhttp02/src/main/java/top/iqqcode/okhttp02/MainActivity.kt)

<br>

## 4. è¯·æ±‚é…ç½®é¡¹

1. å¦‚ä½•å…¨å±€è®¾ç½®è¶…æ—¶æ—¶é•¿?
2. ç¼“å­˜ä½ç½®ã€æœ€å¤§ç¼“å­˜å¤§å° å‘¢ï¼Ÿ
3. è€ƒè™‘æœ‰è¿™æ ·ä¸€ä¸ªéœ€æ±‚ï¼Œæˆ‘è¦ç›‘æ§Appé€šè¿‡ OkHttp å‘å‡ºçš„ æ‰€æœ‰ åŸå§‹è¯·æ±‚ï¼Œä»¥åŠæ•´ä¸ªè¯·æ±‚æ‰€è€—è´¹çš„æ—¶é—´ï¼Œå¦‚ä½•åšï¼Ÿ

è¿™äº›é—®é¢˜ï¼Œåœ¨OkHttpè¿™é‡Œå¾ˆç®€å•ã€‚æŠŠOkHttpClientå®ä¾‹çš„åˆ›å»ºï¼Œæ¢æˆä»¥ä¸‹æ–¹å¼å³å¯ï¼š

```java
OkHttpClient client = new OkHttpClient.Builder()
     .connectTimeout(15, TimeUnit.SECONDS) // è¿æ¥æ—¶é•¿
     .readTimeout(10, TimeUnit.SECONDS)    // è¯»å–æ—¶é•¿
     .writeTimeout(10, TimeUnit.SECONDS)   // å†™å…¥æ—¶é•¿
     .cache(new Cache(getExternalCacheDir(),500 * 1024 * 1024))
     .addInterceptor(new Interceptor() {
         @Override
         public Response intercept(Chain chain) throws IOException {
             Request request = chain.request();
             String url = request.url().toString();
             Log.i(TAG, "intercept: proceed start: url"+ url+ ", at "+System.currentTimeMillis());
             Response response = chain.proceed(request);
             ResponseBody body = response.body();
             Log.i(TAG, "intercept: proceed end: url"+ url+ ", at "+System.currentTimeMillis());
             return response;
         }
     })
     .build();
```

è¿™é‡Œé€šè¿‡OkHttpClient.Builderé€šè¿‡æ„å»ºè€…æ¨¡å¼è®¾ç½®äº†è¿æ¥ã€è¯»å–ã€å†™å…¥çš„è¶…æ—¶æ—¶é•¿ï¼Œç”¨cache()æ–¹æ³•ä¼ å…¥äº†ç”±ç¼“å­˜ç›®å½•ã€ç¼“å­˜å¤§å°æ„æˆçš„Cacheå®ä¾‹ï¼Œè¿™æ ·å°±è§£å†³äº†å‰ä¸¤ä¸ªé—®é¢˜ã€‚

è¿˜æ³¨æ„åˆ°ï¼Œä½¿ç”¨addInterceptor()æ–¹æ³•æ·»åŠ äº†Interceptorå®ä¾‹ï¼Œä¸”é‡å†™äº†interceptæ–¹æ³•ã€‚Interceptoræ„ä¸ºæ‹¦æˆªå™¨ï¼Œintercept()æ–¹æ³•ä¼šåœ¨å¼€å§‹æ‰§è¡Œè¯·æ±‚æ—¶è°ƒç”¨ã€‚å…¶ä¸­chain.proceed(request)å†…éƒ¨æ˜¯çœŸæ­£è¯·æ±‚çš„è¿‡ç¨‹ï¼Œæ˜¯é˜»å¡æ“ä½œï¼Œæ‰§è¡Œå®Œåä¼šå°±ä¼šå¾—åˆ°è¯·æ±‚ç»“æœResponseBodyï¼Œæ‰€ä»¥chain.proceed(request)çš„å‰åå–å½“å‰æ—¶é—´ï¼Œé‚£ä¹ˆå°±çŸ¥é“æ•´ä¸ªè¯·æ±‚æ‰€è€—è´¹çš„æ—¶é—´ã€‚ä¸Šé¢chain.proceed(request)çš„å‰ååˆ†åˆ«æ‰“å°çš„æ—¥å¿—å’Œæ—¶é—´ï¼Œè¿™æ ·ç¬¬ä¸‰ä¸ªé—®é¢˜ä¹Ÿè§£å†³äº†ã€‚

>  å¦å¤–ï¼Œ**é€šå¸¸OkHttpClientå®ä¾‹æ˜¯å…¨å±€å”¯ä¸€çš„**ï¼Œè¿™æ ·è¿™äº›åŸºæœ¬é…ç½®å°±æ˜¯ç»Ÿä¸€ï¼Œä¸”å†…éƒ¨ç»´æŠ¤çš„è¿æ¥æ± ä¹Ÿå¯ä»¥æœ‰æ•ˆå¤ç”¨ã€‚

å…¨å±€é…ç½®çš„æœ‰äº†ï¼Œå•ä¸ªè¯·æ±‚çš„ä¹Ÿå¯ä»¥æœ‰ä¸€äº›å•ç‹¬çš„é…ç½®ã€‚

```javascript
Request getRequest = new Request.Builder()
    .url("http://yun918.cn/study/public/file_upload.php")
    .post(multipartBody)
    .addHeader("key","value")
    .cacheControl(CacheControl.FORCE_NETWORK)
    .build();
```

è¿™ä¸ªRequestå®ä¾‹ï¼š

- ä½¿ç”¨addHeader()æ–¹æ³•æ·»åŠ äº†è¯·æ±‚å¤´ã€‚
- ä½¿ç”¨cacheControl(CacheControl.FORCE_NETWORK)è®¾ç½®æ­¤æ¬¡è¯·æ±‚æ˜¯èƒ½ä½¿ç”¨ç½‘ç»œï¼Œä¸ç”¨ç¼“å­˜ã€‚ï¼ˆè¿˜å¯ä»¥è®¾ç½®åªç”¨ç¼“å­˜FORCE_CACHEã€‚ï¼‰

<br>

## 5. æ‹¦æˆªå™¨

**æ‹¦æˆªå™¨çš„ä½¿ç”¨**

æ‹¦æˆªå™¨åˆ›å»ºï¼š

```kotlin
class LogIntercept : Interceptor {

    override fun intercept(chain: Interceptor.Chain): Response {
        val request = chain.request()
        val response = chain.proceed(request)
        val currentTime = System.currentTimeMillis()
        Log.i("ICP", "intercept: ===> REQUEST = $request")
        Log.i("ICP", "intercept: ===> RESPONSE = $response")
        Log.i("ICP", "intercept: ===> è€—æ—¶${System.currentTimeMillis() -  currentTime}ms")
        return response
    }
}
```

åœ¨åˆ›å»ºå®ä¾‹æ—¶æ·»åŠ æ‹¦æˆªï¼š

```kotlin
val client: OkHttpClient = OkHttpClient.Builder()
    .connectTimeout(8000, TimeUnit.MILLISECONDS)
    .addInterceptor(LogIntercept()) // æ·»åŠ æ‹¦æˆªå™¨
    .build()
```

![image-20210613090413879](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-befo/20210613090415.png)
