---
title: Handlerç®€ä»‹
date: 2021-06-17 13:49:24
permalink: /pages/c5ea81/
categories:
  - Android
  - å¼‚æ­¥æœºåˆ¶
  - Handleré€šä¿¡
tags:
  - handler
---
ã€çŸ¥è¯†ç‚¹ã€‘

- Handleræ˜¯ä»€ä¹ˆ
- ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Handler
- Handler / Looper / MessageQueue / Messageåˆ†åˆ«æ˜¯åšä»€ä¹ˆçš„
- Handlerå¦‚ä½•å»å®ç°
- å·¥ä½œåŸç†
- å¦‚ä½•æ›´å¥½çš„ä½¿ç”¨
- æ‰©å±•åŠæ€»ç»“

-------------------

## 1. Handlerä»‹ç»

åœ¨Androidå¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šä½¿ç”¨å•ç‹¬çš„çº¿ç¨‹æ¥å®ŒæˆæŸäº›æ“ä½œï¼Œæ¯”å¦‚ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥å®Œæˆä»ç½‘ç»œä¸Šä¸‹è½½å›¾ç‰‡ï¼Œç„¶åæ˜¾ç¤ºåœ¨ä¸€ä¸ª
ImageViewä¸Šï¼Œåœ¨å¤šçº¿ç¨‹æ“ä½œæ—¶ï¼ŒAndroidä¸­å¿…é¡»ä¿è¯ä»¥ä¸‹ä¸¤ç‚¹ï¼š

1. ä¸è¦é˜»å¡UIçº¿ç¨‹
2. ä¸è¦åœ¨UIçº¿ç¨‹ä¹‹å¤–æ›´æ–°UI

> ç±»æ¯”ç”Ÿæ´»ä¸­çš„æ¡ˆä¾‹ï¼Œå·¥ä½œçº¿ç¨‹ï¼ˆå­çº¿ç¨‹ï¼‰å’Œ ä¸»çº¿ç¨‹ï¼ˆUIçº¿ç¨‹ï¼‰æ˜¯ä¸¤ä¸ªä¸åŒçš„è§’è‰²ï¼Œæ›´æ–°UIæ“ä½œç”±ä¸»çº¿ç¨‹æ¥è´Ÿè´£ï¼›å·¥ä½œçº¿ç¨‹åªèƒ½æ˜¯**å»ºè®®**ä¸»çº¿ç¨‹å‘ç”Ÿæ›´æ”¹ï¼Œä¸»çº¿ç¨‹æ”¶åˆ°å»ºè®®ååšæ›´æ–°ä¿®æ”¹ï¼Œä½†æ˜¯å®ƒæ²¡æœ‰æƒåˆ©è¶Šä¿ä»£åº–è‡ªå·±å»ä¿®æ”¹æ›´æ–°ä¸»çº¿ç¨‹å†…å®¹ã€‚

æœ‰äº†ä»¥ä¸Šä¸¤ç‚¹é™åˆ¶ï¼Œæˆ‘ä»¬åœ¨çº¿ç¨‹ä¹‹é—´çš„æ¶ˆæ¯å¦‚ä½•è¿›è¡Œä¼ é€’å‘¢ï¼Ÿ

Handlerç™»åœºï¼ŒHandlerä½œä¸ºæ¶ˆæ¯çš„å¤„ç†è€…ï¼Œä¸»è¦è´Ÿè´£ï¼š

- **å®šæ—¶ä»»åŠ¡**ï¼šæ¶ˆæ¯è°ƒåº¦å’Œåœ¨å°†æ¥æŸä¸€æ—¶é—´å¸¦ä½ æ‰§è¡Œä¸€ä¸ªRunnable
- **çº¿ç¨‹ä¹‹é—´æ¶ˆæ¯çš„å¤„ç†**ï¼šå¤šä¸ªä»»åŠ¡åŠ å…¥åˆ°ä¸€ä¸ªé˜Ÿåˆ—ä¸­æ‰§è¡Œ

<br>


## 2. Handler API

Handleræ˜¯Messageçš„å¤„ç†å™¨ï¼Œ**è´Ÿè´£æ¶ˆæ¯çš„å‘é€å’Œç§»é™¤**

> å³æ—¶æ¶ˆæ¯å’Œå»¶è¿Ÿæ¶ˆæ¯éƒ½ä¼šç«‹å³è¢«å‘é€å‡ºå»ï¼Œåªæ˜¯å»¶è¿Ÿæ¶ˆæ¯æ˜¯å»¶è¿Ÿä¸€å®šæ—¶é—´åšå¤„ç†ï¼ˆ**å¹¶ä¸æ˜¯å»¶è¿Ÿå‘é€ï¼Œæ˜¯å»¶è¿Ÿå¤„ç†**ï¼‰

- å‘é€å³æ—¶æ¶ˆæ¯ï¼š`sendMessage(Message msg)`
- å‘é€å»¶è¿Ÿæ¶ˆæ¯ï¼š`sendMessgaeDelayed(Message msg, long time)`
- å¤„ç†æ¶ˆæ¯ï¼š`handleMessage(Message msg)` å›è°ƒæ–¹æ³•
- ç§»é™¤è¿˜æœªå¤„ç†çš„æ¶ˆæ¯ï¼š`removeMessage(int what)`

```kotlin
thread(start = true) {
    Log.d(TAG,"running from sub-thread(): ${Thread.currentThread()}")
    // å­çº¿ç¨‹ä¸­å‘é€æ¶ˆæ¯,é€šçŸ¥UIæ›´æ–°
    handler.sendEmptyMessage(1001) // å‘é€ç©ºæ¶ˆæ¯
    val msg = handler.obtainMessage() // è·å–æ¶ˆæ¯å¯¹è±¡
    msg.what = 2000
    msg.obj = "è¦å­˜å‚¨çš„æ¶ˆæ¯" // ä»»æ„ç±»å‹
    handler.sendMessage(msg) // å‘é€æ¶ˆæ¯
    handler.sendEmptyMessageAtTime(3000, System.currentTimeMillis() + 3000) // åœ¨æŒ‡å®šæ—¶é—´åå»¶è¿Ÿå¤„ç†
    handler.sendEmptyMessageDelayed(4000,2000) // å»¶è¿Ÿå¤šå°‘æ—¶é—´åå¤„ç†
}
```









---------------------

## 3. æ›´æ–°UI

**ä¸èƒ½åœ¨ä¸»çº¿ç¨‹ä¸­ç›´æ¥æ›´æ–°UI**

![image-20210613120250497](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-befo/20210613120250.png)

ã€æŠ¥é”™ä¿¡æ¯ã€‘ï¼šåªæœ‰åˆ›å»ºè§†å›¾å±‚æ¬¡ç»“æ„çš„åŸå§‹çº¿ç¨‹æ‰èƒ½è§¦åŠå®ƒçš„è§†å›¾

```log
android.view.ViewRootImpl$CalledFromWrongThreadException: Only the original thread that created a view hierarchy can touch its views. 
```

![](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-befo/20210613115630.png)

**ä¿®æ”¹**

```kotlin
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityMainBinding.inflate(layoutInflater)
        var rootView: View = binding.root
        setContentView(rootView)

        // åˆ›å»ºHandler
        val handler: Handler = object : Handler() {
            override fun handleMessage(msg: Message) {
                super.handleMessage(msg)
                Log.d(TAG,"running from UI thread(): ${Thread.currentThread()}")
                Log.d(TAG, "handleMessage: ${msg.what}")
                // ä¸»çº¿ç¨‹æ¥åˆ°å­çº¿ç¨‹çš„æ¶ˆæ¯ï¼Œå¤„ç†æ¶ˆæ¯ï¼Œæ›´æ–°UI
                if(msg.what == 1001) {
                    binding.mTextView.text = "ğŸ“º iqqcode..."
                }
            }
        }

        binding.mButton.setOnClickListener {
            thread(start = true) {
                Log.d(TAG,"running from sub-thread(): ${Thread.currentThread()}")
                // å­çº¿ç¨‹ä¸­å‘é€æ¶ˆæ¯,é€šçŸ¥UIæ›´æ–°
                handler.sendEmptyMessage(1001)
                // TODO å¤„ç†è€—æ—¶æ“ä½œ
            }
        }
    }
```

ä¸åŒçš„çº¿ç¨‹åœ¨æ“ä½œ

![image-20210613121003127](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-befo/20210613121003.png)

<br>

## 4. å®ä¾‹Demo

### 4.1 è¯·æ±‚ç½‘è·¯æ•°æ®

åœ¨ç‚¹å‡»Buttonæ—¶ï¼Œå»¶è¿Ÿè¯·æ±‚ç½‘ç»œæ•°æ®ï¼Œæ­¤æ—¶æ˜¾ç¤ºProgressBarï¼ŒåŠ è½½å®Œæˆåå°†æ•°æ®æ˜¾ç¤ºåˆ°EditTextä¸­ã€‚

![image-20210614110313072](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-befo/20210614110313.png)

**Viewå¸ƒå±€**

```xml
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    tools:context=".HandlerTestActivity">

    <ProgressBar
        android:id="@+id/mProgressBar"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_gravity="center_horizontal"
        android:layout_marginTop="20dp"
        android:max="100"
        android:visibility="invisible" />

    <Button
        android:id="@+id/mButton"
        android:layout_width="300dp"
        android:layout_height="wrap_content"
        android:layout_gravity="center"
        android:layout_marginTop="30dp"
        android:text="GET Submit" />


    <EditText
        android:id="@+id/mEditText"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_margin="10dp"
        android:hint="æ˜¾ç¤ºç»“æœ" />

</LinearLayout>
```

**HandlerTestActivityï¼šä½¿ç”¨Handlerå®ç°å¼‚æ­¥ä»»åŠ¡**

1. åˆ›å»ºHandleræˆå‘˜å˜é‡å¯¹è±¡, å¹¶é‡å†™å…¶handleMessage()
2. åœ¨åˆ†/ä¸»çº¿ç¨‹åˆ›å»ºMessageå¯¹è±¡
3. ä½¿ç”¨handlerå¯¹è±¡å‘é€Message
4. åœ¨handleMessage()ä¸­å¤„ç†æ¶ˆæ¯

```kotlin
class HandlerTestActivity : AppCompatActivity() {

    private lateinit var binding: ActivityHandlerTestBinding
    private val urlString = "http://japi.juhe.cn/qqevaluate/qq?qq=2726109782&key=e6ce0de3a1db3739d4343b9d19a9d61f" // èšåˆæ•°æ®API

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityHandlerTestBinding.inflate(layoutInflater)
        val rootView: View = binding.root
        setContentView(rootView)
        binding.mButton.setOnClickListener {
            asyncRequestByGet(urlString)
        }
    }

    // 1. åˆ›å»ºHandleræˆå‘˜å˜é‡å¯¹è±¡, å¹¶é‡å†™å…¶handleMessage()
    private val handler = object : Handler(Looper.myLooper()!!) {
        override fun handleMessage(msg: Message) {
            super.handleMessage(msg)
            if (msg.what === 2000) {
                // 4. åœ¨handleMessage()ä¸­å¤„ç†æ¶ˆæ¯
                val result = msg.obj as String
                binding.mEditText.setText(result)
                binding.mProgressBar.visibility = View.INVISIBLE
            }
        }
    }

    /**
     * è¯·æ±‚æœåŠ¡å™¨ç«¯,å¾—åˆ°è¿”å›çš„ç»“æœå­—ç¬¦ä¸²
     * @return
     * @throws Exception
     */
    @Throws(java.lang.Exception::class)
    fun asyncRequestByGet(path: String?) {

        // ä¸»çº¿ç¨‹, æ˜¾ç¤ºæç¤ºè§†å›¾(ProgressDialog/ProgressBar)
        binding.mProgressBar.visibility = View.VISIBLE;

        // OKHttp
        val client: OkHttpClient = OkHttpClient.Builder()
            .connectTimeout(8000, TimeUnit.MILLISECONDS)
            .build()

        val request: Request = Request.Builder()
            .url(path.toString())
            .get()
            .build()

        client.newCall(request).enqueue(object : Callback {
            override fun onFailure(call: Call, e: IOException) {
                Log.i("TAG", e.message!!)
            }

            override fun onResponse(call: Call, response: Response) {
                val resultData = response.body!!.string()
                // åˆ†çº¿ç¨‹, è”ç½‘è¯·æ±‚, å¹¶å¾—åˆ°å“åº”æ•°æ®
                thread(start = true) {
                    Thread.sleep(3000)
                    try {
                        Log.i("TAG", "asyncRequestByGet: ==> $resultData")
                        // 2. åœ¨åˆ†/ä¸»çº¿ç¨‹åˆ›å»ºMessageå¯¹è±¡
                        val message = Message.obtain()
                        message.what = 2000 //æ ‡è¯†
                        message.obj = resultData
                        // 3. ä½¿ç”¨handlerå¯¹è±¡å‘é€Message
                        handler.sendMessage(message)
                    } catch (e: Exception) {
                        e.printStackTrace()
                    }
                }
            }
        })
    }
}
```

<br>

### 4.2 æ•°å­—åŠ å‡å˜åŒ–Demo

1. åˆå§‹æ—¶ï¼šæ˜¾ç¤º10ï¼Œå¯ä»¥é€šè¿‡ç‚¹å‡»æŒ‰é’®æ”¹å˜å…¶å€¼
2. ç‚¹å‡»â€œè‡ªåŠ¨å¢åŠ â€ï¼Œæ¯éš”1Sä¸Šé¢çš„æ–‡æœ¬æ•°å€¼å¢åŠ 1,ä½†æœ€å¤§æ˜¾ç¤º20å¹¶ä½œå‡ºæç¤º
3. ç‚¹å‡»â€œè‡ªåŠ¨å‡å°‘â€ï¼Œæ¯éš”1Sä¸Šé¢çš„æ–‡æœ¬æ•°å€¼å‡å°‘1,ä½†æœ€å°æ˜¾ç¤º1å¹¶ä½œå‡ºæç¤º
4. ç‚¹å‡»â€œæš‚åœâ€ï¼Œä¸Šé¢çš„æ•°å€¼æ–‡æœ¬ä¸å†å˜åŒ–

![](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-befo/20210614111420.gif)

**Viewå¸ƒå±€**

```xml
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    tools:context=".HandlerDemoActivity">

    <TextView
        android:id="@+id/mNumber"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="70dp"
        android:gravity="center"
        android:text="10"
        android:textSize="200sp"
        android:textStyle="bold" />

    <Button
        android:id="@+id/mIncrease"
        android:layout_width="260dp"
        android:layout_height="wrap_content"
        android:layout_gravity="center"
        android:layout_marginTop="70dp"
        android:text="è‡ªåŠ¨å¢åŠ " />

    <Button
        android:id="@+id/mDecrease"
        android:layout_width="260dp"
        android:layout_height="wrap_content"
        android:layout_gravity="center"
        android:layout_marginTop="10dp"
        android:text="è‡ªåŠ¨å‡å°‘" />

    <Button
        android:id="@+id/mPause"
        android:layout_width="260dp"
        android:layout_height="wrap_content"
        android:layout_gravity="center"
        android:layout_marginTop="10dp"
        android:enabled="false"
        android:text="æš‚åœ" />

</LinearLayout>
```

**HandlerDemoActivity**

```kotlin
class HandlerDemoActivity : AppCompatActivity(), View.OnClickListener {

    private lateinit var binding: ActivityHandlerDemoBinding

    private val WHAT_INCREASE = 100
    private val WHAT_DECREASE = 200
    private val RAND_COLOR = 300

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityHandlerDemoBinding.inflate(layoutInflater)
        val rootView: View = binding.root
        setContentView(rootView)

        // ä½¿ç”¨å®šæ—¶å™¨
        val timer = Timer();
        timer.schedule(object: TimerTask() {
            override fun run() {
                handler.sendEmptyMessage(RAND_COLOR)
            }
        }, 1000,1000)

        binding.mDecrease.setOnClickListener(this)
        binding.mIncrease.setOnClickListener(this)
        binding.mPause.setOnClickListener(this)
    }

    private val handler = object : Handler(Looper.myLooper()!!) {
        override fun handleMessage(msg: Message) {
            super.handleMessage(msg)
            // å¾—åˆ°å½“å‰ç°å®çš„æ•°å€¼
            var number = Integer.parseInt(binding.mNumber.text.toString())
            when (msg.what) {
                // é™åˆ¶number <= 20
                WHAT_INCREASE -> {
                    if (number == 20) {
                        // è®¾ç½®æš‚åœä¸èƒ½æ“ä½œ
                        binding.mPause.isEnabled = false;
                        Toast.makeText(this@HandlerDemoActivity, "å·²ç»è¾¾åˆ°æœ€å¤§å€¼", Toast.LENGTH_SHORT).show();
                        return
                    }
                    number++
                    binding.mNumber.text = number.toString()
                    // å‘é€å¢åŠ çš„å»¶è¿Ÿæ¶ˆæ¯
                    sendEmptyMessageDelayed(WHAT_INCREASE, 1000) // å»¶è¿Ÿå¤šå°‘æ—¶é—´åå¤„ç†
                }

                WHAT_DECREASE -> {
                    // é™åˆ¶number >= 1
                    if (number == 1) {
                        //è®¾ç½®æš‚åœä¸èƒ½æ“ä½œ
                        binding.mPause.isEnabled = false;
                        Toast.makeText(this@HandlerDemoActivity, "å·²ç»è¾¾åˆ°æœ€å°å€¼", Toast.LENGTH_SHORT)
                            .show();
                        return
                    }
                    number--;
                    binding.mNumber.text = number.toString();
                    // å‘é€å‡å°‘çš„å»¶è¿Ÿæ¶ˆæ¯
                    sendEmptyMessageDelayed(WHAT_DECREASE, 1000);
                }
                RAND_COLOR -> {
                    // ä½¿ç”¨rgbæ··åˆç”Ÿæˆä¸€ç§æ–°çš„é¢œè‰²,Color.rgbç”Ÿæˆçš„æ˜¯ä¸€ä¸ªintæ•°
                    binding.mNumber.setTextColor(randomTextColor())
                }
            }
        }
    }

    /**
     * è·å–éšæœºrgbé¢œè‰²å€¼
     * @return Int
     */
    private fun randomTextColor(): Int {
        val random = Random()
        // 0-190 ,å¦‚æœé¢œè‰²å€¼è¿‡å¤§,å°±è¶Šæ¥è¿‘ç™½è‰²,å°±çœ‹ä¸æ¸…äº†,æ‰€ä»¥éœ€è¦é™å®šèŒƒå›´
        val red = random.nextInt(150)
        val green = random.nextInt(150)
        val blue = random.nextInt(150)
        // ä½¿ç”¨rgbæ··åˆç”Ÿæˆä¸€ç§æ–°çš„é¢œè‰²,Color.rgbç”Ÿæˆçš„æ˜¯ä¸€ä¸ªintæ•°
        return Color.rgb(red, green, blue)
    }

    override fun onClick(v: View?) {
        when(v?.id) {
            R.id.mIncrease -> {
                // é™åˆ¶Buttonå¯æ“ä½œæ€§
                binding.mIncrease.isEnabled = false
                binding.mDecrease.isEnabled = true
                binding.mPause.isEnabled = true

                // åœæ­¢å‡å°‘(ç§»é™¤æœªå¤„ç†çš„å‡å°‘çš„æ¶ˆæ¯)
                handler.removeMessages(WHAT_DECREASE);
                // å‘æ¶ˆæ¯(å¢åŠ )
                handler.sendEmptyMessage(WHAT_INCREASE);
            }
            R.id.mDecrease -> {
                // é™åˆ¶Buttonå¯æ“ä½œæ€§
                binding.mIncrease.isEnabled = false
                binding.mDecrease.isEnabled = true
                binding.mPause.isEnabled = true

                // åœæ­¢å¢åŠ (ç§»é™¤æœªå¤„ç†çš„å¢åŠ çš„æ¶ˆæ¯)
                handler.removeMessages(WHAT_INCREASE);

                // å‘æ¶ˆæ¯(å‡å°‘)
                handler.sendEmptyMessage(WHAT_DECREASE);
            }
            R.id.mPause -> {
                // é™åˆ¶Buttonå¯æ“ä½œæ€§
                binding.mIncrease.isEnabled = false
                binding.mDecrease.isEnabled = true
                binding.mPause.isEnabled = true

                // åœæ­¢å¢åŠ /å‡å°‘(ç§»é™¤æœªå¤„ç†çš„å‡å°‘/å¢åŠ çš„æ¶ˆæ¯)
                handler.removeMessages(WHAT_INCREASE);
                handler.removeMessages(WHAT_DECREASE);
            }
        }
    }
}
```



