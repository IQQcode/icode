---
title: SharedPreferenceså­˜å‚¨
date: 2021-09-05 08:19:28
permalink: /pages/f80826/
categories:
  - Android
  - æ•°æ®å­˜å‚¨
  - Storage
tags:
  - 
---
## 1. SharedPreferenceså­˜å‚¨ç®€ä»‹

é€šå¸¸æƒ…å…„ä¸‹ä¼šå‘ç”Ÿè¿™æ ·çš„é—®é¢˜ï¼šæˆ‘ä»¬åœ¨ç¼–è¾‘çŸ­ä¿¡çš„åŒæ—¶æœ‰ç”µè¯æ‰“è¿›æ¥ï¼Œé‚£ä¹ˆæ¥ç”µè¯è‚¯å®šæ˜¯è¦å¯åŠ¨å¦ä¸€ä¸ªActivityï¼Œé‚¢ä¹ˆå½“å‰ç¼–è¾‘çŸ­ä¿¡çš„Activityæ‰€ç¼–è¾‘çš„ä¿¡æ¯æˆ‘ä»¬æƒ³æš‚æ—¶ä¿å­˜ä¸‹æ¥ï¼Œç­‰æ¥å®Œç”µè¯åå›åˆ°è¯¥Activityæ—¶ï¼Œå¯ä»¥ç»§ç»­ç¼–è¾‘çŸ­ä¿¡ã€‚è¯¥åŠŸèƒ½éœ€è¦å¦‚ä½•å»å®ç°å‘¢?

SharedPreferencesä½¿ç”¨xmæ ¼å¼ä¸º Androidåº”ç”¨æä¾›ä¸€ç§**æ°¸ä¹…çš„æ•°æ®å­˜å‚¨æ–¹å¼**ã€‚Androidæä¾›äº†ç›¸å…³çš„APIæ¥å¤„ç†è¿™äº›æ•°æ¤è€Œä¸éœ€è¦ç¨‹åºå‘˜ç›´æ¥æ“ä½œè¿™äº›æ–‡ä»¶æˆ–è€…è€ƒè™‘æ•°æ¤åŒæ­¥é—®é¢˜.

- SPå­˜å‚¨ä¸“é—¨ç”¨æ¥å­˜å‚¨ä¸€äº›å•ä¸€çš„å°æ•°æ®ï¼Œå­˜å‚¨æ•°æ®çš„ç±»å‹ï¼šbooleanã€floatã€intã€longã€String
- æ•°æ®ä¿å­˜çš„è·¯å¾„ï¼š`/data/data/<your app_ package _name>/shared_prefs/yyy.xml`ï¼Œå¯ä»¥è¢«å¤„åŒä¸€ä¸ªåº”ç”¨ä¸­çš„æ‰€æœ‰ Activityè®¿é—®ã€‚
- å¯ä»¥è®¾ç½®æ•°æ®åªèƒ½æ˜¯**å½“å‰åº”ç”¨è¯»å–**ï¼Œè€Œåˆ«çš„åº”ç”¨ä¸å¯ä»¥ï¼›åº”ç”¨å¸è½½æ—¶ä¼šåˆ é™¤æ­¤æ•°æ®

### 1.1 Contextä¸­ç›¸å…³API

SharedPreferenceså¯¹åº”SPæ–‡ä»¶çš„æ¥å£

`context.getSharedPreferences(String name, int mode)`: å¾—åˆ°SPå¯¹è±¡

```java
public abstract SharedPreferences getSharedPreferences (String name, int mode)
```

- name: æ–‡ä»¶åï¼ˆä¸å¸¦.xml)
- mode: ç”Ÿæˆçš„æ–‡ä»¶æ¨¡å¼ï¼› é»˜è®¤`MODE_PRIVATE`æ˜¯å¦æ˜¯ç§æœ‰çš„ï¼Œå³åªæœ‰å½“å‰APPå¯ä»¥è®¿é—®,å…¶ä»–å‡ ä¸ªå€¼å‡å·²è¢«åºŸå¼ƒ
- Editor sp.edit(): å¾—åˆ°Editorå¯¹è±¡
- Xxx sp.getXxx(name,defaultValue)ï¼šæ ¹æ®nameå¾—åˆ°å¯¹åº”çš„æ•°æ®

> MODE_PRIVATEï¼ˆåªèƒ½è¢«è‡ªå·±çš„åº”ç”¨ç¨‹åºè®¿é—®ï¼‰
>
> MODE_WORLD_READABLEï¼ˆé™¤äº†è‡ªå·±è®¿é—®å¤–è¿˜å¯ä»¥è¢«å…¶å®ƒåº”è¯¥ç¨‹åºè¯»å–ï¼‰
>
> MODE_WORLD_WRITEABLEï¼ˆé™¤äº†è‡ªå·±è®¿é—®å¤–è¿˜å¯ä»¥è¢«å…¶å®ƒåº”è¯¥ç¨‹åºè¯»å–å’Œå†™å…¥ï¼‰

Editorï¼šèƒ½æ›´æ–°spæ–‡ä»¶çš„æ¥å£

- Editor put(name,value): ä¿å­˜ä¸€ä¸ªé”®å€¼å¯¹ï¼Œæ²¡æœ‰çœŸæ­£ä¿å­˜åˆ°æ–‡ä»¶ä¸­
- Editor remove(name)
- commit(): æäº¤ï¼Œæ•°æ®çœŸæ­£ä¿å­˜åˆ°æ–‡ä»¶ä¸­äº†

ã€ä½¿ç”¨ã€‘

```java
// åˆ›å»ºSP, ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºxmlä¿å­˜çš„æ–‡ä»¶å,ç¬¬äºŒä¸ªä¸ºæ–‡ä»¶æƒé™ï¼ˆç§æœ‰ï¼‰
SharedPreferences sharedPreferences = getApplicationContext().getSharedPreferences("shared_test", Context.MODE_PRIVATE);
// è·å–SPç¼–è¾‘å¯¹è±¡
SharedPreferences.Editor edit = sharedPreferences.edit();
// å­˜å…¥æ•°æ®
edit.putString(SPPHONRKEY, phoneNumber);
// å†™åˆ°ç£ç›˜é‡Œ
edit.commit();

// ä»SPä¸­è¯»å–æ•°æ®ï¼Œä¸putæ–¹æ³•ç›¸å¯¹åº”çš„getæ–¹æ³•
sharedPreferences.getString(key, defaultValue); // defaultValueä¸ºè·å–ä¸åˆ°å€¼æ—¶è¿”å›çš„é»˜è®¤å€¼
```

- `edit.commit();` **åŒæ­¥** ç›´æ¥å†™å…¥ç£ç›˜ï¼ˆé€Ÿåº¦å¿«ï¼‰
- `edit.apply();` **éåŒæ­¥** å†™å…¥å†…å­˜ï¼Œåˆé€‚æ—¶æœºå†æŒä¹…åŒ–åˆ°ç£ç›˜ï¼ˆé€Ÿåº¦æ…¢ï¼‰

### 1.2 Activityç±»ä¸­çš„getPreferences

è¿™ä¸ªæ–¹æ³•å’Œ**Context**ä¸­çš„`getSharedPreferences`ç±»ä¼¼ï¼Œä¸è¿‡åªæ¥å—ä¸€ä¸ªå‚æ•°ï¼Œå› ä¸ºä½¿ç”¨`getPreferences`æ—¶ä¼šå°†å½“å‰Activityçš„ç±»åä½œä¸ºSharedPreferencesçš„æ–‡ä»¶å

![img](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/202109050835844.jpeg)



### 1.3 æ–¹æ³•çš„ä½¿ç”¨

**å†™å…¥æ•°æ®ï¼Œç”±Editorå¯¹è±¡è°ƒç”¨**

```java
//å†™å…¥booleanç±»å‹çš„æ•°æ®
abstract SharedPreferences.Editor   putBoolean(String key, boolean value)
//å†™å…¥floatç±»å‹çš„æ•°æ®
abstract SharedPreferences.Editor   putFloat(String key, float value)
//å†™å…¥intç±»å‹çš„æ•°æ®
abstract SharedPreferences.Editor   putInt(String key, int value)
//å†™å…¥longç±»å‹çš„æ•°æ®
abstract SharedPreferences.Editor   putLong(String key, long value)
//å†™å…¥Stringç±»å‹çš„æ•°æ®
abstract SharedPreferences.Editor   putString(String key, String value)
//å†™å…¥Set<String>ç±»å‹çš„æ•°æ®
abstract SharedPreferences.Editor   putStringSet(String key, Set<String> values)
```

- keyï¼šæŒ‡å®šæ•°æ®å¯¹åº”çš„key
- valueï¼šæŒ‡å®šçš„å€¼

**è¯»å–æ•°æ®ï¼Œç”±SharedPreferenceså¯¹è±¡è°ƒç”¨**

```java
//è¯»å–æ‰€æœ‰æ•°æ®
abstract Map<String, ?> getAll()
//è¯»å–çš„æ•°æ®ä¸ºbooleanç±»å‹
abstract boolean    getBoolean(String key, boolean defValue)
//è¯»å–çš„æ•°æ®ä¸ºfloatç±»å‹
abstract float  getFloat(String key, float defValue)
//è¯»å–çš„æ•°æ®ä¸ºintç±»å‹
abstract int    getInt(String key, int defValue)
//è¯»å–çš„æ•°æ®ä¸ºlongç±»å‹
abstract long   getLong(String key, long defValue)
//è¯»å–çš„æ•°æ®ä¸ºStringç±»å‹
abstract String getString(String key, String defValue)
//è¯»å–çš„æ•°æ®ä¸ºSet<String>ç±»å‹
abstract Set<String>    getStringSet(String key, Set<String> defValues)
```

> å½“è¯»å–ä¸åˆ°æŒ‡å®šçš„æ•°æ®æ—¶ï¼Œä½¿ç”¨çš„é»˜è®¤å€¼defValue

**ç§»é™¤æŒ‡å®škeyçš„æ•°æ®ï¼Œç”±Editorå¯¹è±¡è°ƒç”¨**

```java
abstract SharedPreferences.Editor   remove(String key)
```

**æ¸…ç©ºæ•°æ®ï¼Œç”±Editorå¯¹è±¡è°ƒç”¨**

```java
abstract SharedPreferences.Editor   clear()
```

**æäº¤æ•°æ®ï¼Œç”±Editorå¯¹è±¡è°ƒç”¨**

```java
abstract boolean commit()
```

### 1.4  SharedPreferenceçš„ç›‘å¬

apiä¸­è¿˜æ³¨å†Œå’Œæ³¨é”€SharedPreferencesè¢«ç¼–è¾‘æ—¶çš„ç›‘å¬

```java
SharedPreferences.OnSharedPreferenceChangeListener changeListener = new OnSharedPreferenceChangeListener() {
    @Override
    public void onSharedPreferenceChanged(SharedPreferences preferences, String key) {
        //preferencesè¢« ç¼–è¾‘çš„SharedPreferenceså®ä¾‹
        //è¯¥SharedPreferencesä¸­è¢«ç¼–è¾‘çš„æ¡ç›®æ‰€å¯¹åº”çš„key
    }
};
// userInfoæ³¨å†Œç›‘å¬äº‹ä»¶
userInfo.registerOnSharedPreferenceChangeListener(changeListener);
// userInfoæ³¨é”€ç›‘å¬äº‹ä»¶
userInfo.unregisterOnSharedPreferenceChangeListener(changeListener);
```

### 1.5 æ€§èƒ½

- ShredPreferencesæ˜¯å•ä¾‹å¯¹è±¡ï¼Œç¬¬ä¸€æ¬¡æ‰“å¼€åï¼Œä¹‹åè·å–éƒ½æ— éœ€åˆ›å»ºï¼Œé€Ÿåº¦å¾ˆå¿«ã€‚
- å½“ç¬¬ä¸€æ¬¡è·å–æ•°æ®åï¼Œæ•°æ®ä¼šè¢«åŠ è½½åˆ°ä¸€ä¸ªç¼“å­˜çš„Mapä¸­ï¼Œä¹‹åçš„è¯»å–éƒ½ä¼šéå¸¸å¿«ã€‚
- å½“ç”±äºæ˜¯XML<->Mapçš„å­˜å‚¨æ–¹å¼ï¼Œæ‰€ä»¥ï¼Œæ•°æ®è¶Šå¤§ï¼Œæ“ä½œè¶Šæ…¢ï¼Œgetã€commitã€applyã€removeã€clearéƒ½ä¼šå—å½±å“ï¼Œæ‰€ä»¥å°½é‡æŠŠæ•°æ®æŒ‰åŠŸèƒ½æ‹†åˆ†æˆè‹¥å¹²ä»½ã€‚

### 1.6 æ³¨æ„ç‚¹

**æç¤ºä¸€**

è¿™é‡Œçš„ç”¨åˆ°çš„ï¼š

```java
getSharedPreferences(String name, int mode);

getPreferences(int mode); // MODE_PRIVATE
```

éƒ½æ˜¯åœ¨Acitivtyä¸­æ‰§è¡Œçš„ã€‚è‹¥ä¸åœ¨Activityä¸­ï¼Œè¯·ä½¿ç”¨

```java
context.getSharedPreferences(String name, int mode);

context.getPreferences(int mode); // Conetxt.MODE_PRIVATE 
```

**æç¤ºäºŒ**

æ‰€ä¿å­˜çš„SharedPreferencesæ•°æ®å°†ä¸€ç›´å­˜åœ¨ï¼Œé™¤éè¢«è¦†ç›–ã€ç§»é™¤ã€æ¸…ç©ºæˆ–æ–‡ä»¶è¢«åˆ é™¤ã€‚

> SharedPreferencesä¿å­˜çš„æ•°æ®ä¼šéšç€åº”ç”¨çš„å¸è½½è€Œè¢«åˆ é™¤ï¼‰

**æç¤ºä¸‰**

åŒæ—¶æ‰§è¡Œè¿™ä¸¤å¥ä»£ç çš„æ—¶å€™ï¼Œç¬¬ä¸€è¡Œä»£ç æ‰€å†™çš„å†…å®¹ä¼šè¢«ç¬¬äºŒè¡Œä»£ç å–ä»£ã€‚

valueçš„å€¼è¢«è¦†ç›–ï¼š

```java
editor.putInt("age", 20);
//è¦†ç›–keyä¸ºageçš„æ•°æ®ï¼Œå¾—åˆ°çš„ç»“æœï¼šage = 32
editor.putInt("age", 32);
```

valueçš„å€¼ç±»å‹è¢«è¦†ç›–ï¼š

```java
editor.putString("age", "20");
//è¦†ç›–keyä¸ºageçš„æ•°æ®ï¼Œå¾—åˆ°çš„ç»“æœï¼šage = 32 (intç±»å‹)
editor.putInt("age", 32);
```

**æç¤ºå››**

æ‰§è¡Œä»¥ä¸‹ä»£ç ä¼šå‡ºç°å¼‚å¸¸ï¼ŒæŒ‡å®škeyæ‰€ä¿å­˜çš„ç±»å‹å’Œè¯»å–æ—¶çš„ç±»å‹ä¸åŒ

```java
editor.putInt("age", 32);//ä¿å­˜ä¸ºintç±»å‹
String age = userInfo.getString("age", "null");//è¯»å–æ—¶ä¸ºStringç±»å‹ï¼Œå‡ºç°å¼‚å¸¸
```

**æç¤ºäº”**

åœ¨è¿™äº›åŠ¨ä½œä¹‹åï¼Œè®°å¾—commit

```java
editor.putInt("age", 20);//å†™å…¥æ“ä½œ
editor.remove("age");   //ç§»é™¤æ“ä½œ
editor.clear();     //æ¸…ç©ºæ“ä½œ
editor.commit(); //è®°å¾—commit
```

------

## 2. SPä½¿ç”¨Demo

åœ¨æ–‡æœ¬æ¡†è¾“å…¥å†…å®¹ï¼Œåˆ‡æ¢åˆ°åå°ï¼ˆæ¨¡æ‹Ÿæ‰“ç”µè¯çš„æ“ä½œï¼‰ï¼Œåˆ™å½“å‰Activityå¤„äº`onStop()`çš„çŠ¶æ€ï¼›å†æ¬¡åˆ‡æ¢å›æ¥ï¼Œå¤„äº`onResume()`ï¼Œä»SPä¸­è¯»å–æ•°æ®

![sp_res](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/202109050835018.gif)

![image-20210828180018330](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/202109050835829.png)

```java
public class MainActivity extends AppCompatActivity {

    private EditText mEditTextNote, mEditTextPhone;
    private final static String SPNOTEKEY = "spnotekey";
    private final static String SPPHONRKEY = "spphonekey";

    private SharedPreferences sharedPreferences = null;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        initView();
        // å®ä¾‹åŒ–SharedPreferenceså¯¹è±¡
        sharedPreferences = getApplicationContext().getSharedPreferences("shared_test", Context.MODE_PRIVATE);
    }

    private void initView() {
        mEditTextNote = findViewById(R.id.edit_text_notes);
        mEditTextPhone = findViewById(R.id.edit_text_phone);
    }

    // è¿˜åŸæ•°æ®
    @Override
    protected void onResume() {
        super.onResume();
        // ä»SPä¸­è¯»å–æ•°æ®
        mEditTextNote.setText(sharedPreferences.getString(SPNOTEKEY, "null"));
        mEditTextPhone.setText(sharedPreferences.getString(SPPHONRKEY, "00000000000"));
    }

    // å­˜å‚¨æ•°æ®
    @Override
    protected void onPause() {
        super.onPause();
        Log.i("TAG", "onCheckedChanged: ç‚¹å‡»çŠ¶æ€å‘ç”Ÿæ”¹å˜");
        // å®ä¾‹åŒ–ç¼–è¾‘è€…å¯¹è±¡
        SharedPreferences.Editor edit = sharedPreferences.edit();
        // å­˜å‚¨æ•°æ®
        String note = mEditTextNote.getText().toString();
        String phoneNumber = mEditTextPhone.getText().toString();
        if (TextUtils.isEmpty(note) && TextUtils.isEmpty(phoneNumber)) {
            return;
        }
        edit.putString(SPNOTEKEY, note); // MD5åŠ å¯†
        edit.putString(SPPHONRKEY, phoneNumber);
        edit.commit();
    }
}
```

### ç»¼åˆä½¿ç”¨

```java
public class MainActivity extends Activity {
    private static final String TAG = "SharedPreferencesTest";
    // ä¿å­˜æ•°æ®SharedPreferencesæ–‡ä»¶çš„åå­—
    private final String PREFS_NAME = "MyPrefsFile";
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        saveUserInfo();
        getUserInfo();
        removeUserInfo();
        getUserInfo();
        clearUserInfo();
        getUserInfo();
    }
    
    // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
    private void saveUserInfo() {
        SharedPreferences userInfo = getSharedPreferences(PREFS_NAME, MODE_PRIVATE);
        SharedPreferences.OnSharedPreferenceChangeListener changeListener = new OnSharedPreferenceChangeListener() {
            
            @Override
            public void onSharedPreferenceChanged(SharedPreferences preferences, String key) {
                //preferencesè¢« ç¼–è¾‘çš„SharedPreferenceså®ä¾‹
                //è¯¥SharedPreferencesä¸­è¢«ç¼–è¾‘çš„æ¡ç›®æ‰€å¯¹åº”çš„key
            }
        };
        //userInfoæ³¨å†Œç›‘å¬äº‹ä»¶
        userInfo.registerOnSharedPreferenceChangeListener(changeListener);
        SharedPreferences.Editor editor = userInfo.edit();//è·å–Editor
        //å¾—åˆ°Editoråï¼Œå†™å…¥éœ€è¦ä¿å­˜çš„æ•°æ®
        editor.putString("username", "ä¸€åªçŒ«çš„æ¶µå…»");
        editor.putInt("age", 20);
        editor.commit();//æäº¤ä¿®æ”¹
        Log.i(TAG, "ä¿å­˜ç”¨æˆ·ä¿¡æ¯æˆåŠŸ");
    }
    
    // è¯»å–ç”¨æˆ·ä¿¡æ¯
    private void getUserInfo(){
        SharedPreferences userInfo = getSharedPreferences(PREFS_NAME, MODE_PRIVATE);
        String username = userInfo.getString("username", null);//è¯»å–username
        int age = userInfo.getInt("age", 0);//è¯»å–age
        Log.i(TAG, "è¯»å–ç”¨æˆ·ä¿¡æ¯");
        Log.i(TAG, "username:" + username + "ï¼Œ age:" + age);
    }

    // ç§»é™¤å¹´é¾„ä¿¡æ•°æ®
    private void removeUserInfo(){
        SharedPreferences userInfo = getSharedPreferences(PREFS_NAME, MODE_PRIVATE);
        SharedPreferences.Editor editor = userInfo.edit();//è·å–Editor
        editor.remove("age");
        editor.commit();
        Log.i(TAG, "ç§»é™¤å¹´é¾„æ•°æ®");
    }

    // æ¸…ç©ºæ•°æ®
    private void clearUserInfo(){
        SharedPreferences userInfo = getSharedPreferences(PREFS_NAME, MODE_PRIVATE);
        SharedPreferences.Editor editor = userInfo.edit();//è·å–Editor
        editor.clear();
        editor.commit();
        Log.i(TAG, "æ¸…ç©ºæ•°æ®");
    }
}
```

## 3. SPä¼ å‚æ³¨æ„å†…å­˜æ³„æ¼

åœ¨Activityä¸­å®ä¾‹åŒ–Dataç±»æ—¶ï¼Œå¾€å¾€éœ€è¦é€šè¿‡æ„é€ ä¼ å…¥Contectï¼Œé»˜è®¤ä¼ çš„å°±æ˜¯this

```java
@Override
protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);
    
    // å¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼
    MyData data = new MyData(this);
}
```

thisæ¯”è¡¨ç¤ºå½“å‰Activityçš„å¼•ç”¨ï¼Œå¦‚æœå½“å±å¹•æ—‹è½¬æ—¶Activityå¯èƒ½è¢«é”€æ¯æ¥é‡æ–°åˆ›å»ºï¼Œå°†`this`å½“å‰é¡µé¢çš„å¼•ç”¨ä¼ å…¥åˆ°MyDataä¸­ï¼Œå› ä¸ºMyDataæŒæœ‰å½“å‰Activityçš„å¼•ç”¨ï¼Œæ‰€ä»¥å¯¼è‡´å½“å‰Activityä¸èƒ½è¢«åŠæ—¶é”€æ¯ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æ³„éœ²ã€‚

```java
@Override
protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);
    
    // æ­£ç¡®ä½¿ç”¨
    MyData data = new MyData(getApplicationContext());
}
```

`getApplicationContext()`æ˜¯å½“å‰APPå…¨å±€çš„å”¯ä¸€çš„å¼•ç”¨ï¼Œå¯ä»¥ç†è§£ä¸ºAPPçš„é¡¶çº§å¼•ç”¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªå•ä¾‹çš„å¯¹è±¡ï¼Œåªè¦APPåœ¨è¿è¡Œå®ƒå°±å­˜åœ¨ã€‚

------

åœ¨æ¨èä¸€ç¯‡ä¸é”™çš„åšæ–‡ğŸ”—http://gityuan.com/2017/06/18/SharedPreferences/

-----------------

ã€æ–‡ç« å‚è€ƒã€‘

[1] å¸¦å¿ƒæƒ…å»æ—…è¡Œ. ç®€ä¹¦. https://www.jianshu.com/p/59b266c644f3