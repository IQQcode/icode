---
title: OkHttpçš„å·¥ä½œæµç¨‹åˆ†æ-è½¬è½½
date: 2021-06-17 13:39:58
permalink: /pages/2fa575/
categories:
  - Android
  - ç½‘ç»œæ“ä½œ
  - OKHttp
tags:
  - okhttp
  - net
---
> ã€è½¬è½½è‡ªğŸ“š[èƒ¡é£æ´‹-OkHttpçš„å·¥ä½œæµç¨‹åˆ†æ-https://cloud.tencent.com/developer/article/1667339](https://cloud.tencent.com/developer/article/1667339)ã€

å¦‚æœæˆ‘ä»¬æƒ³è¦è¿›è¡Œgetè¯·æ±‚ï¼Œé‚£ä¹ˆä½¿ç”¨å°‘é‡çš„ä»£ç å°±èƒ½å®ç°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```javascript
        OkHttpClient httpClient = new OkHttpClient();
        String url = "https://www.baidu.com/";
        Request getRequest = new Request.Builder()
                .url(url)
                .get()
                .build();
        Call call = httpClient.newCall(getRequest);
        call.enqueue(new Callback() {
            @Override
            public void onFailure(Call call, IOException e) {

            }
            @Override
            public void onResponse(Call call, Response response) throws IOException {

            }
        });        
```

çœ‹èµ·æ¥å¾ˆç®€æ´çš„ä»£ç ï¼Œå®é™…æ˜¯OkHttpåœ¨èƒŒåå¸®æˆ‘ä»¬é»˜é»˜æ‰§è¡Œäº†æˆå¨çš„å·¥ä½œã€‚

çŸ¥å…¶ç„¶ä¹Ÿè¦çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚é‚£ä¹ˆè¿™ç¯‡æˆ‘ä»¬å°±æ¥è§£æä¸€ä¸‹OkHttpçš„æºç ï¼Œçœ‹çœ‹å®ƒåœ¨è¿™äº›ç®€å•ç”¨æ³•çš„èƒŒåï¼Œåˆ°åº•æ‰§è¡Œäº†å¤šä¹ˆå¤æ‚çš„å·¥ä½œã€‚

## è¯·æ±‚çš„åˆ›å»º

ä»¥ä¸Šé¢getè¯·æ±‚çš„ä»£ç æ­¥éª¤åˆ†æï¼Œé‚£ä¹ˆå…ˆåˆ†æOkHttpClientå®ä¾‹çš„åˆ›å»ºã€‚ åœ¨ä¸Šä¸€ç¯‡ä¸­ï¼Œæåˆ°OkHttpClientå®ä¾‹åŒ–å¯ä»¥ç›´æ¥åˆ›å»ºï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨Builderå»ºé€ è€…æ¨¡å¼è¿›è¡Œé…ç½®ç„¶åbuild()å³å¯ã€‚ç›´æ¥åˆ›å»ºå…¶å®å°±æ˜¯ä½¿ç”¨äº†é»˜è®¤çš„é…ç½®ã€‚å…¶æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š

```javascript
  public OkHttpClient() {
    this(new Builder());
  }

  OkHttpClient(Builder builder) {
    this.dispatcher = builder.dispatcher;//è°ƒåº¦å™¨ï¼Œç”¨äºæ§åˆ¶å¹¶å‘çš„è¯·æ±‚ã€‚å†…éƒ¨ä¿å­˜åŒæ­¥å’Œå¼‚æ­¥è¯·æ±‚çš„callï¼Œå¹¶ä½¿ç”¨çº¿ç¨‹æ± å¤„ç†å¼‚æ­¥è¯·æ±‚ã€‚
    this.proxy = builder.proxy;//ä»£ç†è®¾ç½®
    this.protocols = builder.protocols;//httpåè®®
    this.connectionSpecs = builder.connectionSpecs;//è¿æ¥é…ç½®
    this.interceptors = Util.immutableList(builder.interceptors);//å…¨å±€æ‹¦æˆªå™¨
    this.networkInterceptors = Util.immutableList(builder.networkInterceptors);//ç½‘ç»œæ‹¦æˆªå™¨
    this.eventListenerFactory = builder.eventListenerFactory;//è¯·æ±‚çš„ç›‘å¬å™¨çš„åˆ›å»ºå·¥å‚
    this.proxySelector = builder.proxySelector;//ä»£ç†é€‰æ‹©å™¨
    this.cookieJar = builder.cookieJar;//cookie,é»˜è®¤æ²¡æœ‰cookieï¼šCookieJar.NO_COOKIES
    this.cache = builder.cache;//ç½‘ç»œç¼“å­˜è®¾ç½®
    this.internalCache = builder.internalCache;//å†…éƒ¨ä½¿ç”¨çš„ç¼“å­˜æ¥å£
    this.socketFactory = builder.socketFactory;//socketå·¥å‚

    boolean isTLS = false;
    for (ConnectionSpec spec : connectionSpecs) {
      isTLS = isTLS || spec.isTls();
    }

    if (builder.sslSocketFactory != null || !isTLS) {
      this.sslSocketFactory = builder.sslSocketFactory;
      this.certificateChainCleaner = builder.certificateChainCleaner;
    } else {
      X509TrustManager trustManager = Util.platformTrustManager();
      this.sslSocketFactory = newSslSocketFactory(trustManager);
      this.certificateChainCleaner = CertificateChainCleaner.get(trustManager);
    }

    if (sslSocketFactory != null) {
      Platform.get().configureSslSocketFactory(sslSocketFactory);
    }

    this.hostnameVerifier = builder.hostnameVerifier;
    this.certificatePinner = builder.certificatePinner.withCertificateChainCleaner(
        certificateChainCleaner);
    this.proxyAuthenticator = builder.proxyAuthenticator;
    this.authenticator = builder.authenticator;//ä»¥ä¸Šå‡ ä¸ªæ˜¯å®‰å…¨ç›¸å…³è®¾ç½®
    this.connectionPool = builder.connectionPool;//è¿æ¥æ± 
    this.dns = builder.dns;//åŸŸåè§£æç³»ç»Ÿ
    this.followSslRedirects = builder.followSslRedirects;//sslé‡å®šå‘
    this.followRedirects = builder.followRedirects;//é‡å®šå‘
    this.retryOnConnectionFailure = builder.retryOnConnectionFailure;//è¿æ¥å¤±è´¥æ—¶æ˜¯å¦é‡è¯•
    this.callTimeout = builder.callTimeout;
    this.connectTimeout = builder.connectTimeout;
    this.readTimeout = builder.readTimeout;
    this.writeTimeout = builder.writeTimeout;//å‡ ä¸ªè¶…æ—¶è®¾ç½®
    this.pingInterval = builder.pingInterval;//pingé—´éš”æ—¶é—´
    //æ‹¦æˆªå™¨ä¸èƒ½æ˜¯null
    if (interceptors.contains(null)) {
      throw new IllegalStateException("Null interceptor: " + interceptors);
    }
    if (networkInterceptors.contains(null)) {
      throw new IllegalStateException("Null network interceptor: " + networkInterceptors);
    }
  }

  public static final class Builder {
...
    public Builder() {
    //é»˜è®¤çš„é…ç½®
      dispatcher = new Dispatcher();
      protocols = DEFAULT_PROTOCOLS;
      connectionSpecs = DEFAULT_CONNECTION_SPECS;
      eventListenerFactory = EventListener.factory(EventListener.NONE);
      proxySelector = ProxySelector.getDefault();
      if (proxySelector == null) {
        proxySelector = new NullProxySelector();
      }
      cookieJar = CookieJar.NO_COOKIES;
      socketFactory = SocketFactory.getDefault();
      hostnameVerifier = OkHostnameVerifier.INSTANCE;
      certificatePinner = CertificatePinner.DEFAULT;
      proxyAuthenticator = Authenticator.NONE;
      authenticator = Authenticator.NONE;
      connectionPool = new ConnectionPool();
      dns = Dns.SYSTEM;
      followSslRedirects = true;
      followRedirects = true;
      retryOnConnectionFailure = true;
      callTimeout = 0;
      connectTimeout = 10_000;
      readTimeout = 10_000;
      writeTimeout = 10_000;
      pingInterval = 0;
    }
...
  }
```

ç›´æ¥åˆ›å»ºOkHttpClientå®ä¾‹ï¼Œé…ç½®é¡¹å°±æ˜¯Builderæ„é€ æ–¹æ³•ä¸­é»˜è®¤å€¼ã€‚å¯è§é…ç½®é¡¹æ˜¯éå¸¸å¤šçš„ï¼ŒåŒ…æ‹¬ä¸Šä¸€ç¯‡ä¸­å·²ç»ä½¿ç”¨è¿‡çš„è¶…æ—¶è®¾ç½®ã€æ‹¦æˆªå™¨ã€‚

æ¥ç€çœ‹Requestçš„åˆ›å»ºï¼Œä¹Ÿæ˜¯ä½¿ç”¨å»ºé€ è€…æ¨¡å¼ï¼š

```javascript
    public Builder() {
      this.method = "GET";
      this.headers = new Headers.Builder();
    }

    public Builder get() {
      return method("GET", null);
    }

    public Builder post(RequestBody body) {
      return method("POST", body);
    }

    public Builder method(String method, @Nullable RequestBody body) {
      if (method == null) throw new NullPointerException("method == null");
      if (method.length() == 0) throw new IllegalArgumentException("method.length() == 0");
      if (body != null && !HttpMethod.permitsRequestBody(method)) {
        throw new IllegalArgumentException("method " + method + " must not have a request body.");
      }
      if (body == null && HttpMethod.requiresRequestBody(method)) {
        throw new IllegalArgumentException("method " + method + " must have a request body.");
      }
      this.method = method;
      this.body = body;
      return this;
    }

    public Builder addHeader(String name, String value) {
      headers.add(name, value);
      return this;
    }

    public Builder url(String url) {
      if (url == null) throw new NullPointerException("url == null");
      // Silently replace web socket URLs with HTTP URLs.
      if (url.regionMatches(true, 0, "ws:", 0, 3)) {
        url = "http:" + url.substring(3);
      } else if (url.regionMatches(true, 0, "wss:", 0, 4)) {
        url = "https:" + url.substring(4);
      }
      return url(HttpUrl.get(url));
    }

    public Request build() {
      if (url == null) throw new IllegalStateException("url == null");
      return new Request(this);
    }
```

æ³¨æ„åˆ°get()å’Œpost(RequestBody body)éƒ½æ˜¯å¯¹methodæ–¹æ³•çš„åŒ…è£…ï¼Œmethodæ–¹æ³•å†…éƒ¨å¯¹è¯·æ±‚æ–¹å¼å’Œè¯·æ±‚ä½“è¿›è¡Œäº†æ ¡éªŒï¼Œæ¯”å¦‚getè¯·æ±‚ä¸èƒ½æœ‰è¯·æ±‚ä½“ã€postè¯·æ±‚å¿…é¡»è¦è¯·æ±‚ä½“ç­‰ã€‚å…¶ä»–æ¯”è¾ƒå¥½ç†è§£ï¼Œä¸å†èµ˜è¿°ã€‚

æ¥ç€çœ‹HttpClientçš„newCallæ–¹æ³•ï¼š

```javascript
  @Override public Call newCall(Request request) {
    return RealCall.newRealCall(this, request, false /* for web socket */);
  }
```

è·Ÿè¿›RealCallçš„newRealCallæ–¹æ³•ï¼š

```javascript
  static RealCall newRealCall(OkHttpClient client, Request originalRequest, boolean forWebSocket) {
    // Safely publish the Call instance to the EventListener.
    RealCall call = new RealCall(client, originalRequest, forWebSocket);
    call.transmitter = new Transmitter(client, call);
    return call;
  }
```

å¯è§HttpClientçš„newCallæ–¹æ³•è·å¾—Callå®é™…æ˜¯RealCallã€‚RealCallå°±æ˜¯å‡†å¤‡æ‰§è¡Œçš„è¯·æ±‚ï¼Œæ˜¯å¯¹æ¥å£Callçš„å®ç°ã€‚å…¶å†…éƒ¨æŒæœ‰OkHttpClientå®ä¾‹ã€Requestå®ä¾‹ã€‚å¹¶ä¸”è¿™é‡Œè¿˜åˆ›å»ºäº†**Transmitter**ç»™RealCallçš„transmitterèµ‹å€¼ã€‚

**Transmitteræ„ä¸ºå‘å°„å™¨ï¼Œæ˜¯åº”ç”¨å±‚å’Œç½‘ç»œå±‚çš„æ¡¥æ¢**ï¼Œåœ¨è¿›è¡Œ **è¿æ¥**ã€çœŸæ­£å‘å‡ºè¯·æ±‚å’Œè¯»å–å“åº”ä¸­èµ·åˆ°å¾ˆé‡è¦çš„ä½œç”¨ï¼Œçœ‹ä¸‹æ„é€ æ–¹æ³•ï¼š

```javascript
  public Transmitter(OkHttpClient client, Call call) {
    this.client = client;
    this.connectionPool = Internal.instance.realConnectionPool(client.connectionPool());
    this.call = call;
    this.eventListener = client.eventListenerFactory().create(call);
    this.timeout.timeout(client.callTimeoutMillis(), MILLISECONDS);
  }
```

Transmitterå†…éƒ¨æŒæœ‰OkHttpClientã€è¿æ¥æ± ã€callã€äº‹ä»¶ç›‘å¬å™¨ã€‚

å†å›å¤´çœ‹RealCallå®ç°çš„æ¥å£Callï¼š

```javascript
//  å·²å‡†å¤‡è¦æ‰§è¡Œçš„è¯·æ±‚ã€‚ç”±äºè¡¨ç¤ºå•ä¸ªè¯·æ±‚/å“åº”å¯¹ï¼ˆæµï¼‰ï¼Œå› æ­¤æ— æ³•æ‰§è¡Œä¸¤æ¬¡
public interface Call extends Cloneable {
  ...
  //åŒæ­¥è¯·æ±‚ï¼Œä¼šé˜»å¡
  Response execute() throws IOException;

  //å¼‚æ­¥è¯·æ±‚
  void enqueue(Callback responseCallback);

  //å–æ¶ˆè¯·æ±‚ï¼Œå·²ç»å®Œæˆçš„ä¸èƒ½å–æ¶ˆã€‚
  void cancel();

  boolean isExecuted();
  boolean isCanceled();
  Timeout timeout();
...
  interface Factory {
    Call newCall(Request request);
  }
}
```

ä¸»è¦æ˜¯å®šä¹‰è¯·æ±‚çš„æ‰§è¡ŒåŠ¨ä½œå’ŒçŠ¶æ€ã€‚RealCallå¯¹Callçš„å…·ä½“å®ç°ï¼Œåœ¨åé¢æ‰§è¡Œæµç¨‹ä¸­è¯´æ˜ã€‚

å¥½äº†ï¼Œè¯·æ±‚çš„åˆ›å»ºå°±åˆ°è¿™é‡Œäº†ã€‚

## è¯·æ±‚çš„è°ƒåº¦

æ‰§è¡Œåˆ†ä¸ºåŒæ­¥å’Œå¼‚æ­¥ï¼Œè¿™é‡Œå…ˆä» **åŒæ­¥è¯·æ±‚** å¼€å§‹åˆ†æï¼Œå³RealCallçš„executeæ–¹æ³•ï¼š

```javascript
  @Override public Response execute() throws IOException {
    synchronized (this) {
      if (executed) throw new IllegalStateException("Already Executed");
      executed = true;
    }
    transmitter.timeoutEnter();//è¶…æ—¶è®¡æ—¶å¼€å§‹
    transmitter.callStart();//å›è°ƒè¯·æ±‚ç›‘å¬å™¨çš„è¯·æ±‚å¼€å§‹
    try {
      client.dispatcher().executed(this);//æ”¾å…¥é˜Ÿåˆ—
      return getResponseWithInterceptorChain();//æ‰§è¡Œè¯·æ±‚è·å–ç»“æœ
    } finally {
      client.dispatcher().finished(this);//è¯·æ±‚ç»“æŸ
    }
  }
```

é¦–å…ˆåˆ¤æ–­ å¦‚æœå·²ç»æ‰§è¡Œï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚è¿™å°±æ˜¯ä¸€ä¸ªè¯·æ±‚åªèƒ½æ‰§è¡Œä¸€æ¬¡çš„åŸå› ã€‚ç„¶åå›è°ƒè¯·æ±‚ç›‘å¬å™¨çš„è¯·æ±‚å¼€å§‹ã€‚ç„¶åè°ƒç”¨clientçš„è°ƒåº¦å™¨Dispatcherçš„executedæ–¹æ³•ï¼š

```javascript
  synchronized void executed(RealCall call) {
    runningSyncCalls.add(call);
  }
```

å¾ˆç®€å•ï¼Œè¯·æ±‚æ”¾å…¥ä¸€ä¸ªåŒç«¯é˜Ÿåˆ—runningSyncCallsä¸­ï¼Œè¡¨ç¤ºæ­£åœ¨æ‰§è¡Œçš„åŒæ­¥è¯·æ±‚ã€‚

ç„¶åè¿”å›äº†getResponseWithInterceptorChain()çš„ç»“æœResponseï¼Œå¯ä»¥çŒœåˆ°ï¼Œ**åŒæ­¥è¯·æ±‚çœŸæ­£çš„è¯·æ±‚æµç¨‹æ˜¯åœ¨getResponseWithInterceptorChainæ–¹æ³•ä¸­**ã€‚ æœ€åè¯·æ±‚ç»“æŸï¼Œä¼šèµ°Dispatcherçš„finished(Dequecalls, T call)æ–¹æ³•ï¼Œï¼š

```javascript
  //ç»“æŸ å¼‚æ­¥è¯·æ±‚
  void finished(AsyncCall call) {
      //callsPerHost-1
    call.callsPerHost().decrementAndGet();
    finished(runningAsyncCalls, call);
  }
  //ç»“æŸ åŒæ­¥è¯·æ±‚
  void finished(RealCall call) {
    finished(runningSyncCalls, call);
  }
  //å¼‚æ­¥ã€åŒæ­¥çš„ç»“æŸï¼Œéƒ½ä¼šèµ°åˆ°è¿™é‡Œï¼šä»runningä¸­ç§»é™¤ å¹¶ è°ƒç”¨promoteAndExecute
  private <T> void finished(Deque<T> calls, T call) {
    ...
    synchronized (this) {
      //ä»é˜Ÿåˆ—ä¸­ç§»é™¤
      if (!calls.remove(call)) throw new AssertionError("Call wasn't in-flight!");
      idleCallback = this.idleCallback;
    }

    boolean isRunning = promoteAndExecute();
    ...
  }
```

ä»é˜Ÿåˆ—ä¸­ç§»é™¤callï¼Œç„¶åæ‰§è¡Œäº† promoteAndExecute()ï¼Œè¿™é‡Œå…ˆä¸è·Ÿè¿›å»äº†åé¢ä¼šè®²åˆ°ã€‚

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çŸ¥é“äº†ï¼Œ**åŒæ­¥è¯·æ±‚èµ°çš„æ˜¯getResponseWithInterceptorChain()æ–¹æ³•**ï¼›

æˆ‘ä»¬å†æ¥çœ‹ **å¼‚æ­¥è¯·æ±‚**ï¼Œå³RealCallçš„enqueueæ–¹æ³•ï¼š

```javascript
  public void enqueue(Callback responseCallback) {
    synchronized (this) {
      if (executed) throw new IllegalStateException("Already Executed");
      executed = true;
    }
    transmitter.callStart();//å›è°ƒè¯·æ±‚ç›‘å¬å™¨çš„è¯·æ±‚å¼€å§‹
    client.dispatcher().enqueue(new AsyncCall(responseCallback));//è¯·æ±‚è°ƒåº¦
  }
```

åŒæ ·å…ˆåˆ¤æ–­æ˜¯å¦å·²è¯·æ±‚è¿‡ï¼Œå›è°ƒè¯·æ±‚å¼€å§‹ã€‚ç„¶åè°ƒç”¨Dispatcherçš„enqueueæ–¹æ³•ï¼Œå‚æ•°æ¥å—çš„æ˜¯AsyncCallï¼ŒAsyncCallç»§æ‰¿NamedRunnableï¼ŒNamedRunnableå®ç°è‡ªRunnableï¼Œå³AsyncCallå°±æ˜¯ä¸ªRunnableï¼Œå¯ä»¥æƒ³åˆ°å®ƒæ˜¯ä¼šåœ¨çº¿ç¨‹æˆ–çº¿ç¨‹æ± æ‰§è¡Œrunæ–¹æ³•çš„ã€‚runæ–¹æ³•åœ¨AsyncCallæ²¡çœ‹åˆ°å•Šï¼Œå®é™…æ˜¯åœ¨åœ¨NamedRunnableä¸­ï¼š

```javascript
//çŸ¥é“å½“å‰çº¿ç¨‹åå­—çš„Runnable
public abstract class NamedRunnable implements Runnable {
  protected final String name;

  public NamedRunnable(String format, Object... args) {
    this.name = Util.format(format, args);
  }

  public final void run() {
    String oldName = Thread.currentThread().getName();
    Thread.currentThread().setName(name);
    try {
      execute();
    } finally {
      Thread.currentThread().setName(oldName);
    }
  }

  protected abstract void execute();
}
```

**runè°ƒç”¨ æŠ½è±¡æ–¹æ³•execute()**ï¼Œexecute()åœ¨AsyncCallæ˜¯æœ‰å®ç°çš„ï¼Œè¿™é‡Œå…ˆä¸çœ‹ã€‚

æˆ‘ä»¬ç»§ç»­å»çœ‹Dispatcherçš„enqueueæ–¹æ³•ï¼š

```javascript
  void enqueue(AsyncCall call) {
    synchronized (this) {
      //å­˜å…¥ç­‰å¾…æ‰§è¡Œçš„é˜Ÿåˆ—
      readyAsyncCalls.add(call);

      // ç›¸åŒhostçš„è¯·æ±‚ï¼Œå…±ç”¨ä¸€ä¸ª è°ƒç”¨è®¡æ•°
      if (!call.get().forWebSocket) {
        AsyncCall existingCall = findExistingCallWithHost(call.host());
        if (existingCall != null) call.reuseCallsPerHostFrom(existingCall);
      }
    }
    promoteAndExecute();
  }

  //ä» runningAsyncCallsæˆ–è€…readyAsyncCallsä¸­æ‰¾åˆ°ç›¸åŒhostçš„è¯·æ±‚
  private AsyncCall findExistingCallWithHost(String host) {
    for (AsyncCall existingCall : runningAsyncCalls) {
      if (existingCall.host().equals(host)) return existingCall;
    }
    for (AsyncCall existingCall : readyAsyncCalls) {
      if (existingCall.host().equals(host)) return existingCall;
    }
    return null;
  }
```

å…ˆæŠŠè¯·æ±‚æ”¾å…¥åŒç«¯é˜Ÿåˆ—readyAsyncCallsä¸­ï¼Œè¡¨ç¤ºç­‰å¾…æ‰§è¡Œçš„å¼‚æ­¥è¯·æ±‚ã€‚ä¸ºå•¥æ˜¯ç­‰å¾…æ‰§è¡Œå‘¢ï¼Ÿå…ˆç•™ä¸€ä¸ªç–‘é—®ã€‚ æ¥ç€ä» æ­£åœ¨æ‰§è¡Œçš„è¯·æ±‚runningAsyncCalls æˆ– ç­‰å¾…æ‰§è¡Œçš„è¯·æ±‚readyAsyncCalls ä¸­æ‰¾åˆ°æ˜¯ç›¸åŒhostçš„è¯·æ±‚ï¼ŒæŠŠcallsPerHosté‡ç”¨ç»™å½“å‰è¯·æ±‚ã€‚callsPerHostçœ‹åå­—æ„Ÿè§‰åƒæ˜¯ æ‹¥æœ‰ç›¸åŒhostçš„è¯·æ±‚çš„æ•°é‡ï¼Œå¹¶ä¸”æ³¨æ„åˆ°ç±»å‹æ˜¯AtomicIntegerï¼Œå£°æ˜å¦‚ä¸‹ï¼š

```javascript
    private volatile AtomicInteger callsPerHost = new AtomicInteger(0);
```

æ‰€ä»¥ï¼Œç›¸åŒhostçš„è¯·æ±‚æ˜¯å…±äº«callsPerHostçš„ï¼Œä¸ºäº†åé¢åˆ¤æ–­hostå¹¶å‘åšå‡†å¤‡ã€‚

ç»§ç»­çœ‹ï¼Œæ¥ç€è°ƒç”¨äº†**promoteAndExecute()**ï¼Œå‰é¢çœ‹çš„finishæ–¹æ³•ä¹Ÿæœ‰è°ƒç”¨ï¼Œè¿™é‡Œå¯ä»¥è·Ÿè¿›çœ‹çœ‹äº†ï¼š

```javascript
  //è°ƒåº¦çš„æ ¸å¿ƒæ–¹æ³•ï¼šåœ¨ æ§åˆ¶å¼‚æ­¥å¹¶å‘ çš„ç­–ç•¥åŸºç¡€ä¸Šï¼Œä½¿ç”¨çº¿ç¨‹æ±  æ‰§è¡Œå¼‚æ­¥è¯·æ±‚
  private boolean promoteAndExecute() {
    assert (!Thread.holdsLock(this));

    List<AsyncCall> executableCalls = new ArrayList<>();
    boolean isRunning;
    synchronized (this) {
      for (Iterator<AsyncCall> i = readyAsyncCalls.iterator(); i.hasNext(); ) {
        AsyncCall asyncCall = i.next();

        if (runningAsyncCalls.size() >= maxRequests) break; //æœ€å¤§å¹¶å‘æ•°64
        if (asyncCall.callsPerHost().get() >= maxRequestsPerHost) continue; //Hostæœ€å¤§å¹¶å‘æ•°5

        i.remove();//ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤
        asyncCall.callsPerHost().incrementAndGet();//Hostå¹¶å‘æ•°+1
        executableCalls.add(asyncCall);//åŠ å…¥ å¯æ‰§è¡Œè¯·æ±‚ çš„é›†åˆ
        runningAsyncCalls.add(asyncCall);//åŠ å…¥ æ­£åœ¨æ‰§è¡Œçš„å¼‚æ­¥è¯·æ±‚é˜Ÿåˆ—
      }
      isRunning = runningCallsCount() > 0;//æ­£åœ¨æ‰§è¡Œçš„å¼‚æ­¥/åŒæ­¥ è¯·æ±‚æ•° >0
    }

    for (int i = 0, size = executableCalls.size(); i < size; i++) {
      AsyncCall asyncCall = executableCalls.get(i);
      asyncCall.executeOn(executorService());//å¯æ‰§è¡Œçš„è¯·æ±‚
    }

    return isRunning;
  }

  public synchronized int runningCallsCount() {
    return runningAsyncCalls.size() + runningSyncCalls.size();
  }
```

éå†readyAsyncCallsï¼Œå…ˆè¿›è¡Œä¸¤ä¸ªæ£€æŸ¥ï¼šæ­£åœ¨æ‰§è¡Œçš„**å¼‚æ­¥è¯·æ±‚**runningAsyncCallsæ•°é‡å¤§äº**æœ€å¤§å¹¶å‘è¯·æ±‚æ•°64å°±**breakï¼Œæˆ–è€… ç›¸åŒhostè¯·æ±‚çš„æ•°é‡å¤§äº5ï¼Œå°±continueã€‚å¦‚æœæ£€æŸ¥éƒ½é€šè¿‡ï¼Œå°±ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤ï¼ŒcallsPerHostè‡ªå¢1ï¼Œæ”¾å…¥ å¯æ‰§è¡Œçš„é›†åˆexecutableCallsï¼Œå¹¶æ·»åŠ åˆ°é˜Ÿåˆ—runningAsyncCallsä¸­ï¼Œè¡¨ç¤ºæ­£åœ¨æ‰§è¡Œçš„å¼‚æ­¥è¯·æ±‚ã€‚ è¿™é‡Œå°±è§£é‡Šäº† å¼‚æ­¥è¯·æ±‚ç­‰å¾…é˜Ÿåˆ—çš„æ„ä¹‰äº†ï¼Œå°±æ˜¯ä¸ºäº†æ§åˆ¶æœ€å¤§å¹¶å‘æ•°çš„ç¼“å†²ï¼šå¼‚æ­¥è¯·æ±‚å¹¶å‘æ•°è¾¾åˆ°64ã€ç›¸åŒhostçš„å¼‚æ­¥è¯·æ±‚è¾¾åˆ°5ï¼Œéƒ½è¦æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ã€‚

éå†å®Œå æŠŠexecutableCallsä¸­çš„è¯·æ±‚éƒ½èµ°executeOnæ–¹æ³•ï¼š

```javascript
    void executeOn(ExecutorService executorService) {
      assert (!Thread.holdsLock(client.dispatcher()));
      boolean success = false;
      try {
        executorService.execute(this);//åœ¨çº¿ç¨‹æ± æ‰§è¡ŒasyncCall
        success = true;
      } catch (RejectedExecutionException e) {
        ...
        transmitter.noMoreExchanges(ioException);
        responseCallback.onFailure(RealCall.this, ioException);//å›è°ƒå¤±è´¥
      } finally {
        if (!success) {
          client.dispatcher().finished(this); //æ‰§è¡Œå‘ç”Ÿå¼‚å¸¸ï¼Œç»“æŸ
        }
      }
    }

  //çº¿ç¨‹æ± çš„å®šä¹‰
  public synchronized ExecutorService executorService() {
    if (executorService == null) {
      executorService = new ThreadPoolExecutor(0, Integer.MAX_VALUE, 60, TimeUnit.SECONDS,
          new SynchronousQueue<>(), Util.threadFactory("OkHttp Dispatcher", false));
    }
    return executorService;
  }
```

executeOnæ–¹æ³•å¾ˆç®€å•ï¼šä½¿ç”¨ç±»ä¼¼CachedThreadPoolçš„**çº¿ç¨‹æ± ** æ‰§è¡Œè¯·æ±‚RealCallã€‚å¦‚æœæ‰§è¡Œå¤±è´¥ï¼Œä¹Ÿä¼šè°ƒç”¨dispatcherçš„finished(Dequecalls, T call)æ–¹æ³•ã€‚

å‰é¢åˆ†æè¿‡ï¼ŒAsyncCallçš„runæ–¹æ³•ä¼šèµ°åˆ°execute()æ–¹æ³•ï¼Œæ¥çœ‹ä¸‹ï¼š

```javascript
    protected void execute() {
      boolean signalledCallback = false;
      transmitter.timeoutEnter();//è¶…æ—¶è®¡æ—¶å¼€å§‹
      try {
        Response response = getResponseWithInterceptorChain();////æ‰§è¡Œè¯·æ±‚è·å–ç»“æœ
        responseCallback.onResponse(RealCall.this, response);//å›è°ƒç»“æœ
      } catch (IOException e) {
        ...
        responseCallback.onFailure(RealCall.this, canceledException);//å›è°ƒå¤±è´¥
        ...
      } finally {
        client.dispatcher().finished(this);//è¯·æ±‚ç»“æŸ
      }
    }
```

æˆ‘ä»¬å‘ç°ï¼Œè¿™é‡Œå’Œ åŒæ­¥è¯·æ±‚ å°±å¾ˆåƒäº†ï¼ŒåŒæ ·æ˜¯è°ƒç”¨getResponseWithInterceptorChain()æ–¹æ³•æ¥è·å–ç»“æœResponseï¼Œä¸åŒç‚¹æ˜¯ä½¿ç”¨responseCallbackæŠŠç»“æœå›è°ƒå‡ºå»ï¼Œæœ€åè¯·æ±‚ç»“æŸä¹Ÿæ˜¯è°ƒç”¨äº†dispatcherçš„finishæ–¹æ³•ã€‚

å¦å¤–ï¼Œå‰é¢è¯´è¿‡ï¼Œfinishæ–¹æ³•ä¸­ä¹Ÿè°ƒç”¨äº†promoteAndExecute()æ–¹æ³•ï¼Œè¯´æ˜ åŒæ­¥/å¼‚æ­¥ è¯·æ±‚ ç»“æŸå ä¹Ÿä¼šé‡æ–°è°ƒåº¦å½“å‰çš„å¼‚æ­¥è¯·æ±‚ã€‚

å¥½äº†ï¼Œåˆ°è¿™é‡Œæˆ‘ä»¬æŠŠ **è°ƒåº¦æµç¨‹** æ¢³ç†ä¸‹ï¼š

1. å‘èµ· åŒæ­¥ è¯·æ±‚åï¼ŒRealCallä½¿ç”¨Dispatcherå­˜å…¥runningSyncCallsï¼Œç„¶åä½¿ç”¨getResponseWithInterceptorChain()è·å–ç»“æœï¼Œæœ€åè°ƒç”¨Dispatcherçš„finishæ–¹æ³•ç»“æŸè¯·æ±‚ã€‚
2. å‘èµ· å¼‚æ­¥ è¯·æ±‚åï¼ŒRealCallä½¿ç”¨Dispatcherå­˜å…¥readyAsyncCallsï¼Œè·å¾—hostå¹¶å‘æ•°ï¼Œä½¿ç”¨promoteAndExecute()æ–¹æ³• åœ¨ æ§åˆ¶å¼‚æ­¥å¹¶å‘ çš„ç­–ç•¥åŸºç¡€ä¸Šï¼Œä½¿ç”¨ çº¿ç¨‹æ±  æ‰§è¡Œå¼‚æ­¥è¯·æ±‚ï¼ˆå¹¶å‘æ§åˆ¶æœ‰åŒ…æ‹¬ æœ€å¤§å¹¶å‘æ•°64ã€hostæœ€å¤§å¹¶å‘æ•°5ï¼‰ã€‚å¼‚æ­¥è¯·æ±‚çš„æ‰§è¡Œ ä¹Ÿæ˜¯ä½¿ç”¨getResponseWithInterceptorChain()ï¼Œè·å¾—ç»“æœåå›è°ƒå‡ºå»ã€‚æœ€åè°ƒç”¨Dispatcherçš„finishæ–¹æ³•ç»“æŸè¯·æ±‚ã€‚
3. **Dispatcher**ï¼šè°ƒåº¦å™¨ï¼Œä¸»è¦æ˜¯å¼‚æ­¥è¯·æ±‚çš„å¹¶å‘æ§åˆ¶ã€æŠŠå¼‚æ­¥è¯·æ±‚æ”¾å…¥çº¿ç¨‹æ± æ‰§è¡Œï¼Œå®ç°æ–¹æ³•æ˜¯promoteAndExecute()ã€‚promoteAndExecute()æœ‰ä¸¤å¤„è°ƒç”¨ï¼šæ·»åŠ å¼‚æ­¥è¯·æ±‚æ—¶ã€åŒæ­¥/å¼‚æ­¥è¯·æ±‚ ç»“æŸæ—¶ã€‚

## è¯·æ±‚çš„æ‰§è¡Œ

é‡ç‚¹æ¥å•¦ï¼

é€šè¿‡ä¸Šé¢åˆ†ææŒ‡å¯¼ï¼Œæ— è®ºåŒæ­¥è¿˜æ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œæœ€ç»ˆçš„æ‰§è¡Œéƒ½æ˜¯åœ¨RealCallçš„getResponseWithInterceptorChain()æ–¹æ³•ï¼Œåªä¸è¿‡å¼‚æ­¥è¯·æ±‚ éœ€è¦å…ˆé€šè¿‡Dispatcherè¿›è¡Œå¹¶å‘æ§åˆ¶å’Œçº¿ç¨‹æ± å¤„ç†ã€‚é‚£ä¹ˆå°±æ¥çœ‹çœ‹getResponseWithInterceptorChain()ï¼š

```javascript
  Response getResponseWithInterceptorChain() throws IOException {
    List<Interceptor> interceptors = new ArrayList<>();
    interceptors.addAll(client.interceptors());         //ä½¿ç”¨è€…é…ç½®çš„ åº”ç”¨æ‹¦æˆªå™¨ï¼Œæœ€å…ˆæ‹¦æˆª
    interceptors.add(new RetryAndFollowUpInterceptor(client));//é‡è¯•è·Ÿè¿›æ‹¦æˆªå™¨
    interceptors.add(new BridgeInterceptor(client.cookieJar()));//æ¡¥æ‹¦æˆªå™¨
    interceptors.add(new CacheInterceptor(client.internalCache()));//ç¼“å­˜æ‹¦æˆªå™¨
    interceptors.add(new ConnectInterceptor(client));     //è¿æ¥æ‹¦æˆªå™¨
    if (!forWebSocket) {
      interceptors.addAll(client.networkInterceptors()); //ä½¿ç”¨è€…é…ç½®çš„ç½‘ç»œæ‹¦æˆªå™¨
    }
    interceptors.add(new CallServerInterceptor(forWebSocket)); //è¯·æ±‚æœåŠ¡æ‹¦æˆªå™¨
    //æ‹¦æˆªå™¨é“¾
    Interceptor.Chain chain = new RealInterceptorChain(interceptors, transmitter, null, 0,
        originalRequest, this, client.connectTimeoutMillis(),
        client.readTimeoutMillis(), client.writeTimeoutMillis());

    boolean calledNoMoreExchanges = false;
    try {
      Response response = chain.proceed(originalRequest);//é“¾ å¼€å§‹æ‰§è¡Œ
      if (transmitter.isCanceled()) {
        closeQuietly(response);
        throw new IOException("Canceled");
      }
      return response;
    } catch (IOException e) {
      calledNoMoreExchanges = true;
      throw transmitter.noMoreExchanges(e);
    } finally {
      if (!calledNoMoreExchanges) {
        transmitter.noMoreExchanges(null);
      }
    }
  }
```

é¦–å…ˆæ˜¯ æŠŠ

- åº”ç”¨æ‹¦æˆªå™¨ï¼ˆå¤–éƒ¨é…ç½®ï¼‰client.interceptors()ã€
- é‡è¯•è·Ÿè¿›æ‹¦æˆªå™¨RetryAndFollowUpInterceptorã€
- æ¡¥æ‹¦æˆªå™¨BridgeInterceptorã€
- ç¼“å­˜æ‹¦æˆªå™¨CacheInterceptorã€
- è¿æ¥æ‹¦æˆªå™¨ConnectInterceptorã€
- ç½‘ç»œæ‹¦æˆªå™¨ï¼ˆå¤–éƒ¨é…ç½®ï¼‰client.networkInterceptors()ã€
- è¯·æ±‚æœåŠ¡æ‹¦æˆªå™¨CallServerInterceptorï¼Œ

**ä¾æ¬¡** æ·»åŠ åˆ°é›†åˆinterceptorsä¸­ã€‚ç„¶åä½¿ç”¨interceptorsã€transmitterã€originalRequestç­‰åˆ›å»ºäº†æ‹¦æˆªå™¨é“¾RealInterceptorChainå®ä¾‹ï¼Œæœ€åç”¨proceedæ–¹æ³•è·å–åˆ°è¯·æ±‚çš„ç»“æœResponseã€‚

åœ¨ä¸Šä¸€ç¯‡ ä½¿ç”¨æ–¹æ³•ä¸­æœ‰æåˆ°æ‹¦æˆªå™¨Interceptorï¼Œé‚£é‡Œé…ç½®çš„æ‹¦æˆªå™¨ å®é™…å°±æ˜¯ åº”ç”¨æ‹¦æˆªå™¨ï¼šclient.interceptors()ï¼Œæ˜¯æœ€æ—©è¢«æ·»åŠ åˆ°interceptorsä¸­ã€‚é‚£ä¹ˆåˆ°åº• æ‹¦æˆªå™¨æ˜¯ä¸ªå•¥å‘¢ï¼Ÿchain.proceedæ˜¯å¦‚ä½•è·å–åˆ°ç»“æœçš„å‘¢ï¼Ÿä¸ç€æ€¥ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹Interceptorç±»ï¼š

```javascript
//æ‹¦æˆªå™¨
public interface Interceptor {

  Response intercept(Chain chain) throws IOException;

  //æ‹¦æˆªå™¨é“¾
  interface Chain {

    Request request();

    //Chainçš„æ ¸å¿ƒæ–¹æ³•
    Response proceed(Request request) throws IOException;

    //è¿”å›è¯·æ±‚æ‰§è¡Œçš„ è¿æ¥. ä»…ç½‘ç»œæ‹¦æˆªå™¨å¯ç”¨; åº”ç”¨æ‹¦æˆªå™¨å°±æ˜¯null.
    @Nullable Connection connection();

    Call call();

    int connectTimeoutMillis();

    Chain withConnectTimeout(int timeout, TimeUnit unit);

    int readTimeoutMillis();

    Chain withReadTimeout(int timeout, TimeUnit unit);

    int writeTimeoutMillis();

    Chain withWriteTimeout(int timeout, TimeUnit unit);
  }
}
```

Interceptoræ˜¯ä¸ªæ¥å£ç±»ï¼Œåªæœ‰ä¸€ä¸ªinterceptæ–¹æ³•ï¼Œå‚æ•°æ˜¯Chainå¯¹è±¡ã€‚å†æ³¨æ„åˆ° å†…éƒ¨æ¥å£ç±»Chain -- æ‹¦æˆªå™¨é“¾ï¼Œæœ‰ä¸ªproceedæ–¹æ³•ï¼Œå‚æ•°æ˜¯Requestå¯¹è±¡ï¼Œè¿”å›å€¼æ˜¯Responseï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•çš„å®ç°å°±æ˜¯è¯·æ±‚çš„å¤„ç†è¿‡ç¨‹äº†ã€‚Chainçš„å”¯ä¸€å®ç°ç±»å°±æ˜¯RealInterceptorChainï¼Œè´Ÿè´£æŠŠæ‰€æœ‰æ‹¦æˆªå™¨ä¸²è”èµ·æ¥ï¼Œproceedæ–¹æ³•å°±æ˜¯ä¸²è”çš„æ“ä½œã€‚

ä¸Šè¿°ä¸€ç³»åˆ—çš„æ‹¦æˆªå™¨éƒ½æ˜¯Interceptorçš„å®ç°ç±»ï¼Œè¿™é‡Œå…ˆè´´å‡ºä¸Šä¸€ç¯‡ä¸­å®ç°çš„åº”ç”¨æ‹¦æˆªå™¨ï¼ˆå…¶ä»–æ‹¦æˆªå™¨çš„å®ç°æš‚ä¸å»è·Ÿè¿›ï¼‰ï¼š

```javascript
        new Interceptor() {
            @Override
            public Response intercept(Chain chain) throws IOException {
                Request request = chain.request();
                String url = request.url().toString();
                Log.i(TAG, "intercept: proceed start: url"+ url+ ", at "+System.currentTimeMillis());

                Response response = chain.proceed(request);

                ResponseBody body = response.body();
                Log.i(TAG, "intercept: proceed end: url"+ url+ ", at "+System.currentTimeMillis());
                return response;
            }
        }
```

åœ¨interceptæ–¹æ³•ä¸­æˆ‘ä»¬è°ƒç”¨chain.proceedæ–¹æ³•è·å–äº†ç»“æœ å¹¶åœ¨å‰åæ‰“å°äº†ä¸€äº›æ—¥å¿—ï¼Œé‚£è¿™ä¸ªChainå®ä¾‹æ˜¯å“ªæ¥çš„å‘¢ï¼Ÿinterceptæ–¹æ³•å•¥æ—¶å€™è¢«è°ƒç”¨çš„å‘¢ï¼Ÿâ€” â€” æˆ‘ä»¬å†å›å¤´çœ‹getResponseWithInterceptorChainæ–¹æ³•ï¼Œæ‰€æœ‰æ‹¦æˆªå™¨éƒ½è¢«ä¼ å…¥RealInterceptorChainï¼Œå¯ä»¥çŒœæƒ³åˆ°ï¼Œå¿…å®šæ˜¯RealInterceptorChainçš„proceedæ–¹æ³•å†…éƒ¨è°ƒç”¨äº†æ‹¦æˆªå™¨çš„interceptæ–¹æ³•ã€‚é‚£ä¹ˆå°±æ¥çœ‹çœ‹å§ï¼š

```javascript
  @Override public Response proceed(Request request) throws IOException {
    return proceed(request, transmitter, exchange);
  }

  public Response proceed(Request request, Transmitter transmitter, @Nullable Exchange exchange)
      throws IOException {
    if (index >= interceptors.size()) throw new AssertionError();

    calls++;

    // If we already have a stream, confirm that the incoming request will use it.
    if (this.exchange != null && !this.exchange.connection().supportsUrl(request.url())) {
      throw new IllegalStateException("network interceptor " + interceptors.get(index - 1)
          + " must retain the same host and port");
    }

    // If we already have a stream, confirm that this is the only call to chain.proceed().
    if (this.exchange != null && calls > 1) {
      throw new IllegalStateException("network interceptor " + interceptors.get(index - 1)
          + " must call proceed() exactly once");
    }

    // Call the next interceptor in the chain.
    RealInterceptorChain next = new RealInterceptorChain(interceptors, transmitter, exchange,
        index + 1, request, call, connectTimeout, readTimeout, writeTimeout);
    Interceptor interceptor = interceptors.get(index);
    Response response = interceptor.intercept(next);

    // Confirm that the next interceptor made its required call to chain.proceed().
    if (exchange != null && index + 1 < interceptors.size() && next.calls != 1) {
      throw new IllegalStateException("network interceptor " + interceptor
          + " must call proceed() exactly once");
    }

    // Confirm that the intercepted response isn't null.
    if (response == null) {
      throw new NullPointerException("interceptor " + interceptor + " returned null");
    }

    if (response.body() == null) {
      throw new IllegalStateException(
          "interceptor " + interceptor + " returned a response with no body");
    }

    return response;
  }
```

åœ¨å®ä¾‹åŒ–RealInterceptorChainæ—¶ indexèµ‹å€¼æ˜¯0ï¼Œexchangeæ˜¯nullï¼Œæ‰€ä»¥å‰é¢ä¸‰ä¸ªiféƒ½æ²¡èµ°è¿›å»ã€‚ç„¶åè·å–äº†ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬é…ç½®çš„åº”ç”¨æ‹¦æˆªå™¨ï¼Œè°ƒç”¨äº†å®ƒçš„interceptoræ–¹æ³•ï¼Œå¹¶è¿”å›å’Œæ ¡éªŒäº†ç»“æœã€‚è¿™é‡Œè¯å®äº†æˆ‘ä»¬çŒœæƒ³ã€‚åŒæ—¶æ³¨æ„åˆ°ï¼Œè°ƒç”¨ åº”ç”¨æ‹¦æˆªå™¨çš„interceptoræ–¹æ³•ä¼ å…¥çš„å‚æ•°ï¼šæ‹¦æˆªå™¨é“¾å®ä¾‹nextï¼Œnextå°±æ˜¯æŠŠindex + 1è€Œå·²ï¼Œå…¶ä»–å‚æ•°å’Œå½“å‰å®ä¾‹æ˜¯ä¸€æ ·çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ åœ¨æˆ‘ä»¬çš„åº”ç”¨æ‹¦æˆªå™¨ä¸­è°ƒç”¨çš„æ˜¯ nextçš„proceedæ–¹æ³•ã€‚

è¿›ä¸€æ­¥ï¼Œnextçš„proceedæ–¹æ³•ä¸­ åŒæ ·ä¼šè·å–interceptorsçš„index=1çš„æ‹¦æˆªå™¨ï¼Œå³RetryAndFollowUpInterceptorå®ä¾‹ï¼Œç„¶åè°ƒç”¨å…¶interceptoræ–¹æ³•ï¼Œå‚æ•°æ˜¯index+1å³index=2çš„chainã€‚è·Ÿè¿›RetryAndFollowUpInterceptorçš„ä»£ç å‘ç°ï¼Œinterceptoræ–¹æ³•å†…éƒ¨ä¹Ÿæ˜¯æœ‰è°ƒç”¨chainçš„proceedæ–¹æ³•ã€‚è¿™æ ·å°±ä¼šä¾æ¬¡ä¼ é€’ä¸‹å»ï¼Œç›´åˆ°æœ€åä¸€ä¸ªæ‹¦æˆªå™¨CallServerInterceptorã€‚

å®é™…ä¸Š **é™¤äº†æœ€åä¸€ä¸ªæ‹¦æˆªå™¨CallServerInterceptorä¹‹å¤–ï¼Œæ‰€æœ‰æ‹¦æˆªå™¨çš„interceptoræ–¹æ³•éƒ½è°ƒç”¨äº† ä¼ å…¥ chainçš„proceedæ–¹æ³•**ã€‚æ¯ä¸ªæ‹¦æˆªå™¨åœ¨chainçš„proceedæ–¹æ³• å‰å å¤„ç†äº†è‡ªå·±è´Ÿè´£çš„å·¥ä½œã€‚ä¾‹å¦‚æˆ‘ä»¬çš„åº”ç”¨æ‹¦æˆªå™¨ï¼Œåœ¨chainçš„proceedæ–¹æ³•å‰ æ‰“å°äº†requestä¿¡æ¯çš„æ—¥å¿—ï¼Œchainçš„proceedæ–¹æ³•è·å–ç»“æœ ä¹‹å æ‰“å°äº†responseä¿¡æ¯çš„æ—¥å¿—ã€‚æ¯ä¸ªæ‹¦æˆªå™¨interceptoræ–¹æ³•åœ¨ è°ƒç”¨chainçš„proceedæ–¹æ³•æ—¶ éƒ½æ˜¯ä¸ºäº†è·å–ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨å¤„ç†çš„responseï¼Œç„¶åè¿”å›ç»™ä¸Šä¸€ä¸ªæ‹¦æˆªå™¨ã€‚

é€»è¾‘æ€»ç»“å¦‚ä¸‹å›¾ï¼š

![qxdq9nngfa](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-befo/20210612173843.png)

åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°

è¿™å°±æ˜¯ okhttpæ‰§è¡Œæµç¨‹çš„æ ¸å¿ƒäº†ï¼Œæ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š 

![hjbuptum2s](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-befo/20210612173901.png)

åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿° ç°åœ¨æ¥æ€»ç»“ä¸‹ï¼š

1. æ‹¦æˆªå™¨é“¾ï¼šæŠŠåŸå§‹è¯·æ±‚ request **ä¾æ¬¡** ä¼ å…¥åˆ° æ¯ä¸ªæ‹¦æˆªå™¨ã€‚æ‹¦æˆªå™¨ å¤„ç†å æŠŠresponse **åå‘** ä¾æ¬¡ å›ä¼ ã€‚
2. æ‹¦æˆªå™¨ï¼šå¯ä»¥å¯¹requestè¿›è¡Œå¤„ç†ï¼Œç„¶åè°ƒç”¨index+1çš„æ‹¦æˆªå™¨é“¾proceedæ–¹æ³• è·å–ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨å¤„ç†çš„ç»“æœï¼Œæ¥ç€è‡ªå·±ä¹Ÿå¯ä»¥å¤„ç†è¿™ä¸ªç»“æœï¼Œå³ï¼šå¤„ç†requestã€chain.proceedã€å¤„ç†responseã€‚

ä¸çŸ¥ä½ æœ‰æ²¡æœ‰å‘ç°ï¼Œè¿™ä¸€è¿‡ç¨‹ å’Œ å…¬å¸å·¥ä½œç”Ÿäº§æµç¨‹ å¾ˆåƒï¼š

1. è€æ¿æ¥åˆ°ä¸€ç¬”è®¢å•ï¼Œè¦æ±‚10å¤©å†…ç”Ÿäº§100å°ç”µè„‘ã€‚
2. æ€»ç»ç†æ‹¿åˆ°ä»»åŠ¡åï¼Œä¿®æ”¹äº†ä»»åŠ¡å’Œæ—¶é—´ï¼š8å¤©å†…ç”Ÿäº§110å°ï¼Œè¿™æ˜¯åŸºäº ç”Ÿäº§åˆæ ¼ç‡ ä»¥åŠè¿›è¡Œé‡å·¥ã€æ£€éªŒã€åŒ…è£…ã€è¿è¾“çš„æ—¶é—´ä¸Šçš„è€ƒé‡ï¼Œæ—¢è¦ä¿è´¨ä¿é‡ï¼Œä¹Ÿè¦æŒ‰æ—¶äº¤è´§ã€‚
3. ä»»åŠ¡æ¥ç€åˆ°äº†éƒ¨é—¨ç»ç†ï¼Œéƒ¨é—¨ç»ç†å…ˆå»ç¡®è®¤äº†ä»“åº“ä¸­æ˜¯å¦æœ‰è¶³å¤Ÿå­˜è´§ï¼Œå¦‚æœæœ‰å°±ç›´æ¥ä½¿ç”¨å­˜è´§æ¥äº¤è´§ï¼Œè¿™æ ·ä¸å­˜åœ¨ä»»ä½•äº¤è´§é£é™©ï¼ˆè´¨é‡ã€æ—¶é—´ï¼‰ï¼›å¦‚æœæ²¡æœ‰å­˜è´§ï¼Œé‚£ä¹ˆå°±å»è¦æ±‚ç”Ÿäº§çº¿ç”Ÿäº§ã€‚
4. ç”Ÿäº§çº¿æŒ‰æ—¶æŒ‰é‡ç”Ÿäº§å®Œä»¥åï¼Œä¼šæŠŠç”Ÿäº§æƒ…å†µ ä¸ŠæŠ¥ç»™éƒ¨é—¨ç»ç†ï¼Œéƒ¨é—¨ç»ç†æŠŠç»“æœæ€»ç»“æˆexcelå‘ˆç°ç»™æ€»ç»ç†ï¼Œæ€»ç»ç†åˆ™ä¼šæŠŠæ•´ä¸ªç”Ÿäº§æµç¨‹ç»“æœåŠå„éƒ¨é—¨çš„é…åˆæƒ…å†µï¼Œæ€»ç»“æˆPPTæŠ¥å‘Šç»™è€æ¿ã€‚

è€Œä¸åŒçš„æ‹¦æˆªå™¨ï¼Œåœ¨ç½‘ç»œè¯·æ±‚è¿™ä¸€ä»»åŠ¡ä¸­ï¼Œå°±æ‰®æ¼”ç€ä¸åŒçš„è§’è‰²ã€‚å¯èƒ½okhttpçš„ä½œè€…å†™æ‹¦æˆªå™¨çš„çµæ„Ÿå°±æ¥æºäºç”Ÿæ´»å§ï¼Œå“ˆå“ˆã€‚

| æ‹¦æˆªå™¨                      | ä½œç”¨                                                         |
| :-------------------------- | :----------------------------------------------------------- |
| åº”ç”¨æ‹¦æˆªå™¨                  | å¤„ç†åŸå§‹è¯·æ±‚å’Œæœ€ç»ˆçš„å“åº”ï¼šå¯ä»¥æ·»åŠ è‡ªå®šä¹‰headerã€é€šç”¨å‚æ•°ã€å‚æ•°åŠ å¯†ã€ç½‘å…³æ¥å…¥ç­‰ç­‰ã€‚ |
| RetryAndFollowUpInterceptor | å¤„ç†é”™è¯¯é‡è¯•å’Œé‡å®šå‘                                         |
| BridgeInterceptor           | åº”ç”¨å±‚å’Œç½‘ç»œå±‚çš„æ¡¥æ¥æ‹¦æˆªå™¨ï¼Œä¸»è¦å·¥ä½œæ˜¯ä¸ºè¯·æ±‚æ·»åŠ cookieã€æ·»åŠ å›ºå®šçš„headerï¼Œæ¯”å¦‚Hostã€Content-Lengthã€Content-Typeã€User-Agentç­‰ç­‰ï¼Œç„¶åä¿å­˜å“åº”ç»“æœçš„cookieï¼Œå¦‚æœå“åº”ä½¿ç”¨gzipå‹ç¼©è¿‡ï¼Œåˆ™è¿˜éœ€è¦è¿›è¡Œè§£å‹ã€‚ |
| CacheInterceptor            | ç¼“å­˜æ‹¦æˆªå™¨ï¼Œè·å–ç¼“å­˜ã€æ›´æ–°ç¼“å­˜ã€‚å¦‚æœå‘½ä¸­ç¼“å­˜åˆ™ä¸ä¼šå‘èµ·ç½‘ç»œè¯·æ±‚ã€‚ |
| ConnectInterceptor          | è¿æ¥æ‹¦æˆªå™¨ï¼Œå†…éƒ¨ä¼šç»´æŠ¤ä¸€ä¸ªè¿æ¥æ± ï¼Œè´Ÿè´£è¿æ¥å¤ç”¨ã€åˆ›å»ºè¿æ¥ï¼ˆä¸‰æ¬¡æ¡æ‰‹ç­‰ç­‰ï¼‰ã€é‡Šæ”¾è¿æ¥ä»¥åŠåˆ›å»ºè¿æ¥ä¸Šçš„socketæµã€‚ |
| ç½‘ç»œæ‹¦æˆªå™¨                  | ç”¨æˆ·è‡ªå®šä¹‰æ‹¦æˆªå™¨ï¼Œé€šå¸¸ç”¨äºç›‘æ§ç½‘ç»œå±‚çš„æ•°æ®ä¼ è¾“ã€‚             |
| CallServerInterceptor       | è¯·æ±‚æ‹¦æˆªå™¨ï¼Œåœ¨å‰ç½®å‡†å¤‡å·¥ä½œå®Œæˆåï¼ŒçœŸæ­£å‘èµ·ç½‘ç»œè¯·æ±‚ï¼Œè¿›è¡ŒIOè¯»å†™ã€‚ |

è¿™é‡Œå…ˆå¤§æ¦‚çŸ¥é“æ¯ä¸ªæ‹¦æˆªå™¨çš„è§’è‰²ä»»åŠ¡ï¼Œä¸‹ä¸€ç¯‡å°†ä¼šè¯¦ç»†åˆ†ææ¯ä¸ªæ‹¦æˆªå™¨ï¼Œä»¥åŠé‡è¦çŸ¥è¯†ç‚¹--ç¼“å­˜å’Œè¿æ¥æ± ã€‚

é‚£ä¹ˆï¼Œæˆ‘ä»¬å¯¹okhttpæ‰§è¡Œæµç¨‹çš„æºç åˆ†æï¼Œåˆ°è¿™é‡Œä¹Ÿç»“æŸäº†ã€‚

## æ€»ç»“

ç°åœ¨é€šè¿‡ä¸¤ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å·²ç»æŒæ¡äº†okhttpçš„åŸºæœ¬ç”¨æ³•ï¼Œå¹¶ä¸”é€šè¿‡é˜…è¯»æºç äº†è§£äº†okhttpæ€»çš„æ‰§è¡Œæµç¨‹â€”â€”è¯·æ±‚çš„åˆ›å»ºã€è°ƒåº¦ã€æ‹¦æˆªå™¨é“¾å¤„ç†ã€‚æ¥ä¸‹æ¥çš„æ–‡ç« ï¼Œä¼šæ·±å…¥åˆ°æ¯ä¸ªæ‹¦æˆªå™¨çš„å…·ä½“å®ç°ï¼Œå­¦ä¹ okhttpæ›´å¤šçš„é«˜çº§ä½¿ç”¨æŠ€å·§ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹è¯·ç»§ç»­å…³æ³¨ã€‚

--------------

æœ¬æ–‡åˆ†äº«è‡ªå¾®ä¿¡å…¬ä¼—å· - èƒ¡é£æ´‹ï¼ˆhfydwxgzhï¼‰ï¼Œä½œè€…ï¼šèƒ¡é£æ´‹

åŸæ–‡é“¾æ¥ï¼š https://cloud.tencent.com/developer/article/1667339

åŸæ–‡å‡ºå¤„åŠè½¬è½½ä¿¡æ¯è§æ–‡å†…è¯¦ç»†è¯´æ˜ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³» yunjia_community@tencent.com åˆ é™¤ã€‚

åŸå§‹å‘è¡¨æ—¶é—´ï¼š2020-05-18