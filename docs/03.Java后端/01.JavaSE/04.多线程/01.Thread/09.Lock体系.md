---
title: Lockä½“ç³»
date: 2021-06-17 18:44:43
permalink: /pages/8b2f18/
categories:
  - Javaåç«¯
  - JavaSE
  - å¤šçº¿ç¨‹
  - Thread
tags:
  - 
---

## 1. Lockä½“ç³»

### Lockæ¥å£

Lock----JDK5 åŸºäºJavaè¯­è¨€å®ç°çš„çº¿ç¨‹é”

**Javaä¸­å®ç°çº¿ç¨‹â€œé”â€çš„æ–¹å¼ï¼š**

- synchronized
- Lock

ä¸‹é¢æ¥çœ‹çœ‹Lockæ¥å£ä¸­å®šä¹‰äº†å“ªäº›æ–¹æ³•

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](8.Lockä½“ç³».assets/20200528172946385.png)

1. `void lock();`    è·å–é”
2. `void lockInterruptibly();`  è·å–é”çš„è¿‡ç¨‹èƒ½å¤Ÿå“åº”ä¸­æ–­
3. ` boolean tryLock();`    éé˜»å¡å¼å“åº”ä¸­æ–­èƒ½ç«‹å³è¿”å›ï¼Œè·å–é”è¿”å›trueåä¹‹ä¸ºfalse
4. ` boolean tryLock(long time,TimeUnit unit);`  è¶…æ—¶è·å–é”ï¼Œåœ¨è¶…æ—¶å†…æˆ–æœªä¸­æ–­çš„æƒ…å†µä¸‹èƒ½è·å–é”
5. `Condition newCondition();`   è·å–ä¸lockç»‘å®šçš„ç­‰å¾…é€šçŸ¥ç»„ä»¶ï¼Œå½“å‰çº¿ç¨‹å¿…é¡»å…ˆè·å¾—äº†é”æ‰èƒ½ç­‰å¾…ï¼Œç­‰å¾…ä¼šé‡Šæ”¾é”ï¼Œå†æ¬¡è·å–åˆ°é”æ‰èƒ½ä»ç­‰å¾…ä¸­è¿”å›

**Lockç±»ç›¸å…³ä»‹ç»**

1. Locké‡è¦çš„å®ç°ç±»ï¼šReentrantLock å’Œ ReentrantReadWriteLockã€‚
2. Lockï¼šå®šä¹‰äº†æ ‡å‡†çš„Lockçš„apiã€‚
3. ReentrantLock ï¼šé‡å…¥é”(å®ç°äº†AQS) æ”¯æŒå…¬å¹³å’Œéå…¬å¹³ã€‚
4. ReentrantReadWriteLockï¼šåŒReentrantLock åœ¨åŸºç¡€ä¸Šæ”¯æŒè¯»å†™åˆ†ç¦»é€‚åˆå¤šè¯»å°‘å†™çš„åœºæ™¯
5. Conditionï¼šæ˜¯éœ€è¦ä¸Locké…åˆä½¿ç”¨çš„ï¼Œæä¾›å¤šä¸ªç­‰å¾…é›†åˆï¼Œæ›´ç²¾ç¡®çš„æ§åˆ¶(åº•å±‚æ˜¯park/unparkæœºåˆ¶)

> **å¯ä¸­æ–­é”**ï¼šåœ¨ç­‰å¾…è·å–é”è¿‡ç¨‹ä¸­å¯ä¸­æ–­ã€‚æ³¨æ„æ˜¯åœ¨ç­‰å¾…é”è¿‡ç¨‹ä¸­æ‰å¯ä»¥ä¸­æ–­ï¼Œå¦‚æœå·²ç»è·å–äº†é”ï¼Œä¸­æ–­å°±æ— æ•ˆã€‚

<br>

## 2. Locké”çš„ä½¿ç”¨

Lockæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå°±ç±»ä¼¼`List`å’Œ`Set`æ¥å£ï¼Œå…·ä½“çš„ä½¿ç”¨è¿˜æ˜¯è°ƒç”¨å…¶å®ç°ç±»**ReentrantLock(é‡å…¥é”)**

**Lockå®ç°ç±»ä»‹ç»**

1. æ‰€çš„å®ç°ç±»ï¼š`AQS`(AbstractQueuedSynchronizer)ã€`ReentrantLock`ã€`ReentrantReadWriteLock`ã€`CountDownLatch`ã€`Semphore`ã€‚
2. å…¶ä»–å¤šçº¿ç¨‹åä½œçš„åœºæ™¯: `CyclicBarrier`

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/20210617213259.png)

```java
package com.iqqcode.lock;

import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

/**
 * @Author: Mr.Q
 * @Date: 2020-05-28 16:55
 * @Description:Locké”
 */
class Sync implements Runnable {

    //å®ç°Lockçš„æ¥å£æ¥å®šä¹‰é”
    private Lock ticketsLock = new ReentrantLock();
    private int tickets = 20;

    @Override
    public void run() {
        while(true) {
            //éœ€è¦å¯¹ç¨‹åºä¸Šé”
            try {
                //ç­‰åŒäºsynchronized(this)
                ticketsLock.lock();
                Thread.sleep(200);
                if(this.tickets >= 0) {
                    System.out.println(Thread.currentThread().getName() +
                            "è¿˜æœ‰" + this.tickets-- + "å¼ ç¥¨");
                }else {
                    break;
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            } finally {
                ticketsLock.unlock();
            }
        }
    }
}

public class LockSync {
    public static void main(String[] args) {
        Sync run = new Sync();
        new Thread(run,"é»„ç‰›A").start();
        new Thread(run,"é»„ç‰›B").start();
        new Thread(run,"é»„ç‰›C").start();
    }
}
```

å¯ä»¥çœ‹å‡º Lock å¯ä»¥å®ç°å’Œ synchronized åŒæ ·çš„åŠŸèƒ½

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/20210617213304.png)

<br>

---------------

## 3. Condition

Conditionï¼šLockä½“ç³»çš„çº¿ç¨‹é€šä¿¡æ–¹å¼ï¼Œç±»æ¯”Objectç±»çš„ waitï¼Œnotifyï¼›å¯ä»¥è¿›ä¸€éƒ¨æé«˜æ•ˆç‡ï¼Œå‡å°‘çº¿ç¨‹é˜»å¡ä¸å”¤é†’å¸¦æ¥çš„å¼€é”€

`await()`:  é‡Šæ”¾Locké”ï¼Œå°†çº¿ç¨‹ç½®å…¥ç­‰å¾…é˜Ÿåˆ—é˜»å¡

`signal()`ï¼š å”¤é†’ä¸€ä¸ªå¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹

`signalAll()`:  å”¤é†’æ‰€æœ‰çº¿ç¨‹

ç±»æ¯” **wait()** å’Œ **notify( ï¼‰**

è·å–ä¸€ä¸ªLocké”çš„Conditioné˜Ÿåˆ—ï¼š

`Lock.newCondition` : æ¯å½“è°ƒç”¨ä¸€æ¬¡ï¼Œå°±äº§ç”Ÿä¸€ä¸ªæ–°çš„Condition

> ä½¿ç”¨è¯¦è§ğŸ‘‰ **ã€Š6.çº¿ç¨‹é—´çš„é€šä¿¡ã€‹**

<br>

## 5. ä½¿ç”¨synchronizedè¿˜æ˜¯Lock

1. Lockæ˜¯æ˜¾ç¤ºé”ï¼Œæ‰‹åŠ¨å…³é—­ï¼Œæ‰‹åŠ¨å¼€å¯ï¼›synchronizedæ˜¯éšå¼é”ï¼Œå‡ºäº†ä½œç”¨åŸŸè‡ªåŠ¨é‡Šæ”¾

2. Lockåªèƒ½ä½œç”¨åŸŸä»£ç å—ï¼Œè€Œsynchronizedå¯ä»¥ä½œç”¨åŸŸä»£ç å—å’Œæ–¹æ³•ä¸Š

3. ä½¿ç”ªLocké”JVMå°†èŠ±è´¹è¾ƒå°‘çš„æ—¶é—´æ¥è°ƒåº¦çº¿ç¨‹ï¼Œæ€§èƒ½æ›´å¥½ï¼Œå¹¶ä¸”å…·æœ‰æ›´å¥½çš„æ‰©å±•æ€§ï¼ˆæä¾›æ›´å¤šçš„å­ç±»ï¼‰

4. è‹¥æ— ç‰¹æ®Šçš„åº”ç”¨åœºæ™¯ï¼Œæ¨èä½¿ç”¨ **synchronized**,å…¶ä½¿ç”¨æ–¹ä¾¿(éšå¼çš„åŠ å‡é”)ï¼Œå¹¶ä¸”ç”±äº synchronizedæ˜¯ JVMå±‚é¢çš„å®ç°ï¼Œåœ¨ä¹‹åçš„ JDKè¿˜æœ‰ä¼˜åŒ–

5. è‹¥è¦ä½¿ç”¨ **å…¬å¹³é”ï¼Œè¯»å†™é”ï¼Œè¶…æ—¶é”**ç­‰ç‰¹æ®Šåœºæ™¯ï¼Œæ‰ä¼šè€ƒè™‘ä½¿ç”¨ Lock

6. Synchronizedæ˜¯å¯é‡å…¥é”ï¼Œä¸å¯ä»¥ä¸­æ–­çš„ï¼Œéå…¬å¹³ï¼›Lockæ˜¯å¯é‡å…¥é”ï¼Œå¯ä»¥åˆ¤æ–­é”ï¼Œéå…¬å¹³ï¼ˆå¯è®¾ç½®ï¼‰